---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all data for client-side comparison
const players = await getCollection('players');
const mice = await getCollection('mice');
const mousepads = await getCollection('mousepads');
const keyboards = await getCollection('keyboards');
const monitors = await getCollection('monitors');
const headsets = await getCollection('headsets');

// Create lookup maps
const miceMap = Object.fromEntries(mice.map(m => [m.id, m.data]));
const mousepadsMap = Object.fromEntries(mousepads.map(m => [m.id, m.data]));
const keyboardsMap = Object.fromEntries(keyboards.map(k => [k.id, k.data]));
const monitorsMap = Object.fromEntries(monitors.map(m => [m.id, m.data]));
const headsetsMap = Object.fromEntries(headsets.map(h => [h.id, h.data]));

// Prepare player data for client
const playersData = Object.fromEntries(
  players.map(p => [p.id, {
    ...p.data,
    id: p.id,
    mouseData: miceMap[p.data.mouse] || null,
    mousepadData: mousepadsMap[p.data.mousepad] || null,
    keyboardData: keyboardsMap[p.data.keyboard] || null,
    monitorData: monitorsMap[p.data.monitor] || null,
    headsetData: headsetsMap[p.data.headset] || null,
  }])
);

const sortedPlayers = players.sort((a, b) => a.data.name.localeCompare(b.data.name));

const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;
---

<BaseLayout title="Compare Players">
  <div class="page-header">
    <h1>Compare Players</h1>
    <p>Select two players to compare their settings side by side</p>
  </div>

  <div class="compare-selectors">
    <div class="selector-group">
      <label for="player1">Player 1</label>
      <select id="player1">
        <option value="">Select a player...</option>
        {sortedPlayers.map(p => (
          <option value={p.id}>{p.data.name}</option>
        ))}
      </select>
    </div>
    <div class="vs-badge">VS</div>
    <div class="selector-group">
      <label for="player2">Player 2</label>
      <select id="player2">
        <option value="">Select a player...</option>
        {sortedPlayers.map(p => (
          <option value={p.id}>{p.data.name}</option>
        ))}
      </select>
    </div>
  </div>

  <div id="comparison-container" class="comparison-container hidden">
    <table class="compare-table">
      <thead>
        <tr>
          <th class="label-header">Setting</th>
          <th id="p1-header" class="player-header">Player 1</th>
          <th id="p2-header" class="player-header">Player 2</th>
        </tr>
      </thead>
      <tbody id="compare-body">
        <!-- Populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <div id="empty-state" class="empty-state">
    <p>Select two players above to compare their settings</p>
  </div>

  <script define:vars={{ playersData, base }}>
    document.addEventListener('DOMContentLoaded', function() {
      const player1Select = document.getElementById('player1');
      const player2Select = document.getElementById('player2');
      const comparisonContainer = document.getElementById('comparison-container');
      const emptyState = document.getElementById('empty-state');
      const compareBody = document.getElementById('compare-body');
      const p1Header = document.getElementById('p1-header');
      const p2Header = document.getElementById('p2-header');

      // Check URL params for pre-selected players
      const urlParams = new URLSearchParams(window.location.search);
      const p1Param = urlParams.get('p1');
      const p2Param = urlParams.get('p2');

      if (p1Param && playersData[p1Param]) {
        player1Select.value = p1Param;
      }
      if (p2Param && playersData[p2Param]) {
        player2Select.value = p2Param;
      }

      function formatValue(val, isNumeric = false, decimals = 0) {
        if (val === null || val === undefined || val === '' || val === 'Unknown') return '';
        if (isNumeric && typeof val === 'number') {
          return decimals > 0 ? val.toFixed(decimals) : val.toString();
        }
        return val;
      }

      function formatRating(num) {
        if (num === null || num === undefined) return '';
        // Remove trailing zeros after decimal (22.00 → 22, 22.50 → 22.5, 25.26 → 25.26)
        return parseFloat(Number(num).toFixed(2)).toString();
      }

      function formatCm360(player) {
        let val;
        if (player.cm360) val = player.cm360;
        else if (player.m_cpi) {
          // When m_cpi is set: cm360 = 360 × m_cpi / (sensitivity × DPI)
          // When m_cpi = DPI, this simplifies to 360 / sensitivity
          val = 360 * player.m_cpi / (player.sensitivity * player.dpi);
        } else {
          val = 41563.6 / (player.dpi * player.sensitivity);
        }
        const fixed = val.toFixed(2);
        return fixed.endsWith('.00') ? Math.round(val).toString() : fixed;
      }

      function formatBind(val) {
        if (!val) return '';
        return String(val).toUpperCase();
      }

      function countryCodeToFlag(code) {
        if (!code || code.length !== 2) return '';
        return code
          .toUpperCase()
          .split('')
          .map(char => String.fromCodePoint(127397 + char.charCodeAt(0)))
          .join('');
      }

      function updateComparison() {
        const p1Id = player1Select.value;
        const p2Id = player2Select.value;

        if (!p1Id || !p2Id) {
          comparisonContainer.classList.add('hidden');
          emptyState.classList.remove('hidden');
          return;
        }

        const p1 = playersData[p1Id];
        const p2 = playersData[p2Id];

        if (!p1 || !p2) return;

        comparisonContainer.classList.remove('hidden');
        emptyState.classList.add('hidden');

        // Update URL
        const newUrl = `${window.location.pathname}?p1=${p1Id}&p2=${p2Id}`;
        window.history.replaceState({}, '', newUrl);

        // Update headers with flag emojis
        const p1Country = p1.country && p1.country !== 'Unknown' ? p1.country : '';
        const p2Country = p2.country && p2.country !== 'Unknown' ? p2.country : '';
        const p1Flag = countryCodeToFlag(p1Country);
        const p2Flag = countryCodeToFlag(p2Country);

        // Debug: log flag conversion (remove after debugging)
        console.log('Flag debug:', {
          p1: { country: p1.country, filtered: p1Country, flag: p1Flag, flagLength: p1Flag.length },
          p2: { country: p2.country, filtered: p2Country, flag: p2Flag, flagLength: p2Flag.length }
        });

        p1Header.innerHTML = `<span class="header-name">${p1.name}</span>${p1Flag ? `<span class="header-country">${p1Flag}</span>` : ''}`;
        p2Header.innerHTML = `<span class="header-name">${p2.name}</span>${p2Flag ? `<span class="header-country">${p2Flag}</span>` : ''}`;

        // Build comparison table
        let html = '';

        // Section: Mouse Settings
        html += sectionHeader('Mouse Settings');
        html += compareRow('DPI', p1.dpi, p2.dpi, true);
        html += compareRow('Sensitivity', p1.sensitivity, p2.sensitivity, true);
        html += compareRow('eDPI', p1.edpi, p2.edpi, true);
        html += compareRow('cm/360', formatCm360(p1), formatCm360(p2), true);
        html += compareRow('Acceleration',
          p1.acceleration ? (p1.accelValue ? String(p1.accelValue) : 'On') : 'Off',
          p2.acceleration ? (p2.accelValue ? String(p2.accelValue) : 'On') : 'Off');

        // Section: Game Settings
        html += sectionHeader('Game Settings');
        html += compareRow('FOV', p1.fov, p2.fov, true);
        html += compareRow('Crosshair', formatValue(p1.crosshair), formatValue(p2.crosshair));

        // Section: Key Bindings
        html += sectionHeader('Key Bindings');
        html += compareRow('Forward', formatBind(p1.forward), formatBind(p2.forward));
        html += compareRow('Back', formatBind(p1.back), formatBind(p2.back));
        html += compareRow('Left', formatBind(p1.left), formatBind(p2.left));
        html += compareRow('Right', formatBind(p1.right), formatBind(p2.right));
        html += compareRow('Jump', formatBind(p1.jump), formatBind(p2.jump));
        html += compareRow('Fire', formatBind(p1.attack), formatBind(p2.attack));

        // Section: Hardware
        html += sectionHeader('Hardware');
        html += compareHardwareRow('Mouse', p1.mouseData, p2.mouseData);
        html += compareHardwareRow('Mousepad', p1.mousepadData, p2.mousepadData);
        html += compareHardwareRow('Keyboard', p1.keyboardData, p2.keyboardData);
        html += compareHardwareRow('Monitor', p1.monitorData, p2.monitorData);
        html += compareHardwareRow('Headset', p1.headsetData, p2.headsetData);

        // Section: Ratings (only show if at least one player has data)
        const hasRatings = p1.duelRating || p2.duelRating || p1.tdmRating || p2.tdmRating || p1.ctfRating || p2.ctfRating;
        if (hasRatings) {
          html += sectionHeader('Ratings');
          if (p1.duelRating || p2.duelRating) {
            html += compareRow('Duel', formatRating(p1.duelRating), formatRating(p2.duelRating), true);
          }
          if (p1.tdmRating || p2.tdmRating) {
            html += compareRow('TDM', formatRating(p1.tdmRating), formatRating(p2.tdmRating), true);
          }
          if (p1.ctfRating || p2.ctfRating) {
            html += compareRow('CTF', formatRating(p1.ctfRating), formatRating(p2.ctfRating), true);
          }
        }

        compareBody.innerHTML = html;
      }

      function sectionHeader(title) {
        return `<tr class="section-row"><td colspan="3">${title}</td></tr>`;
      }

      function compareRow(label, val1, val2, isNumeric = false) {
        const v1 = val1 !== undefined && val1 !== null ? String(val1) : '';
        const v2 = val2 !== undefined && val2 !== null ? String(val2) : '';
        const isSame = v1 !== '' && v2 !== '' && v1 === v2;
        const diffClass = isSame ? 'same-highlight' : '';
        const numClass = isNumeric ? 'numeric' : '';

        // Only show arrow on Player 2 column (right side)
        let diffIndicator2 = '';
        if (!isSame && isNumeric && v1 && v2) {
          const n1 = parseFloat(v1);
          const n2 = parseFloat(v2);
          if (!isNaN(n1) && !isNaN(n2)) {
            diffIndicator2 = n2 > n1
              ? '<span class="diff-arrow higher">▲</span>'
              : '<span class="diff-arrow lower">▼</span>';
          }
        }

        return `<tr class="data-row">
          <td class="label-cell">${label}</td>
          <td class="value-cell ${diffClass} ${numClass}">${v1}</td>
          <td class="value-cell ${diffClass} ${numClass}">${v2}${diffIndicator2}</td>
        </tr>`;
      }

      function compareHardwareRow(label, hw1, hw2) {
        const name1 = hw1?.name || '';
        const name2 = hw2?.name || '';
        const isSame = name1 !== '' && name2 !== '' && name1 === name2;
        const diffClass = isSame ? 'same-highlight' : '';

        return `<tr class="data-row">
          <td class="label-cell">${label}</td>
          <td class="value-cell ${diffClass}">${name1}</td>
          <td class="value-cell ${diffClass}">${name2}</td>
        </tr>`;
      }

      player1Select.addEventListener('change', updateComparison);
      player2Select.addEventListener('change', updateComparison);

      // Initial update if params provided
      if (p1Param || p2Param) {
        updateComparison();
      }
    });
  </script>
</BaseLayout>

<style>
  .compare-selectors {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    margin: 2rem 0;
    flex-wrap: wrap;
  }

  .selector-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .selector-group label {
    color: var(--text-secondary, #9090a0);
    font-size: 0.875rem;
  }

  .selector-group select {
    background: var(--bg-card, #1a1a24);
    border: 1px solid var(--border-color, #2a2a35);
    color: var(--text-primary, #e8e8f0);
    padding: 0.75rem 1rem;
    border-radius: 6px;
    min-width: 200px;
    font-size: 1rem;
  }

  .vs-badge {
    background: var(--accent-primary, #ff6b35);
    color: white;
    font-weight: 700;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.875rem;
  }

  .comparison-container {
    margin-top: 2rem;
    display: flex;
    justify-content: center;
  }

  .comparison-container.hidden {
    display: none;
  }

  .compare-table {
    max-width: 800px;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary, #9090a0);
  }

  .empty-state.hidden {
    display: none;
  }

  .compare-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border-color, #2a2a35);
  }

  .compare-table thead {
    background: var(--bg-secondary, #12121a);
  }

  .compare-table th {
    padding: 1rem;
    text-align: center;
    border-bottom: 1px solid var(--border-color, #2a2a35);
  }

  .player-header {
    width: 30%;
  }

  .label-header {
    width: 40%;
    color: var(--text-secondary, #9090a0);
    font-size: 0.875rem;
    text-align: left;
  }

  .player-header :global(.header-name) {
    display: block;
    font-size: 1.25rem;
    color: var(--accent-secondary, #4ecdc4);
    font-weight: 600;
  }

  .player-header :global(.header-country) {
    display: block;
    font-size: 1.25rem;
    margin-top: 0.25rem;
  }

  /* Dynamic content styles need :global() */
  .compare-table :global(.section-row td) {
    padding: 0.75rem 1rem;
    background: rgba(249, 115, 22, 0.15);
    color: #f97316;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-align: left;
    border-bottom: none;
    border-left: 4px solid #f97316;
  }

  .compare-table :global(.section-row:not(:first-child) td) {
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color, #2a2a35);
  }

  .compare-table :global(.data-row td) {
    padding: 0.6rem 1rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
  }

  .compare-table :global(.data-row:last-child td) {
    border-bottom: none;
  }

  .compare-table :global(.label-cell) {
    text-align: left;
    color: var(--text-secondary, #9090a0);
    font-size: 0.85rem;
  }

  .compare-table :global(.value-cell) {
    font-size: 0.9rem;
  }

  /* Player 1 (2nd column) - right aligned */
  .compare-table :global(.value-cell:nth-child(2)) {
    text-align: right;
    padding-right: 1.5rem;
  }

  /* Player 2 (3rd column) - left aligned */
  .compare-table :global(.value-cell:nth-child(3)) {
    text-align: left;
    padding-left: 1.5rem;
  }

  .compare-table :global(.value-cell.same-highlight) {
    background: rgba(255, 107, 53, 0.1);
    color: var(--accent-primary, #ff6b35);
    font-weight: 500;
  }

  .compare-table :global(.value-cell.numeric) {
    font-family: monospace;
  }

  .compare-table :global(.diff-arrow) {
    font-size: 0.7rem;
    margin-left: 0.35rem;
  }

  .compare-table :global(.diff-arrow.higher) {
    color: #27ae60;
  }

  .compare-table :global(.diff-arrow.lower) {
    color: #e74c3c;
  }

  .hw-link {
    color: var(--accent-secondary, #4ecdc4);
    text-decoration: none;
    transition: color 0.2s;
  }

  .hw-link:hover {
    color: var(--accent-primary, #ff6b35);
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .compare-selectors {
      flex-direction: column;
      gap: 1rem;
    }

    .vs-badge {
      order: 2;
    }

    .selector-group:first-child {
      order: 1;
    }

    .selector-group:last-child {
      order: 3;
    }

    .compare-table {
      font-size: 0.85rem;
    }

    .compare-table th,
    .compare-table td {
      padding: 0.5rem;
    }

    .player-header :global(.header-name) {
      font-size: 1rem;
    }
  }
</style>
