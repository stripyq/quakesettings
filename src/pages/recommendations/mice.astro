---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const mice = await getCollection('mice');

// Sort by brand then name
const sortedMice = mice.sort((a, b) => {
  const brandCompare = a.data.brand.localeCompare(b.data.brand);
  if (brandCompare !== 0) return brandCompare;
  return a.data.name.localeCompare(b.data.name);
});

// Count usage
const players = await getCollection('players');
const usageCount = new Map<string, number>();
players.forEach(player => {
  if (player.data.mouse) {
    const mouseId = player.data.mouse.id;
    usageCount.set(mouseId, (usageCount.get(mouseId) || 0) + 1);
  }
});

// Get top 10 most used
const topMice = [...usageCount.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10)
  .map(([id, count]) => {
    const mouse = mice.find(m => m.id === id);
    return { ...mouse?.data, id, count };
  });
---

<Layout title="Mice Recommendations">
  <h1>Gaming Mice</h1>

  <a href="/quakesettings/recommendations/" style="display: inline-block; margin-bottom: 1.5rem; color: var(--text-secondary);">
    &larr; Back to Recommendations
  </a>

  <section style="margin-bottom: 3rem;">
    <h2>Most Popular in Community</h2>
    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Based on player submissions</p>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Mouse</th>
            <th>Brand</th>
            <th>Players</th>
          </tr>
        </thead>
        <tbody>
          {topMice.map((mouse, i) => (
            <tr>
              <td>#{i + 1}</td>
              <td>{mouse.name}</td>
              <td>{mouse.brand}</td>
              <td><span class="badge">{mouse.count} player{mouse.count > 1 ? 's' : ''}</span></td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <section>
    <h2>All Mice in Database ({mice.length})</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Brand</th>
            <th>Shape</th>
            <th>Weight</th>
            <th>Connection</th>
          </tr>
        </thead>
        <tbody>
          {sortedMice.map(mouse => (
            <tr>
              <td>{mouse.data.name}</td>
              <td>{mouse.data.brand}</td>
              <td>{mouse.data.shape || '-'}</td>
              <td>{mouse.data.weight || '-'}</td>
              <td>{mouse.data.connection || '-'}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>
</Layout>
