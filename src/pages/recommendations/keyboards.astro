---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const keyboards = await getCollection('keyboards');

const sortedKeyboards = keyboards.sort((a, b) => {
  const brandCompare = a.data.brand.localeCompare(b.data.brand);
  if (brandCompare !== 0) return brandCompare;
  return a.data.name.localeCompare(b.data.name);
});

const players = await getCollection('players');
const usageCount = new Map<string, number>();
players.forEach(player => {
  if (player.data.keyboard) {
    const id = player.data.keyboard.id;
    usageCount.set(id, (usageCount.get(id) || 0) + 1);
  }
});

const topKeyboards = [...usageCount.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10)
  .map(([id, count]) => {
    const item = keyboards.find(k => k.id === id);
    return { ...item?.data, id, count };
  });
---

<Layout title="Keyboard Recommendations">
  <h1>Gaming Keyboards</h1>

  <a href="/quakesettings/recommendations/" style="display: inline-block; margin-bottom: 1.5rem; color: var(--text-secondary);">
    &larr; Back to Recommendations
  </a>

  <section style="margin-bottom: 3rem;">
    <h2>Most Popular in Community</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Keyboard</th>
            <th>Brand</th>
            <th>Players</th>
          </tr>
        </thead>
        <tbody>
          {topKeyboards.map((item, i) => (
            <tr>
              <td>#{i + 1}</td>
              <td>{item.name}</td>
              <td>{item.brand}</td>
              <td><span class="badge">{item.count}</span></td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <section>
    <h2>All Keyboards ({keyboards.length})</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Brand</th>
            <th>Size</th>
            <th>Switches</th>
          </tr>
        </thead>
        <tbody>
          {sortedKeyboards.map(item => (
            <tr>
              <td>{item.data.name}</td>
              <td>{item.data.brand}</td>
              <td>{item.data.size || '-'}</td>
              <td>{item.data.switches || '-'}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>
</Layout>
