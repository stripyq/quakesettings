---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;

// Get all players to count hardware usage
const players = await getCollection('players');

// Create keyboard usage map
const keyboardUsageMap = new Map<string, number>();
players.forEach(p => {
  const kbId = p.data.keyboard;
  if (kbId) {
    keyboardUsageMap.set(kbId, (keyboardUsageMap.get(kbId) || 0) + 1);
  }
});

// Map recommendation names to hardware slugs
const keyboardSlugMap: Record<string, string[]> = {
  "Wooting 60HE+ / 60HE V2": ["wooting-60he-plus", "wooting-60he-v2", "wooting-60he"],
  "Wooting 80HE": ["wooting-80he"],
  "DrunkDeer G65 / A75": ["drunkdeer-g65", "drunkdeer-a75"],
  "IROK MG68 Max": ["irok-mg68-max"],
  "Meletrix BOOG75": ["meletrix-boog75"],
  "Pulsar PCMK3 H60": ["pulsar-pcmk3-h60"],
  "Keychron Q1 HE": ["keychron-q1he", "keychron-q1-he"],
  "VXE ATK68": ["vxe-atk68"],
  "NuPhy Halo 65HE": ["nuphy-halo65-he", "nuphy-halo-65he"],
  "Asus ROG Falchion Split": ["asus-rog-falchion-split"],
};

function getPlayerCount(name: string): number {
  const slugs = keyboardSlugMap[name];
  if (!slugs) return 0;
  let total = 0;
  slugs.forEach(slug => {
    total += keyboardUsageMap.get(slug) || 0;
  });
  return total;
}

const keyboardData = [
  { name: "Wooting 60HE+ / 60HE V2", price: "$$$", dl: true, tl: true, ju: true },
  { name: "Wooting 80HE", price: "$$$", dl: false, tl: false, ju: true },
  { name: "DrunkDeer G65 / A75", price: "$$", dl: false, tl: true, ju: true },
  { name: "IROK MG68 Max", price: "$", dl: true, tl: true, ju: false },
  { name: "Meletrix BOOG75", price: "$$$", dl: false, tl: false, ju: true },
  { name: "Pulsar PCMK3 H60", price: "$$", dl: false, tl: true, ju: false },
  { name: "Keychron Q1 HE", price: "$$", dl: false, tl: false, ju: true },
  { name: "VXE ATK68", price: "$", dl: false, tl: false, ju: true },
  { name: "NuPhy Halo 65HE", price: "$$", dl: false, tl: true, ju: false },
  { name: "Asus ROG Falchion Split", price: "$$$", dl: false, tl: true, ju: false },
];

// Sort by reviewer count, then by player count
const sortedKeyboards = keyboardData.sort((a, b) => {
  const aReviewers = (a.dl ? 1 : 0) + (a.tl ? 1 : 0) + (a.ju ? 1 : 0);
  const bReviewers = (b.dl ? 1 : 0) + (b.tl ? 1 : 0) + (b.ju ? 1 : 0);
  if (bReviewers !== aReviewers) return bReviewers - aReviewers;
  return getPlayerCount(b.name) - getPlayerCount(a.name);
});
---

<BaseLayout title="Keyboard Recommendations">
  <div class="page-header">
    <h1>Keyboard Recommendations</h1>
    <p>Recommended keyboards from top reviewers (2025)</p>
  </div>

  <div class="reviewer-legend">
    <span class="legend-item"><span class="badge dl">DL</span> Diamond Lobby</span>
    <span class="legend-item"><span class="badge tl">TL</span> Techless</span>
    <span class="legend-item"><span class="badge ju">JU</span> jakeu</span>
  </div>

  <div class="price-legend">
    <span>$ = Budget</span>
    <span>$$ = Mid-range</span>
    <span>$$$ = Premium</span>
  </div>

  <div class="table-container">
    <table class="rec-table">
      <thead>
        <tr>
          <th>Keyboard</th>
          <th>Price</th>
          <th>DL</th>
          <th>TL</th>
          <th>JU</th>
          <th>Players</th>
        </tr>
      </thead>
      <tbody>
        {sortedKeyboards.map(k => {
          const playerCount = getPlayerCount(k.name);
          return (
            <tr>
              <td class="kb-name">{k.name}</td>
              <td class="price">{k.price}</td>
              <td class="center">{k.dl ? '✓' : ''}</td>
              <td class="center">{k.tl ? '✓' : ''}</td>
              <td class="center">{k.ju ? '✓' : ''}</td>
              <td class="center players">
                {playerCount > 0 ? (
                  <a href={`${base}hardware/#keyboards`} class="player-link">{playerCount}</a>
                ) : '—'}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <div class="back-link">
    <a href={`${base}recommendations/`}>← Back to Recommendations</a>
  </div>
</BaseLayout>

<style>
  .reviewer-legend {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--bg-secondary, #12121a);
    border-radius: 6px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .badge.dl { background: #4a9eff; color: #fff; }
  .badge.tl { background: #ff6b6b; color: #fff; }
  .badge.ju { background: #6bcb77; color: #000; }

  .price-legend {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary, #888);
  }

  .table-container {
    overflow-x: auto;
  }

  .rec-table {
    width: 100%;
    border-collapse: collapse;
  }

  .rec-table th,
  .rec-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #2a2a3a);
  }

  .rec-table th {
    background: var(--bg-secondary, #12121a);
    font-weight: 600;
    color: var(--text-secondary, #888);
    text-transform: uppercase;
    font-size: 0.75rem;
  }

  .rec-table tbody tr:hover {
    background: var(--bg-secondary, #12121a);
  }

  .kb-name {
    font-weight: 500;
    color: var(--text-primary, #fff);
  }

  .price {
    font-family: monospace;
    color: var(--text-secondary, #888);
  }

  .center {
    text-align: center;
    color: var(--accent-primary, #ff6b35);
  }

  .players {
    font-weight: 600;
  }

  .player-link {
    color: var(--accent-primary, #ff6b35);
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 2px;
  }

  .player-link:hover {
    color: var(--accent-secondary, #4ecdc4);
  }

  .back-link {
    margin-top: 2rem;
  }

  .back-link a {
    color: var(--accent-primary, #ff6b35);
    text-decoration: none;
  }

  .back-link a:hover {
    text-decoration: underline;
  }
</style>
