---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;

// Get all players to count hardware usage
const allPlayers = await getCollection('players');
const players = allPlayers.filter(p => p.data.published !== false);

// Create mousepad usage map and player list map
const mousepadUsageMap = new Map<string, number>();
const mousepadPlayersMap = new Map<string, typeof players>();
players.forEach(p => {
  const padId = p.data.mousepad;
  if (padId) {
    mousepadUsageMap.set(padId, (mousepadUsageMap.get(padId) || 0) + 1);
    if (!mousepadPlayersMap.has(padId)) {
      mousepadPlayersMap.set(padId, []);
    }
    mousepadPlayersMap.get(padId)!.push(p);
  }
});

// Function to count players using any variant of a pad (by prefix match)
function getPlayerCountByPrefix(prefixes: string[]): number {
  let total = 0;
  mousepadUsageMap.forEach((count, slug) => {
    if (prefixes.some(prefix => slug.startsWith(prefix))) {
      total += count;
    }
  });
  return total;
}

// Mousepad prefixes for matching variants
const mousepadPrefixes: Record<string, string[]> = {
  "Artisan Zero": ["artisan-fx-zero", "artisan-zero"],
  "LGG Saturn Pro": ["lethal-gaming-gear-saturn-pro"],
  "Artisan Hayate Otsu V2": ["artisan-fx-hayate-otsu-v2", "artisan-hayate-otsu"],
  "Artisan Raiden": ["artisan-fx-raiden", "artisan-raiden"],
  "Wallhack SP-004": ["wallhack-sp-004"],
  "Razer Strider": ["razer-strider"],
  "VXE/VGN Dragonfly Pad": ["vxe-dragonfly", "vgn-dragonfly"],
  "LGG Saturn": ["lethal-gaming-gear-saturn"],
  "Razer Gigantus V2": ["razer-gigantus-v2"],
  "Padsmith Temple of Dreams": ["padsmith-temple"],
};

function getPlayerCount(name: string): number {
  const prefixes = mousepadPrefixes[name];
  if (!prefixes) return 0;
  return getPlayerCountByPrefix(prefixes);
}

function getPlayersForMousepad(name: string): typeof players {
  const prefixes = mousepadPrefixes[name];
  if (!prefixes) return [];
  const result: typeof players = [];
  mousepadPlayersMap.forEach((playersForSlug, slug) => {
    if (prefixes.some(prefix => slug.startsWith(prefix))) {
      result.push(...playersForSlug);
    }
  });
  return result;
}

const mousepadData = [
  { name: "Artisan Zero", surface: "Cloth", speed: "Control", price: "$$$", bz: true, tl: false, ju: true },
  { name: "LGG Saturn Pro", surface: "Cloth", speed: "Control", price: "$$", bz: true, tl: false, ju: true },
  { name: "Artisan Hayate Otsu V2", surface: "Hybrid", speed: "Balanced", price: "$$$", bz: true, tl: false, ju: false },
  { name: "Artisan Raiden", surface: "Hybrid", speed: "Speed", price: "$$$", bz: false, tl: false, ju: true },
  { name: "Wallhack SP-004", surface: "Glass", speed: "Speed", price: "$$", bz: false, tl: true, ju: false },
  { name: "Razer Strider", surface: "Hybrid", speed: "Speed", price: "$", bz: false, tl: true, ju: false },
  { name: "VXE/VGN Dragonfly Pad", surface: "Cloth", speed: "Balanced", price: "$", bz: false, tl: true, ju: false },
  { name: "LGG Saturn", surface: "Cloth", speed: "Control", price: "$$", bz: false, tl: true, ju: false },
  { name: "Razer Gigantus V2", surface: "Cloth", speed: "Control", price: "$", bz: false, tl: true, ju: false },
  { name: "Padsmith Temple of Dreams", surface: "Cloth", speed: "Control", price: "$$", bz: false, tl: false, ju: true },
];

// Sort by reviewer count, then by player count
const sortedPads = mousepadData.sort((a, b) => {
  const aReviewers = (a.bz ? 1 : 0) + (a.tl ? 1 : 0) + (a.ju ? 1 : 0);
  const bReviewers = (b.bz ? 1 : 0) + (b.tl ? 1 : 0) + (b.ju ? 1 : 0);
  if (bReviewers !== aReviewers) return bReviewers - aReviewers;
  return getPlayerCount(b.name) - getPlayerCount(a.name);
});
---

<BaseLayout title="Mousepad Recommendations" description="Best mousepads for Quake Live. Speed, control, and hybrid pads recommended by competitive players.">
  <div class="page-header">
    <h1>Mousepad Recommendations</h1>
    <p>Recommended mousepads from top reviewers (2025)</p>
  </div>

  <div class="reviewer-legend">
    <span class="legend-item"><span class="badge bz">BZ</span> Boardzy</span>
    <span class="legend-item"><span class="badge tl">TL</span> Techless</span>
    <span class="legend-item"><span class="badge ju">JU</span> jakeu</span>
  </div>

  <div class="price-legend">
    <span>$ = Budget (&lt;$30)</span>
    <span>$$ = Mid-range ($30-60)</span>
    <span>$$$ = Premium ($60+)</span>
  </div>

  <div class="table-container">
    <table class="rec-table">
      <thead>
        <tr>
          <th>Mousepad</th>
          <th>Surface</th>
          <th>Speed</th>
          <th>Price</th>
          <th>BZ</th>
          <th>TL</th>
          <th>JU</th>
          <th>Players</th>
        </tr>
      </thead>
      <tbody>
        {sortedPads.map(p => {
          const playerCount = getPlayerCount(p.name);
          return (
            <tr>
              <td class="pad-name">{p.name}</td>
              <td>{p.surface}</td>
              <td><span class={`speed-badge ${p.speed.toLowerCase()}`}>{p.speed}</span></td>
              <td class="price">{p.price}</td>
              <td class="center">{p.bz ? '✓' : ''}</td>
              <td class="center">{p.tl ? '✓' : ''}</td>
              <td class="center">{p.ju ? '✓' : ''}</td>
              <td class="center players">
                {playerCount > 0 ? (
                  <div class="usage-wrapper">
                    <span class="usage-count">{playerCount}</span>
                    <div class="player-dropdown">
                      {getPlayersForMousepad(p.name).map(pl => (
                        <a href={`${base}players/${pl.id}/`}>{pl.data.name}</a>
                      ))}
                    </div>
                  </div>
                ) : '—'}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <div class="back-link">
    <a href={`${base}recommendations/`}>← Back to Recommendations</a>
  </div>
</BaseLayout>

<style>
  .reviewer-legend {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--bg-secondary, #12121a);
    border-radius: 6px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .badge.bz { background: #ffd93d; color: #000; }
  .badge.tl { background: #ff6b6b; color: #fff; }
  .badge.ju { background: #6bcb77; color: #000; }

  .price-legend {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary, #888);
  }

  .table-container {
    overflow-x: auto;
  }

  .rec-table {
    width: 100%;
    border-collapse: collapse;
  }

  .rec-table th,
  .rec-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #2a2a3a);
  }

  .rec-table th {
    background: var(--bg-secondary, #12121a);
    font-weight: 600;
    color: var(--text-secondary, #888);
    text-transform: uppercase;
    font-size: 0.75rem;
  }

  .rec-table tbody tr:hover {
    background: var(--bg-secondary, #12121a);
  }

  .pad-name {
    font-weight: 500;
    color: var(--text-primary, #fff);
  }

  .speed-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .speed-badge.control { background: #4a9eff; color: #fff; }
  .speed-badge.balanced { background: #ffd93d; color: #000; }
  .speed-badge.speed { background: #ff6b6b; color: #fff; }

  .price {
    font-family: monospace;
    color: var(--text-secondary, #888);
  }

  .center {
    text-align: center;
    color: var(--accent-primary, #ff6b35);
  }

  .players {
    font-weight: 600;
  }

  .usage-wrapper {
    position: relative;
    display: inline-block;
    cursor: pointer;
  }

  .usage-count {
    color: var(--accent-primary, #ff6b35);
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 2px;
  }

  .usage-wrapper:hover .usage-count {
    color: var(--accent-secondary, #4ecdc4);
  }

  .player-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-primary, #0a0a0f);
    border: 1px solid var(--border-color, #2a2a3a);
    border-radius: 6px;
    padding: 0.5rem;
    min-width: 120px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .usage-wrapper:hover .player-dropdown {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .player-dropdown a {
    color: var(--text-primary, #fff);
    text-decoration: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    white-space: nowrap;
  }

  .player-dropdown a:hover {
    background: var(--bg-secondary, #12121a);
    color: var(--accent-primary, #ff6b35);
  }

  .back-link {
    margin-top: 2rem;
  }

  .back-link a {
    color: var(--accent-primary, #ff6b35);
    text-decoration: none;
  }

  .back-link a:hover {
    text-decoration: underline;
  }
</style>
