---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;

// Get all players to count hardware usage
const allPlayers = await getCollection('players');
const players = allPlayers.filter(p => p.data.published !== false);

// Create headset usage map and player list map
const headsetUsageMap = new Map<string, number>();
const headsetPlayersMap = new Map<string, typeof players>();
players.forEach(p => {
  const headsetId = p.data.headset;
  if (headsetId) {
    headsetUsageMap.set(headsetId, (headsetUsageMap.get(headsetId) || 0) + 1);
    if (!headsetPlayersMap.has(headsetId)) {
      headsetPlayersMap.set(headsetId, []);
    }
    headsetPlayersMap.get(headsetId)!.push(p);
  }
});

// Map recommendation names to hardware slugs
const headsetSlugMap: Record<string, string[]> = {
  "Audeze Maxwell": ["audeze-maxwell"],
  "SteelSeries Arctis Nova Pro Wireless": ["steelseries-arctis-nova-pro-wireless"],
  "SteelSeries Arctis Nova Elite": ["steelseries-arctis-nova-elite"],
  "Asus ROG Delta 2 Wireless": ["asus-rog-delta-2-wireless"],
  "Alienware Pro Wireless": ["alienware-pro-wireless"],
  "Sony Inzone H5": ["sony-inzone-h5"],
  "SteelSeries Arctis Nova 3X": ["steelseries-arctis-nova-3x"],
  "Razer BlackShark V3X": ["razer-blackshark-v3x"],
  "Logitech G435": ["logitech-g435"],
  "Drop EPOS PC38X": ["drop-epos-pc38x"],
  "Beyerdynamic DT 900 Pro X": ["beyerdynamic-dt-900-pro-x"],
  "Turtle Beach Atlas Air": ["turtle-beach-atlas-air"],
  "Astro A50X": ["astro-a50x"],
  "Fosi K7": ["fosi-k7"],
};

function getPlayerCount(name: string): number {
  const slugs = headsetSlugMap[name];
  if (!slugs) return 0;
  let total = 0;
  slugs.forEach(slug => {
    total += headsetUsageMap.get(slug) || 0;
  });
  return total;
}

function getPlayersForHeadset(name: string): typeof players {
  const slugs = headsetSlugMap[name];
  if (!slugs) return [];
  const result: typeof players = [];
  slugs.forEach(slug => {
    const playersForSlug = headsetPlayersMap.get(slug);
    if (playersForSlug) {
      result.push(...playersForSlug);
    }
  });
  return result;
}

const wirelessGaming = [
  { name: "Audeze Maxwell", type: "Wireless Closed", price: "$$$", gt: true, bs: true, jv: true },
  { name: "SteelSeries Arctis Nova Pro Wireless", type: "Wireless Closed", price: "$$$", gt: true, bs: true, jv: false },
  { name: "SteelSeries Arctis Nova Elite", type: "Wireless Closed", price: "$$$$", gt: true, bs: false, jv: false },
  { name: "Asus ROG Delta 2 Wireless", type: "Wireless Closed", price: "$$", gt: true, bs: false, jv: false },
  { name: "Alienware Pro Wireless", type: "Wireless Closed", price: "$$$", gt: true, bs: false, jv: false },
  { name: "Sony Inzone H5", type: "Wireless Closed", price: "$$", gt: true, bs: false, jv: false },
];

const budgetOptions = [
  { name: "SteelSeries Arctis Nova 3X", type: "USB-C Wireless", price: "$$", gt: true, bs: false, jv: false },
  { name: "Razer BlackShark V3X", type: "Wired", price: "$", gt: true, bs: false, jv: false },
  { name: "Logitech G435", type: "Wireless", price: "$", gt: true, bs: false, jv: false },
];

const audiophile = [
  { name: "Drop EPOS PC38X", type: "Wired Open", price: "$$", gt: false, bs: true, jv: false },
  { name: "Beyerdynamic DT 900 Pro X", type: "Wired Open", price: "$$$", gt: false, bs: false, jv: true },
  { name: "Turtle Beach Atlas Air", type: "Wireless Open", price: "$$", gt: false, bs: false, jv: true },
];

const specialty = [
  { name: "Astro A50X", category: "Best Mic + Console", price: "$$$", notes: "HDMI 2.1 switching" },
  { name: "Fosi K7", category: "DAC/AMP", price: "$$", notes: "Best audio upgrade for any headphone" },
];

function countRecs(h: { gt?: boolean; bs?: boolean; jv?: boolean }) {
  return (h.gt ? 1 : 0) + (h.bs ? 1 : 0) + (h.jv ? 1 : 0);
}

const schema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Recommended Gaming Headsets for Quake Live",
  "description": "Best gaming headsets for competitive Quake Live",
  "url": "https://stripyq.github.io/quakesettings/recommendations/headsets/"
};
---

<BaseLayout title="Headset Recommendations" description="Best gaming headsets for Quake Live. Audio clarity and comfort picks from competitive players." schema={schema}>
  <div class="page-header">
    <h1>Headset Recommendations</h1>
    <p>Recommended headsets from top reviewers (2025)</p>
  </div>

  <div class="reviewer-legend">
    <span class="legend-item"><span class="badge gt">GT</span> GadgetryTech</span>
    <span class="legend-item"><span class="badge bs">BS</span> BadSeed Tech</span>
    <span class="legend-item"><span class="badge jv">JV</span> Joshua Valour</span>
  </div>

  <div class="price-legend">
    <span>$ = Budget (&lt;$80)</span>
    <span>$$ = Mid ($80-200)</span>
    <span>$$$ = Premium ($200-400)</span>
    <span>$$$$ = Flagship ($400+)</span>
  </div>

  <h2 class="section-title">Wireless Gaming</h2>
  <div class="table-container">
    <table class="rec-table">
      <thead>
        <tr>
          <th>Headset</th>
          <th>Type</th>
          <th>Price</th>
          <th>GT</th>
          <th>BS</th>
          <th>JV</th>
          <th>Players</th>
        </tr>
      </thead>
      <tbody>
        {wirelessGaming.map(h => {
          const playerCount = getPlayerCount(h.name);
          return (
            <tr>
              <td class="headset-name">{h.name}</td>
              <td>{h.type}</td>
              <td class="price">{h.price}</td>
              <td class="center">{h.gt ? '✓' : ''}</td>
              <td class="center">{h.bs ? '✓' : ''}</td>
              <td class="center">{h.jv ? '✓' : ''}</td>
              <td class="center players">
                {playerCount > 0 ? (
                  <div class="usage-wrapper">
                    <span class="usage-count">{playerCount}</span>
                    <div class="player-dropdown">
                      {getPlayersForHeadset(h.name).map(p => (
                        <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                      ))}
                    </div>
                  </div>
                ) : '—'}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <h2 class="section-title">Budget Wireless/Wired</h2>
  <div class="table-container">
    <table class="rec-table">
      <thead>
        <tr>
          <th>Headset</th>
          <th>Type</th>
          <th>Price</th>
          <th>GT</th>
          <th>BS</th>
          <th>JV</th>
          <th>Players</th>
        </tr>
      </thead>
      <tbody>
        {budgetOptions.map(h => {
          const playerCount = getPlayerCount(h.name);
          return (
            <tr>
              <td class="headset-name">{h.name}</td>
              <td>{h.type}</td>
              <td class="price">{h.price}</td>
              <td class="center">{h.gt ? '✓' : ''}</td>
              <td class="center">{h.bs ? '✓' : ''}</td>
              <td class="center">{h.jv ? '✓' : ''}</td>
              <td class="center players">
                {playerCount > 0 ? (
                  <div class="usage-wrapper">
                    <span class="usage-count">{playerCount}</span>
                    <div class="player-dropdown">
                      {getPlayersForHeadset(h.name).map(p => (
                        <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                      ))}
                    </div>
                  </div>
                ) : '—'}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <h2 class="section-title">Audiophile / Open-Back (Competitive FPS)</h2>
  <div class="table-container">
    <table class="rec-table">
      <thead>
        <tr>
          <th>Headset</th>
          <th>Type</th>
          <th>Price</th>
          <th>GT</th>
          <th>BS</th>
          <th>JV</th>
          <th>Players</th>
        </tr>
      </thead>
      <tbody>
        {audiophile.map(h => {
          const playerCount = getPlayerCount(h.name);
          return (
            <tr>
              <td class="headset-name">{h.name}</td>
              <td>{h.type}</td>
              <td class="price">{h.price}</td>
              <td class="center">{h.gt ? '✓' : ''}</td>
              <td class="center">{h.bs ? '✓' : ''}</td>
              <td class="center">{h.jv ? '✓' : ''}</td>
              <td class="center players">
                {playerCount > 0 ? (
                  <div class="usage-wrapper">
                    <span class="usage-count">{playerCount}</span>
                    <div class="player-dropdown">
                      {getPlayersForHeadset(h.name).map(p => (
                        <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                      ))}
                    </div>
                  </div>
                ) : '—'}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <h2 class="section-title">Specialty Picks</h2>
  <div class="table-container">
    <table class="rec-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Category</th>
          <th>Price</th>
          <th>Notes</th>
          <th>Players</th>
        </tr>
      </thead>
      <tbody>
        {specialty.map(s => {
          const playerCount = getPlayerCount(s.name);
          return (
            <tr>
              <td class="headset-name">{s.name}</td>
              <td>{s.category}</td>
              <td class="price">{s.price}</td>
              <td class="notes">{s.notes}</td>
              <td class="center players">
                {playerCount > 0 ? (
                  <div class="usage-wrapper">
                    <span class="usage-count">{playerCount}</span>
                    <div class="player-dropdown">
                      {getPlayersForHeadset(s.name).map(p => (
                        <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                      ))}
                    </div>
                  </div>
                ) : '—'}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <div class="back-link">
    <a href={`${base}recommendations/`}>← Back to Recommendations</a>
  </div>
</BaseLayout>

<style>
  .reviewer-legend {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--bg-secondary, #12121a);
    border-radius: 6px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .badge.gt { background: #4a9eff; color: #fff; }
  .badge.bs { background: #ff6b6b; color: #fff; }
  .badge.jv { background: #6bcb77; color: #000; }

  .price-legend {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary, #888);
  }

  .section-title {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.25rem;
    color: var(--text-primary, #fff);
    border-bottom: 1px solid var(--border-color, #2a2a3a);
    padding-bottom: 0.5rem;
  }

  .table-container {
    overflow-x: auto;
    margin-bottom: 1rem;
  }

  .rec-table {
    width: 100%;
    border-collapse: collapse;
  }

  .rec-table th,
  .rec-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #2a2a3a);
  }

  .rec-table th {
    background: var(--bg-secondary, #12121a);
    font-weight: 600;
    color: var(--text-secondary, #888);
    text-transform: uppercase;
    font-size: 0.75rem;
  }

  .rec-table tbody tr:hover {
    background: var(--bg-secondary, #12121a);
  }

  .headset-name {
    font-weight: 500;
    color: var(--text-primary, #fff);
  }

  .price {
    font-family: monospace;
    color: var(--text-secondary, #888);
  }

  .center {
    text-align: center;
    color: var(--accent-primary, #ff6b35);
  }

  .players {
    font-weight: 600;
  }

  .usage-wrapper {
    position: relative;
    display: inline-block;
    cursor: pointer;
  }

  .usage-count {
    color: var(--accent-primary, #ff6b35);
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 2px;
  }

  .usage-wrapper:hover .usage-count {
    color: var(--accent-secondary, #4ecdc4);
  }

  .player-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-primary, #0a0a0f);
    border: 1px solid var(--border-color, #2a2a3a);
    border-radius: 6px;
    padding: 0.5rem;
    min-width: 120px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .usage-wrapper:hover .player-dropdown {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .player-dropdown a {
    color: var(--text-primary, #fff);
    text-decoration: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    white-space: nowrap;
  }

  .player-dropdown a:hover {
    background: var(--bg-secondary, #12121a);
    color: var(--accent-primary, #ff6b35);
  }

  .notes {
    color: var(--text-secondary, #888);
    font-size: 0.875rem;
  }

  .back-link {
    margin-top: 2rem;
  }

  .back-link a {
    color: var(--accent-primary, #ff6b35);
    text-decoration: none;
  }

  .back-link a:hover {
    text-decoration: underline;
  }
</style>
