---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const players = await getCollection('players');
const mice = await getCollection('mice');
const monitors = await getCollection('monitors');
const keyboards = await getCollection('keyboards');
const mousepads = await getCollection('mousepads');

// Create lookup maps
const miceMap = new Map(mice.map(m => [m.id, m.data]));
const monitorsMap = new Map(monitors.map(m => [m.id, m.data]));
const keyboardsMap = new Map(keyboards.map(k => [k.id, k.data]));
const mousepadsMap = new Map(mousepads.map(p => [p.id, p.data]));

// Ensure base URL has trailing slash
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;

// Calculate cm/360 for a player
function calculateCm360(playerData: any): number {
  if (playerData.cm360) return playerData.cm360;
  if (playerData.m_cpi) {
    return Math.round((360 * playerData.m_cpi / (playerData.sensitivity * playerData.dpi)) * 100) / 100;
  }
  return Math.round((41563.6 / (playerData.dpi * playerData.sensitivity)) * 100) / 100;
}

// Format cm/360 values - remove .00 for whole numbers
function formatCm360(value: number): string {
  const fixed = value.toFixed(2);
  return fixed.endsWith('.00') ? Math.round(value).toString() : fixed;
}

// ===========================================
// SUMMARY STATS
// ===========================================

const cm360Values = players.map(p => calculateCm360(p.data)).sort((a, b) => a - b);
const avgCm360 = cm360Values.length > 0
  ? Math.round((cm360Values.reduce((a, b) => a + b, 0) / cm360Values.length) * 100) / 100
  : 0;
const medianCm360 = cm360Values.length > 0
  ? cm360Values[Math.floor(cm360Values.length / 2)]
  : 0;
const minCm360 = cm360Values.length > 0 ? Math.min(...cm360Values) : 0;
const maxCm360 = cm360Values.length > 0 ? Math.max(...cm360Values) : 0;

const accelUsers = players.filter(p => p.data.acceleration).length;
const accelPercentage = Math.round((accelUsers / players.length) * 100);

const fovValues = players.map(p => p.data.fov).filter(v => v);
const avgFov = Math.round(fovValues.reduce((a, b) => a + b, 0) / fovValues.length);

// Top mouse (most popular model)
const mouseUsage = new Map<string, number>();
players.forEach(p => {
  if (p.data.mouse) {
    mouseUsage.set(p.data.mouse, (mouseUsage.get(p.data.mouse) || 0) + 1);
  }
});
const topMouseEntry = [...mouseUsage.entries()].sort((a, b) => b[1] - a[1])[0];
const topMouseName = topMouseEntry ? (miceMap.get(topMouseEntry[0])?.name || topMouseEntry[0]) : 'N/A';

// ===========================================
// SECTION 1: HARDWARE
// ===========================================

// Mouse brands
const mouseBrands = new Map<string, number>();
players.forEach(p => {
  if (p.data.mouse) {
    const mouseData = miceMap.get(p.data.mouse);
    const brand = mouseData?.brand || 'Unknown';
    mouseBrands.set(brand, (mouseBrands.get(brand) || 0) + 1);
  }
});
const topMouseBrands = [...mouseBrands.entries()].sort((a, b) => b[1] - a[1]).slice(0, 8);

// Top mice (specific models)
const topMice = [...mouseUsage.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 8)
  .map(([id, count]) => ({
    name: miceMap.get(id)?.name || id,
    count,
    percentage: Math.round((count / players.length) * 100)
  }));

// Top mousepads (specific models)
const mousepadUsage = new Map<string, number>();
players.forEach(p => {
  if (p.data.mousepad) {
    mousepadUsage.set(p.data.mousepad, (mousepadUsage.get(p.data.mousepad) || 0) + 1);
  }
});
const topMousepads = [...mousepadUsage.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 8)
  .map(([id, count]) => ({
    name: mousepadsMap.get(id)?.name || id,
    count,
    percentage: Math.round((count / players.length) * 100)
  }));

// Grip style distribution
const gripStyles = new Map<string, number>();
players.forEach(p => {
  if (p.data.grip) {
    gripStyles.set(p.data.grip, (gripStyles.get(p.data.grip) || 0) + 1);
  }
});
const gripDistribution = [...gripStyles.entries()].sort((a, b) => b[1] - a[1]);
const totalGripPlayers = [...gripStyles.values()].reduce((a, b) => a + b, 0);

// Mouse shape distribution
const mouseShapeDistribution = new Map<string, number>();
players.forEach(p => {
  if (p.data.mouse) {
    const mouseData = miceMap.get(p.data.mouse);
    if (mouseData) {
      const shape = mouseData.shape || 'Unknown';
      mouseShapeDistribution.set(shape, (mouseShapeDistribution.get(shape) || 0) + 1);
    }
  }
});
const topMouseShapes = [...mouseShapeDistribution.entries()].sort((a, b) => b[1] - a[1]);

// GPU Brand distribution
const gpuBrands = new Map<string, number>();
players.forEach(p => {
  const brand = p.data.gpuBrand || p.data.gpu;
  if (brand) {
    const normalizedBrand = brand.toUpperCase();
    gpuBrands.set(normalizedBrand, (gpuBrands.get(normalizedBrand) || 0) + 1);
  }
});
const topGpuBrands = [...gpuBrands.entries()].sort((a, b) => b[1] - a[1]);
const totalGpuPlayers = [...gpuBrands.values()].reduce((a, b) => a + b, 0);

// CPU Brand distribution
const cpuBrands = new Map<string, number>();
players.forEach(p => {
  const brand = p.data.cpuBrand || p.data.cpu;
  if (brand) {
    const normalizedBrand = brand.charAt(0).toUpperCase() + brand.slice(1).toLowerCase();
    cpuBrands.set(normalizedBrand, (cpuBrands.get(normalizedBrand) || 0) + 1);
  }
});
const topCpuBrands = [...cpuBrands.entries()].sort((a, b) => b[1] - a[1]);
const totalCpuPlayers = [...cpuBrands.values()].reduce((a, b) => a + b, 0);

// Monitor heatmap
function parseMonitorSize(size: string): number | null {
  const match = size.match(/(\d+(?:\.\d+)?)/);
  return match ? parseFloat(match[1]) : null;
}
function parseRefreshRate(rate: string): number | null {
  const match = rate.match(/(\d+)/);
  return match ? parseInt(match[1]) : null;
}

const sizeBins = [21, 24, 25, 27, 32, 34];
const refreshBins = [60, 144, 165, 240, 280, 360, 500];

const monitorHeatmap: Map<string, number> = new Map();
players.forEach(p => {
  if (p.data.monitor) {
    const monitorData = monitorsMap.get(p.data.monitor);
    if (monitorData) {
      const size = parseMonitorSize(monitorData.size || '');
      const refresh = parseRefreshRate(monitorData.refreshRate || '');
      if (size !== null && refresh !== null) {
        const sizeBin = sizeBins.reduce((prev, curr) =>
          Math.abs(curr - size) < Math.abs(prev - size) ? curr : prev
        );
        const refreshBin = refreshBins.reduce((prev, curr) =>
          Math.abs(curr - refresh) < Math.abs(prev - refresh) ? curr : prev
        );
        const key = `${sizeBin}-${refreshBin}`;
        monitorHeatmap.set(key, (monitorHeatmap.get(key) || 0) + 1);
      }
    }
  }
});
const heatmapMax = Math.max(...monitorHeatmap.values(), 1);

function getHeatColor(count: number, max: number): string {
  if (count === 0) return '#21262d';
  const ratio = count / max;
  if (ratio <= 0.2) return '#2d333b';
  if (ratio <= 0.4) return '#3d444d';
  if (ratio <= 0.6) return '#4d555e';
  if (ratio <= 0.8) return '#5d656f';
  return '#6e7681';
}

// ===========================================
// SECTION 2: SENSITIVITY
// ===========================================

// cm/360 distribution bins with accel breakdown
const cm360Bins = [
  { label: '<15', min: 0, max: 15 },
  { label: '15-20', min: 15, max: 20 },
  { label: '20-25', min: 20, max: 25 },
  { label: '25-30', min: 25, max: 30 },
  { label: '30-35', min: 30, max: 35 },
  { label: '35-40', min: 35, max: 40 },
  { label: '40-45', min: 40, max: 45 },
  { label: '45+', min: 45, max: Infinity },
];

const cm360Distribution = cm360Bins.map(bin => {
  const inBin = players.filter(p => {
    const cm = calculateCm360(p.data);
    return cm >= bin.min && cm < bin.max;
  });
  return {
    label: bin.label,
    total: inBin.length,
    accel: inBin.filter(p => p.data.acceleration).length,
    noAccel: inBin.filter(p => !p.data.acceleration).length,
  };
});
const maxCm360Bin = Math.max(...cm360Distribution.map(b => b.total), 1);

// cm/360 vs mousepad type heatmap
const mousepadTypes = ['Cloth', 'Hard', 'Glass', 'Hybrid'];
const cm360SensBins = ['<20', '20-30', '30-40', '40+'];

const cm360MousepadHeatmap: Map<string, number> = new Map();
players.forEach(p => {
  if (p.data.mousepad) {
    const padData = mousepadsMap.get(p.data.mousepad);
    if (padData) {
      const surface = padData.surface || 'Cloth';
      const cm = calculateCm360(p.data);
      let sensBin: string;
      if (cm < 20) sensBin = '<20';
      else if (cm < 30) sensBin = '20-30';
      else if (cm < 40) sensBin = '30-40';
      else sensBin = '40+';

      const key = `${sensBin}-${surface}`;
      cm360MousepadHeatmap.set(key, (cm360MousepadHeatmap.get(key) || 0) + 1);
    }
  }
});
const cm360PadMax = Math.max(...cm360MousepadHeatmap.values(), 1);

// ===========================================
// SECTION 3: GAME SETTINGS
// ===========================================

// FOV distribution
const fovDistribution = new Map<number, number>();
fovValues.forEach(fov => {
  fovDistribution.set(fov, (fovDistribution.get(fov) || 0) + 1);
});
const topFovValues = [...fovDistribution.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 6);
const maxFovCount = Math.max(...topFovValues.map(([_, c]) => c), 1);

// Crosshair color distribution
const crosshairColors = new Map<string, number>();
players.forEach(p => {
  if (p.data.crosshairColor) {
    // Handle multi-color entries like "Blue, Yellow"
    const colors = p.data.crosshairColor.split(',').map((c: string) => c.trim());
    colors.forEach((color: string) => {
      crosshairColors.set(color, (crosshairColors.get(color) || 0) + 1);
    });
  }
});
const crosshairColorDist = [...crosshairColors.entries()]
  .sort((a, b) => b[1] - a[1]);
const maxCrosshairColor = Math.max(...crosshairColorDist.map(([_, c]) => c), 1);

// Map crosshair color names to CSS colors
function getCrosshairBarColor(color: string): string {
  const map: Record<string, string> = {
    'Green': '#238636',
    'Yellow': '#9e6a03',
    'Cyan': '#1f6feb',
    'Red': '#da3633',
    'White': '#6e7681',
    'Pink': '#db61a2',
    'Magenta': '#8957e5',
    'Blue': '#1f6feb',
    'Black': '#21262d',
    'Orange': '#d29922',
  };
  return map[color] || '#6e7681';
}

// Crosshair style distribution
const crosshairTypes = new Map<string, number>();
players.forEach(p => {
  const ch = p.data.crosshair || 'Unknown';
  // Handle multi-crosshair entries like "2, 7, 3"
  const types = ch.split(',').map((c: string) => c.trim());
  types.forEach((type: string) => {
    crosshairTypes.set(type, (crosshairTypes.get(type) || 0) + 1);
  });
});
const topCrosshairs = [...crosshairTypes.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 8);
const maxCrosshairCount = Math.max(...topCrosshairs.map(([_, c]) => c), 1);

// Crosshair type descriptions
const crosshairDesc: Record<string, string> = {
  '1': 'Circle+Dot',
  '2': 'Cross',
  '3': 'Cross Gap',
  '4': 'Small Dot',
  '5': 'Large Dot',
  '6': 'Dot',
  '7': 'Thick Cross',
  '8': 'Circle',
  '9': 'Cross Gap',
  '10': 'X Shape',
  '11': 'Triangle',
  '12': 'Chevron',
  '13': 'Circle CH',
};

// Enemy model distribution
const enemyModels = new Map<string, number>();
players.forEach(p => {
  if (p.data.enemyModel) {
    enemyModels.set(p.data.enemyModel, (enemyModels.get(p.data.enemyModel) || 0) + 1);
  }
});
const enemyModelDist = [...enemyModels.entries()]
  .sort((a, b) => b[1] - a[1]);
const totalEnemyModelPlayers = [...enemyModels.values()].reduce((a, b) => a + b, 0);
const maxEnemyModel = Math.max(...enemyModelDist.map(([_, c]) => c), 1);

// ===========================================
// SECTION 4: CONTROLS
// ===========================================

const movementPatterns = new Map<string, number>();
const jumpKeys = new Map<string, number>();

players.forEach(p => {
  const forward = (p.data.forward || 'W').toUpperCase();
  const left = (p.data.left || 'A').toUpperCase();
  const back = (p.data.back || 'S').toUpperCase();
  const right = (p.data.right || 'D').toUpperCase();
  let pattern = `${forward}${left}${back}${right}`;
  if (pattern === 'WASD') pattern = 'WASD';
  else if (pattern === 'ESDF') pattern = 'ESDF';
  else if (pattern === 'RFDG') pattern = 'RFDG';
  else if (forward.includes('ARROW') || forward.includes('UP')) pattern = 'Arrow Keys';
  else if (forward.includes('KP_') || forward.includes('NUMPAD')) pattern = 'Numpad';
  movementPatterns.set(pattern, (movementPatterns.get(pattern) || 0) + 1);

  let jump = (p.data.jump || 'Space');
  if (jump.toLowerCase() === 'space' || jump.toLowerCase() === 'spacebar') jump = 'Space';
  else if (jump.toLowerCase().includes('mouse2') || jump.toLowerCase() === 'mwheeldown' || jump.toLowerCase() === 'm2') jump = 'Mouse2';
  else if (jump.toLowerCase().includes('mouse')) jump = 'Mouse Button';
  else if (jump.toLowerCase() === 'shift') jump = 'Shift';
  else if (jump.toLowerCase() === 'ctrl' || jump.toLowerCase() === 'control') jump = 'Ctrl';
  jumpKeys.set(jump, (jumpKeys.get(jump) || 0) + 1);
});

const topMovementPatterns = [...movementPatterns.entries()]
  .sort((a, b) => b[1] - a[1]).slice(0, 6);
const maxMovement = Math.max(...topMovementPatterns.map(([_, c]) => c), 1);
const topJumpKeys = [...jumpKeys.entries()]
  .sort((a, b) => b[1] - a[1]).slice(0, 6);
const maxJump = Math.max(...topJumpKeys.map(([_, c]) => c), 1);

// ===========================================
// SECTION 5: PLAYERS
// ===========================================

const recentPlayers = [...players]
  .filter(p => p.data.lastUpdated)
  .sort((a, b) => (b.data.lastUpdated || '').localeCompare(a.data.lastUpdated || ''))
  .slice(0, 5);

// Interesting facts
const lowestSensPlayer = players.reduce((prev, curr) =>
  calculateCm360(curr.data) > calculateCm360(prev.data) ? curr : prev
);
const highestSensPlayer = players.reduce((prev, curr) =>
  calculateCm360(curr.data) < calculateCm360(prev.data) ? curr : prev
);
const highestFovPlayer = players.reduce((prev, curr) =>
  (curr.data.fov || 0) > (prev.data.fov || 0) ? curr : prev
);
const lowestFovPlayer = players.reduce((prev, curr) =>
  (curr.data.fov || 999) < (prev.data.fov || 999) ? curr : prev
);
---

<BaseLayout title="Statistics">
  <div class="stats-page">
    <!-- SUMMARY CARDS -->
    <div class="summary-row">
      <div class="summary-card">
        <span class="summary-value">{players.length}</span>
        <span class="summary-label">Total Players</span>
      </div>
      <div class="summary-card">
        <span class="summary-value">{formatCm360(avgCm360)}</span>
        <span class="summary-label">Avg cm/360</span>
      </div>
      <div class="summary-card">
        <span class="summary-value">{accelPercentage}%</span>
        <span class="summary-label">Accel Users</span>
      </div>
      <div class="summary-card">
        <span class="summary-value summary-value-sm">{topMouseName}</span>
        <span class="summary-label">Top Mouse</span>
      </div>
      <div class="summary-card">
        <span class="summary-value">{avgFov}&deg;</span>
        <span class="summary-label">Avg FOV</span>
      </div>
    </div>

    <!-- SECTION 1: HARDWARE -->
    <div class="section-header hardware">
      <div class="section-icon hardware">üñ±Ô∏è</div>
      <h2>Hardware</h2>
    </div>

    <div class="two-col">
      <div class="card">
        <h3>Mouse Brands</h3>
        <div class="bar-list">
          {topMouseBrands.map(([brand, count]) => (
            <div class="bar-row">
              <span class="bar-label">{brand}</span>
              <div class="bar-track">
                <div class="bar-fill hardware" style={`width: ${(count / players.length) * 100}%`}>
                  <span class="bar-count">{count}</span>
                </div>
              </div>
              <span class="bar-pct">{Math.round((count / players.length) * 100)}%</span>
            </div>
          ))}
        </div>
      </div>
      <div class="card">
        <h3>Top Mice</h3>
        <div class="bar-list">
          {topMice.map((mouse) => (
            <div class="bar-row">
              <span class="bar-label">{mouse.name}</span>
              <div class="bar-track">
                <div class="bar-fill hardware" style={`width: ${(mouse.count / players.length) * 100}%`}>
                  <span class="bar-count">{mouse.count}</span>
                </div>
              </div>
              <span class="bar-pct">{mouse.percentage}%</span>
            </div>
          ))}
        </div>
      </div>
    </div>

    <div class="two-col">
      <div class="card">
        <h3>Top Mousepads</h3>
        <div class="bar-list">
          {topMousepads.map((pad) => (
            <div class="bar-row">
              <span class="bar-label">{pad.name}</span>
              <div class="bar-track">
                <div class="bar-fill hardware" style={`width: ${(pad.count / players.length) * 100}%`}>
                  <span class="bar-count">{pad.count}</span>
                </div>
              </div>
              <span class="bar-pct">{pad.percentage}%</span>
            </div>
          ))}
        </div>
      </div>
      <div class="card">
        <h3>Grip Style</h3>
        {totalGripPlayers > 0 ? (
          <>
            <p class="card-note">{totalGripPlayers} players with data</p>
            <div class="bar-list">
              {gripDistribution.map(([style, count]) => (
                <div class="bar-row">
                  <span class="bar-label">{style}</span>
                  <div class="bar-track">
                    <div class="bar-fill hardware" style={`width: ${(count / totalGripPlayers) * 100}%`}>
                      <span class="bar-count">{count}</span>
                    </div>
                  </div>
                  <span class="bar-pct">{Math.round((count / totalGripPlayers) * 100)}%</span>
                </div>
              ))}
            </div>
          </>
        ) : (
          <p class="card-note">No grip data available</p>
        )}
      </div>
    </div>

    <div class="two-col">
      <div class="card">
        <h3>Mouse Shape</h3>
        <div class="bar-list">
          {topMouseShapes.map(([shape, count]) => (
            <div class="bar-row">
              <span class="bar-label">{shape}</span>
              <div class="bar-track">
                <div class="bar-fill hardware" style={`width: ${(count / players.length) * 100}%`}>
                  <span class="bar-count">{count}</span>
                </div>
              </div>
              <span class="bar-pct">{Math.round((count / players.length) * 100)}%</span>
            </div>
          ))}
        </div>
      </div>
      <div class="card">
        <h3>GPU / CPU Brand</h3>
        <div class="mini-charts">
          <div class="mini-chart">
            <h4>GPU <span class="chip-count">{totalGpuPlayers} players</span></h4>
            <div class="bar-list">
              {topGpuBrands.map(([brand, count]) => (
                <div class="bar-row">
                  <span class="bar-label">{brand}</span>
                  <div class="bar-track">
                    <div class="bar-fill hardware" style={`width: ${(count / totalGpuPlayers) * 100}%`}>
                      <span class="bar-count">{count}</span>
                    </div>
                  </div>
                  <span class="bar-pct">{Math.round((count / totalGpuPlayers) * 100)}%</span>
                </div>
              ))}
            </div>
          </div>
          <div class="mini-chart">
            <h4>CPU <span class="chip-count">{totalCpuPlayers} players</span></h4>
            <div class="bar-list">
              {topCpuBrands.map(([brand, count]) => (
                <div class="bar-row">
                  <span class="bar-label">{brand}</span>
                  <div class="bar-track">
                    <div class="bar-fill hardware" style={`width: ${(count / totalCpuPlayers) * 100}%`}>
                      <span class="bar-count">{count}</span>
                    </div>
                  </div>
                  <span class="bar-pct">{Math.round((count / totalCpuPlayers) * 100)}%</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card wide">
      <h3>Monitor Size vs Refresh Rate</h3>
      <div class="heatmap-container">
        <div class="heatmap-y-label">Size (inches)</div>
        <div class="heatmap-wrapper">
          <div class="heatmap-grid" style={`grid-template-columns: auto repeat(${refreshBins.length}, 70px)`}>
            <div class="hm-cell hm-header"></div>
            {refreshBins.map(rate => (
              <div class="hm-cell hm-header">{rate}Hz</div>
            ))}
            {[...sizeBins].reverse().map(size => (
              <>
                <div class="hm-cell hm-row-label">{size}"</div>
                {refreshBins.map(rate => {
                  const count = monitorHeatmap.get(`${size}-${rate}`) || 0;
                  return (
                    <div
                      class="hm-cell hm-data"
                      style={`background-color: ${getHeatColor(count, heatmapMax)}`}
                      title={`${size}" @ ${rate}Hz: ${count} players`}
                    >
                      {count > 0 ? count : ''}
                    </div>
                  );
                })}
              </>
            ))}
          </div>
          <div class="heatmap-x-label">Refresh Rate</div>
        </div>
        <div class="heatmap-legend">
          <span class="legend-lbl">More</span>
          <div class="legend-scale">
            <div class="legend-cell" style="background: #6e7681"></div>
            <div class="legend-cell" style="background: #5d656f"></div>
            <div class="legend-cell" style="background: #4d555e"></div>
            <div class="legend-cell" style="background: #3d444d"></div>
            <div class="legend-cell" style="background: #2d333b"></div>
            <div class="legend-cell" style="background: #21262d"></div>
          </div>
          <span class="legend-lbl">Less</span>
        </div>
      </div>
    </div>

    <!-- SECTION 2: SENSITIVITY -->
    <div class="section-header sensitivity">
      <div class="section-icon sensitivity">üéØ</div>
      <h2>Sensitivity</h2>
    </div>

    <div class="two-col">
      <div class="card">
        <h3>cm/360 Distribution</h3>
        <div class="bar-list">
          {cm360Distribution.map((bin) => (
            <div class="bar-row">
              <span class="bar-label">{bin.label}</span>
              <div class="bar-track">
                <div class="bar-fill sensitivity" style={`width: ${(bin.noAccel / maxCm360Bin) * 100}%`}>
                  {bin.noAccel > 0 && <span class="bar-count">{bin.noAccel}</span>}
                </div>
                {bin.accel > 0 && (
                  <div class="bar-fill-accel" style={`width: ${(bin.accel / maxCm360Bin) * 100}%; left: ${(bin.noAccel / maxCm360Bin) * 100}%`}>
                    <span class="bar-count">{bin.accel}</span>
                  </div>
                )}
              </div>
              <span class="bar-pct">{bin.total}</span>
            </div>
          ))}
        </div>
        <div class="accel-legend">
          <span class="accel-legend-item"><span class="dot sensitivity-dot"></span> No accel</span>
          <span class="accel-legend-item"><span class="dot accel-dot"></span> Accel</span>
        </div>
        <div class="sens-stats">
          <div><strong>Average:</strong> {formatCm360(avgCm360)} cm</div>
          <div><strong>Median:</strong> {formatCm360(medianCm360)} cm</div>
          <div><strong>Range:</strong> {formatCm360(minCm360)} ‚Äì {formatCm360(maxCm360)} cm</div>
        </div>
        <p class="card-note">For accel players, cm/360 represents base (slowest) sensitivity</p>
      </div>
      <div class="card">
        <h3>cm/360 vs Mousepad Type</h3>
        <div class="heatmap-wrapper compact">
          <div class="heatmap-grid" style={`grid-template-columns: auto repeat(${mousepadTypes.length}, 1fr)`}>
            <div class="hm-cell hm-header"></div>
            {mousepadTypes.map(type => (
              <div class="hm-cell hm-header">{type}</div>
            ))}
            {cm360SensBins.map(sensBin => (
              <>
                <div class="hm-cell hm-row-label">{sensBin}</div>
                {mousepadTypes.map(padType => {
                  const count = cm360MousepadHeatmap.get(`${sensBin}-${padType}`) || 0;
                  return (
                    <div
                      class="hm-cell hm-data"
                      style={`background-color: ${getHeatColor(count, cm360PadMax)}`}
                      title={`${sensBin} cm/360, ${padType}: ${count} players`}
                    >
                      {count > 0 ? count : ''}
                    </div>
                  );
                })}
              </>
            ))}
          </div>
          <div class="heatmap-axes">
            <span class="axis-label">cm/360 range ‚Üì</span>
            <span class="axis-label">Mousepad surface ‚Üí</span>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 3: GAME SETTINGS -->
    <div class="section-header settings">
      <div class="section-icon settings">‚öôÔ∏è</div>
      <h2>Game Settings</h2>
    </div>

    <div class="three-col">
      <div class="card">
        <h3>FOV Distribution</h3>
        <div class="bar-list">
          {topFovValues.map(([fov, count]) => (
            <div class="bar-row">
              <span class="bar-label">{fov}&deg;</span>
              <div class="bar-track">
                <div class="bar-fill settings" style={`width: ${(count / maxFovCount) * 100}%`}>
                  <span class="bar-count">{count}</span>
                </div>
              </div>
              <span class="bar-pct">{Math.round((count / players.length) * 100)}%</span>
            </div>
          ))}
        </div>
      </div>
      <div class="card">
        <h3>Crosshair Color</h3>
        <div class="bar-list">
          {crosshairColorDist.map(([color, count]) => (
            <div class="bar-row">
              <span class="bar-label">{color}</span>
              <div class="bar-track">
                <div class="bar-fill-color" style={`width: ${(count / maxCrosshairColor) * 100}%; background-color: ${getCrosshairBarColor(color)}; ${color === 'Black' ? 'border: 1px solid #30363d;' : ''}`}>
                  <span class="bar-count" style={`color: ${color === 'Black' || color === 'Blue' || color === 'Red' || color === 'Green' ? '#f0f6fc' : '#0d1117'}`}>{count}</span>
                </div>
              </div>
              <span class="bar-pct">{Math.round((count / players.length) * 100)}%</span>
            </div>
          ))}
        </div>
      </div>
      <div class="card">
        <h3>Crosshair Style</h3>
        <div class="bar-list">
          {topCrosshairs.map(([type, count]) => (
            <div class="bar-row">
              <span class="bar-label" title={crosshairDesc[type] || `Type ${type}`}>Type {type}</span>
              <div class="bar-track">
                <div class="bar-fill settings" style={`width: ${(count / maxCrosshairCount) * 100}%`}>
                  <span class="bar-count">{count}</span>
                </div>
              </div>
              <span class="bar-pct">{Math.round((count / players.length) * 100)}%</span>
            </div>
          ))}
        </div>
      </div>
    </div>

    {enemyModelDist.length > 0 && (
      <div class="card">
        <h3>Enemy Model</h3>
        <p class="card-note">{totalEnemyModelPlayers} players with data</p>
        <div class="bar-list inline-bars">
          {enemyModelDist.map(([model, count]) => (
            <div class="bar-row">
              <span class="bar-label">{model}</span>
              <div class="bar-track">
                <div class="bar-fill settings" style={`width: ${(count / maxEnemyModel) * 100}%`}>
                  <span class="bar-count">{count}</span>
                </div>
              </div>
              <span class="bar-pct">{Math.round((count / totalEnemyModelPlayers) * 100)}%</span>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- SECTION 4: CONTROLS -->
    <div class="section-header controls">
      <div class="section-icon controls">‚å®Ô∏è</div>
      <h2>Controls</h2>
    </div>

    <div class="two-col">
      <div class="card">
        <h3>Movement Keys</h3>
        <div class="bar-list">
          {topMovementPatterns.map(([pattern, count]) => (
            <div class="bar-row">
              <span class="bar-label mono">{pattern}</span>
              <div class="bar-track">
                <div class="bar-fill controls" style={`width: ${(count / maxMovement) * 100}%`}>
                  <span class="bar-count">{count}</span>
                </div>
              </div>
              <span class="bar-pct">{Math.round((count / players.length) * 100)}%</span>
            </div>
          ))}
        </div>
      </div>
      <div class="card">
        <h3>Jump Key</h3>
        <div class="bar-list">
          {topJumpKeys.map(([key, count]) => (
            <div class="bar-row">
              <span class="bar-label mono">{key}</span>
              <div class="bar-track">
                <div class="bar-fill controls" style={`width: ${(count / maxJump) * 100}%`}>
                  <span class="bar-count">{count}</span>
                </div>
              </div>
              <span class="bar-pct">{Math.round((count / players.length) * 100)}%</span>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- SECTION 5: PLAYERS -->
    <div class="section-header players-section">
      <div class="section-icon players-section">üë•</div>
      <h2>Players</h2>
    </div>

    <div class="two-col">
      {recentPlayers.length > 0 && (
        <div class="card">
          <h3>Recently Updated</h3>
          <div class="recent-list">
            {recentPlayers.map((p, i) => (
              <a href={`${base}players/${p.id}/`} class="recent-item">
                <span class="recent-rank">#{i + 1}</span>
                <span class="recent-name">{p.data.name}</span>
                <span class="recent-date">{p.data.lastUpdated}</span>
              </a>
            ))}
          </div>
        </div>
      )}
      <div class="card">
        <h3>Interesting Facts</h3>
        <div class="facts-grid">
          <div class="fact-card">
            <span class="fact-emoji">üê¢</span>
            <div class="fact-info">
              <span class="fact-title">Lowest Sensitivity</span>
              <a href={`${base}players/${lowestSensPlayer.id}/`}>{lowestSensPlayer.data.name}</a>
              <span class="fact-detail">{formatCm360(calculateCm360(lowestSensPlayer.data))} cm/360</span>
            </div>
          </div>
          <div class="fact-card">
            <span class="fact-emoji">‚ö°</span>
            <div class="fact-info">
              <span class="fact-title">Highest Sensitivity</span>
              <a href={`${base}players/${highestSensPlayer.id}/`}>{highestSensPlayer.data.name}</a>
              <span class="fact-detail">{formatCm360(calculateCm360(highestSensPlayer.data))} cm/360</span>
            </div>
          </div>
          <div class="fact-card">
            <span class="fact-emoji">üî≠</span>
            <div class="fact-info">
              <span class="fact-title">Highest FOV</span>
              <a href={`${base}players/${highestFovPlayer.id}/`}>{highestFovPlayer.data.name}</a>
              <span class="fact-detail">{highestFovPlayer.data.fov}&deg;</span>
            </div>
          </div>
          <div class="fact-card">
            <span class="fact-emoji">üîç</span>
            <div class="fact-info">
              <span class="fact-title">Lowest FOV</span>
              <a href={`${base}players/${lowestFovPlayer.id}/`}>{lowestFovPlayer.data.name}</a>
              <span class="fact-detail">{lowestFovPlayer.data.fov}&deg;</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="stats-footer">
    <p>Duel ratings via <a href="https://qlstats.net/ranks/duel/1" target="_blank" rel="noopener">QLStats</a> ¬∑ CTF/TDM ratings via <a href="http://88.214.20.58/ratings/" target="_blank" rel="noopener">HoQ</a> ¬∑ CSQL ratings via <a href="https://qllr.xyz" target="_blank" rel="noopener">QLLR</a></p>
  </footer>
</BaseLayout>

<style>
  /* ========================================
     BASE & LAYOUT
     ======================================== */

  .stats-page {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .two-col {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
  }

  .three-col {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.25rem;
  }

  @media (max-width: 900px) {
    .three-col {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .two-col,
    .three-col {
      grid-template-columns: 1fr;
    }
  }

  /* ========================================
     SUMMARY CARDS
     ======================================== */

  .summary-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
  }

  @media (max-width: 900px) {
    .summary-row {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 480px) {
    .summary-row {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .summary-card {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .summary-value {
    font-size: 1.75rem;
    font-weight: 600;
    color: #f0f6fc;
    line-height: 1.2;
  }

  .summary-value-sm {
    font-size: 1rem;
  }

  .summary-label {
    font-size: 0.8rem;
    color: #8b949e;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ========================================
     SECTION HEADERS
     ======================================== */

  .section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #30363d;
    margin-top: 1rem;
  }

  .section-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    flex-shrink: 0;
  }

  .section-icon.hardware { background: rgba(35, 134, 54, 0.2); }
  .section-icon.sensitivity { background: rgba(31, 111, 235, 0.2); }
  .section-icon.settings { background: rgba(137, 87, 229, 0.2); }
  .section-icon.controls { background: rgba(218, 54, 51, 0.2); }
  .section-icon.players-section { background: rgba(210, 153, 34, 0.2); }

  .section-header h2 {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
  }

  .section-header.hardware h2 { color: #238636; }
  .section-header.sensitivity h2 { color: #1f6feb; }
  .section-header.settings h2 { color: #8957e5; }
  .section-header.controls h2 { color: #da3633; }
  .section-header.players-section h2 { color: #d29922; }

  /* ========================================
     CARDS
     ======================================== */

  .card {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 8px;
    padding: 1.25rem;
  }

  .card.wide {
    width: 100%;
  }

  .card h3 {
    font-size: 0.9rem;
    color: #c9d1d9;
    margin: 0 0 0.75rem 0;
    font-weight: 600;
  }

  .card-note {
    font-size: 0.75rem;
    color: #8b949e;
    margin: -0.5rem 0 0.75rem 0;
  }

  /* ========================================
     BAR CHARTS
     ======================================== */

  .bar-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .bar-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .bar-label {
    width: 100px;
    text-align: right;
    font-size: 0.8rem;
    color: #8b949e;
    flex-shrink: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .bar-label.mono {
    font-family: monospace;
    letter-spacing: 0.03em;
    color: #c9d1d9;
  }

  .bar-track {
    flex: 1;
    background: #21262d;
    height: 20px;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .bar-fill {
    height: 100%;
    border-radius: 4px;
    display: flex;
    align-items: center;
    padding: 0 6px;
    min-width: fit-content;
    position: relative;
  }

  .bar-fill.hardware { background: #238636; }
  .bar-fill.sensitivity { background: #1f6feb; }
  .bar-fill.settings { background: #8957e5; }
  .bar-fill.controls { background: #da3633; }
  .bar-fill.players-section { background: #d29922; }

  .bar-fill-accel {
    height: 100%;
    border-radius: 0 4px 4px 0;
    display: flex;
    align-items: center;
    padding: 0 6px;
    position: absolute;
    top: 0;
    background: rgba(31, 111, 235, 0.4);
    min-width: fit-content;
  }

  .bar-fill-color {
    height: 100%;
    border-radius: 4px;
    display: flex;
    align-items: center;
    padding: 0 6px;
    min-width: fit-content;
  }

  .bar-count {
    font-size: 0.7rem;
    font-weight: 600;
    color: #f0f6fc;
    white-space: nowrap;
  }

  .bar-pct {
    width: 40px;
    text-align: right;
    font-size: 0.75rem;
    color: #8b949e;
    flex-shrink: 0;
  }

  .inline-bars .bar-label {
    width: 80px;
  }

  .accel-legend {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: #8b949e;
  }

  .accel-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
  }

  .sensitivity-dot { background: #1f6feb; }
  .accel-dot { background: rgba(31, 111, 235, 0.4); }

  .sens-stats {
    display: flex;
    gap: 1rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #30363d;
    font-size: 0.8rem;
    color: #c9d1d9;
    flex-wrap: wrap;
  }

  .sens-stats strong {
    color: #8b949e;
  }

  /* ========================================
     MINI CHARTS (GPU/CPU)
     ======================================== */

  .mini-charts {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .mini-chart h4 {
    font-size: 0.8rem;
    color: #8b949e;
    margin: 0 0 0.5rem 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .chip-count {
    font-weight: 400;
    font-size: 0.7rem;
    color: #484f58;
    text-transform: none;
    letter-spacing: 0;
  }

  /* ========================================
     HEATMAPS
     ======================================== */

  .heatmap-container {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .heatmap-y-label {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    font-size: 0.7rem;
    color: #8b949e;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .heatmap-wrapper {
    flex: 1;
    overflow-x: auto;
  }

  .heatmap-wrapper.compact {
    overflow-x: visible;
  }

  .heatmap-grid {
    display: grid;
    gap: 2px;
    min-width: fit-content;
  }

  .hm-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 500;
    min-height: 28px;
  }

  .hm-header {
    color: #8b949e;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .hm-row-label {
    color: #8b949e;
    font-size: 0.7rem;
    font-weight: 600;
    justify-content: flex-end;
    padding-right: 8px;
  }

  .hm-data {
    border-radius: 3px;
    color: #f0f6fc;
    cursor: default;
    transition: transform 0.1s;
  }

  .hm-data:hover {
    transform: scale(1.08);
    z-index: 1;
  }

  .heatmap-x-label {
    text-align: center;
    font-size: 0.7rem;
    color: #8b949e;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 6px;
  }

  .heatmap-legend {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .legend-scale {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .legend-cell {
    width: 14px;
    height: 14px;
    border-radius: 2px;
  }

  .legend-lbl {
    font-size: 0.6rem;
    color: #8b949e;
  }

  .heatmap-axes {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
  }

  .axis-label {
    font-size: 0.65rem;
    color: #484f58;
  }

  @media (max-width: 640px) {
    .heatmap-container {
      flex-direction: column;
    }
    .heatmap-y-label {
      writing-mode: horizontal-tb;
      transform: none;
    }
  }

  /* ========================================
     RECENTLY UPDATED
     ======================================== */

  .recent-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .recent-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: #21262d;
    border-radius: 6px;
    text-decoration: none;
    transition: background 0.15s;
  }

  .recent-item:hover {
    background: #30363d;
  }

  .recent-rank {
    font-size: 0.75rem;
    color: #484f58;
    font-weight: 600;
    min-width: 20px;
  }

  .recent-name {
    flex: 1;
    color: #c9d1d9;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .recent-date {
    font-size: 0.75rem;
    color: #484f58;
  }

  /* ========================================
     INTERESTING FACTS
     ======================================== */

  .facts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }

  @media (max-width: 480px) {
    .facts-grid {
      grid-template-columns: 1fr;
    }
  }

  .fact-card {
    display: flex;
    gap: 10px;
    padding: 10px 12px;
    background: #21262d;
    border-radius: 6px;
  }

  .fact-emoji {
    font-size: 1.25rem;
    flex-shrink: 0;
    line-height: 1;
  }

  .fact-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
  }

  .fact-title {
    font-size: 0.7rem;
    color: #8b949e;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .fact-info a {
    color: #c9d1d9;
    font-size: 0.85rem;
    font-weight: 500;
    text-decoration: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .fact-info a:hover {
    color: #f0f6fc;
    text-decoration: underline;
  }

  .fact-detail {
    font-size: 0.75rem;
    color: #484f58;
  }

  /* ========================================
     FOOTER
     ======================================== */

  .stats-footer {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid #30363d;
    text-align: center;
  }

  .stats-footer p {
    font-size: 0.75rem;
    color: #484f58;
  }

  .stats-footer a {
    color: #8b949e;
    text-decoration: none;
  }

  .stats-footer a:hover {
    color: #c9d1d9;
    text-decoration: underline;
  }
</style>
