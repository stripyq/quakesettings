---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { calculateRealAccel } from '../../utils/accel';
import { calculateCm360 } from '../../utils/sensitivity';
import fs from 'node:fs';
import path from 'node:path';

// Load season stats from public/data (generated by scripts/fetch-season-stats.cjs)
let seasonStatsData: Record<string, any> = {};
try {
  const seasonPath = path.join(process.cwd(), 'public/data/season-stats.json');
  seasonStatsData = JSON.parse(fs.readFileSync(seasonPath, 'utf8'));
} catch {
  // No season stats available yet - that's fine
}

// Load player registry for name lookups (e.g. rivalry names)
let playerRegistry: Array<{ steamId: string; name: string; slug: string | null }> = [];
try {
  const registryPath = path.join(process.cwd(), 'src/data/player-registry.json');
  const registry = JSON.parse(fs.readFileSync(registryPath, 'utf8'));
  playerRegistry = registry.players || [];
} catch {
  // Registry not available
}

export async function getStaticPaths() {
  const allPlayers = await getCollection('players');
  const players = allPlayers.filter(p => p.data.published !== false);
  return players.map((player) => ({
    params: { id: player.id },
    props: { player },
  }));
}

const { player } = Astro.props;
const p = player.data;

// Get hardware collections
const mice = await getCollection('mice');
const mousepads = await getCollection('mousepads');
const keyboards = await getCollection('keyboards');
const monitors = await getCollection('monitors');
const headsets = await getCollection('headsets');

// Create lookup maps
const miceMap = new Map(mice.map(m => [m.id, m.data]));
const mousepadsMap = new Map(mousepads.map(m => [m.id, m.data]));
const keyboardsMap = new Map(keyboards.map(k => [k.id, k.data]));
const monitorsMap = new Map(monitors.map(m => [m.id, m.data]));
const headsetsMap = new Map(headsets.map(h => [h.id, h.data]));

// Get this player's hardware
const mouseData = miceMap.get(p.mouse);
const mousepadData = p.mousepad ? mousepadsMap.get(p.mousepad) : null;
const keyboardData = p.keyboard ? keyboardsMap.get(p.keyboard) : null;
const monitorData = p.monitor ? monitorsMap.get(p.monitor) : null;
const headsetData = p.headset ? headsetsMap.get(p.headset) : null;

// Get all players for Similar Players and Teammates sections
const allPlayers = await getCollection('players');
const otherPlayers = allPlayers.filter(pl => pl.id !== player.id);

// Find teammates (same team2026, excluding current player)
const teammates = p.team2026
  ? allPlayers
      .filter(pl => pl.id !== player.id && pl.data.team2026 === p.team2026)
      .sort((a, b) => a.data.name.localeCompare(b.data.name))
  : [];

const currentCm360 = calculateCm360(p);
const realAccel = calculateRealAccel(p);

// Format number: strip trailing .00, otherwise show up to 2 decimals
function formatNum(n: number): string {
  const fixed = n.toFixed(2);
  return fixed.endsWith('.00') ? Math.round(n).toString() : fixed;
}

// Find players with similar cm/360 (within 15% range)
const similarSens = otherPlayers
  .map(pl => ({
    player: pl,
    cm360: calculateCm360(pl.data),
  }))
  .filter(({ cm360 }) => {
    const diff = Math.abs(cm360 - currentCm360) / currentCm360;
    return diff <= 0.15;
  })
  .sort((a, b) => Math.abs(a.cm360 - currentCm360) - Math.abs(b.cm360 - currentCm360))
  .slice(0, 5);

// Find players with same mouse
const sameMouse = p.mouse
  ? otherPlayers.filter(pl => pl.data.mouse === p.mouse).slice(0, 5)
  : [];

// Find players with same monitor
const sameMonitor = p.monitor
  ? otherPlayers.filter(pl => pl.data.monitor === p.monitor).slice(0, 5)
  : [];

// Find players with same keyboard
const sameKeyboard = p.keyboard
  ? otherPlayers.filter(pl => pl.data.keyboard === p.keyboard).slice(0, 5)
  : [];

// Find players with same mousepad
const sameMousepad = p.mousepad
  ? otherPlayers.filter(pl => pl.data.mousepad === p.mousepad).slice(0, 5)
  : [];

// Format rating based on type
function formatRating(rating: number | undefined, type: 'duel' | 'ctf' | 'tdm'): string {
  if (!rating) return '—';
  if (type === 'duel') return Math.round(rating).toString(); // Glicko: integer
  return rating.toFixed(1); // TrueSkill: one decimal
}

// Get team rating (higher of CTF or TDM)
function getTeamRating(): { rating: number | null; type: 'ctf' | 'tdm' | null } {
  const ctf = p.ctfRating || 0;
  const tdm = p.tdmRating || 0;
  if (ctf === 0 && tdm === 0) return { rating: null, type: null };
  if (ctf >= tdm) return { rating: p.ctfRating!, type: 'ctf' };
  return { rating: p.tdmRating!, type: 'tdm' };
}

const teamInfo = getTeamRating();

// Check if player has duel rating history
const hasDuelHistory = p.duelRatingPeak || p.duelRatingLow;

// Check if player has team rating history
const hasTeamHistory = (teamInfo.type === 'ctf' && (p.ctfRatingPeak || p.ctfRatingLow)) ||
                       (teamInfo.type === 'tdm' && (p.tdmRatingPeak || p.tdmRatingLow));

// Mousepad variant display
const mpVariantParts: string[] = [];
if (p.mousepadBase) mpVariantParts.push(p.mousepadBase);
if (p.mousepadSize) mpVariantParts.push(p.mousepadSize);
const mpVariantLabel = mpVariantParts.join(', ');
const mpDisplayName = mousepadData
  ? (mpVariantLabel ? mousepadData.name + ' (' + mpVariantLabel + ')' : mousepadData.name)
  : '';
let mpBaseDisplay = '';
if (p.mousepadBase) {
  mpBaseDisplay = p.mousepadBase;
  if (mousepadData?.variants) {
    const mv = mousepadData.variants.find((v: any) => v.base === p.mousepadBase);
    if (mv?.thickness) mpBaseDisplay = p.mousepadBase + ' (' + mv.thickness + ')';
  }
}
const hasMousepadVariant = !!(p.mousepadBase || p.mousepadSize);

// HoQ Stats
const hasHoqStats = !!(p.favorite_map || p.favorite_gametype || p.favorite_weapon || p.accuracy_rl != null || p.accuracy_lg != null || p.accuracy_rg != null);
const avgAccuracy = { rl: 40.5, lg: 35.7, rg: 52.6 };

// Season Stats (from HoQ 2026 S1 API)
const seasonStatsEntry = p.steamId ? seasonStatsData[p.steamId] : null;

// Support both new nested format (ctf/tdm keys) and legacy flat format
const ctfStats = seasonStatsEntry?.ctf || (seasonStatsEntry?.career ? seasonStatsEntry : null);
const tdmStats = seasonStatsEntry?.tdm || null;

// Calculate percentiles and averages across all players with season data (per mode)
function collectModePlayers(mode: string) {
  return Object.values(seasonStatsData).map((s: any) => {
    // Support both nested and legacy flat format
    return s[mode] || (mode === 'ctf' && s.career ? s : null);
  }).filter((s: any) => s?.career) as any[];
}

function average(values: number[]): number {
  if (values.length === 0) return 0;
  return values.reduce((a, b) => a + b, 0) / values.length;
}

function getPercentile(value: number, allValues: number[], higherIsBetter = true): number {
  if (allValues.length === 0) return 50;
  const betterCount = allValues.filter(v => higherIsBetter ? v > value : v < value).length;
  return Math.round((betterCount / allValues.length) * 100);
}

function formatAvg(n: number, decimals = 0): string {
  return decimals > 0 ? n.toFixed(decimals) : Math.round(n).toString();
}

// Build stat arrays for a given mode (for percentile calculations)
function buildModeArrays(mode: string) {
  const modePlayers = collectModePlayers(mode);

  const games = modePlayers.map(s => s.career.matches_played).filter((v: any) => v != null);
  const winRate = modePlayers.map(s => s.career.win_rate).filter((v: any) => v != null);
  const kd = modePlayers.map(s => s.career.kd_ratio).filter((v: any) => v != null);
  const kills = modePlayers.map(s => s.career.total_kills).filter((v: any) => v != null);
  const deaths = modePlayers.map(s => s.career.total_deaths).filter((v: any) => v != null);
  const dpm = modePlayers.map(s => s.career.damage_per_minute).filter((v: any) => v != null);
  const streak = modePlayers.map(s => s.career.max_streak).filter((v: any) => v != null);

  // Flag stats (CTF only)
  const flagPlayers = modePlayers.filter(s => s.flagStats?.data);
  const captures = flagPlayers.map(s => s.flagStats.data.captures).filter((v: any) => v != null);
  const returns = flagPlayers.map(s => s.flagStats.data.returns).filter((v: any) => v != null);
  const pickups = flagPlayers.map(s => s.flagStats.data.pickups).filter((v: any) => v != null);
  const defends = flagPlayers.map(s => s.flagStats.data.defends).filter((v: any) => v != null);
  const assists = flagPlayers.map(s => s.flagStats.data.assists).filter((v: any) => v != null);

  return { games, winRate, kd, kills, deaths, dpm, streak, captures, returns, pickups, defends, assists };
}

const ctfArrays = buildModeArrays('ctf');
const tdmArrays = buildModeArrays('tdm');

// Percentile color class
function pctClass(pct: number): string {
  if (pct <= 10) return 'pct-elite';
  if (pct <= 25) return 'pct-good';
  if (pct <= 50) return 'pct-avg';
  return 'pct-below';
}

// Helper to find a weapon entry from the weapons array
function getWeapon(weapons: any[] | undefined, name: string) {
  return weapons?.find((w: any) => w.weapon === name);
}

// Extract per-mode display data
function extractModeDisplay(modeStats: any) {
  if (!modeStats) return null;
  const weapons = modeStats.weapons;
  const mapStatsRaw = modeStats.mapStats;
  const mapStatsArray: any[] = Array.isArray(mapStatsRaw) ? mapStatsRaw
    : Array.isArray(mapStatsRaw?.value) ? mapStatsRaw.value
    : [];
  const flagData = modeStats.flagStats?.data || null;
  const nemesisData = modeStats.nemesis?.data || null;
  const victimData = modeStats.favoriteVictim?.data || null;
  return { career: modeStats.career, weapons, mapStatsArray, flagData, nemesisData, victimData };
}

const ctfDisplay = extractModeDisplay(ctfStats);
const tdmDisplay = extractModeDisplay(tdmStats);

// Build steamId→slug lookup for rivalry links
const steamIdToSlug = new Map<string, string>();
for (const pl of allPlayers) {
  if (pl.data.steamId) {
    steamIdToSlug.set(pl.data.steamId, pl.id);
  }
}

function getRivalrySlug(opponentSteamId: string | undefined): string | null {
  if (!opponentSteamId) return null;
  return steamIdToSlug.get(opponentSteamId) || null;
}

// Resolve rivalry names: prefer player registry name over API name
function getRegistryName(steamId: string | undefined): string | null {
  if (!steamId) return null;
  const entry = playerRegistry.find(p => p.steamId === steamId);
  return entry?.name || null;
}

// Ensure base URL has trailing slash for path concatenation
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;

// ─── Setup Insights ───
const publishedPlayers = allPlayers.filter(pl => pl.data.published !== false);
const hasSettings = !!(p.dpi && p.sensitivity);

// Sensitivity distribution
const allCm360Values = publishedPlayers
  .map(pl => calculateCm360(pl.data))
  .filter(v => v > 0);
const fasterThanPct = allCm360Values.length > 0 && currentCm360 > 0
  ? Math.round(allCm360Values.filter(s => s > currentCm360).length / allCm360Values.length * 100)
  : null;

// Sensitivity category
function getSensCategory(cm360: number): string {
  if (cm360 < 20) return 'Very fast';
  if (cm360 < 30) return 'Fast';
  if (cm360 < 40) return 'Medium';
  if (cm360 < 50) return 'Slow';
  return 'Very slow';
}

// Build sensitivity distribution buckets for the bar chart
const sensBuckets = [
  { label: '<20', min: 0, max: 20 },
  { label: '20-30', min: 20, max: 30 },
  { label: '30-40', min: 30, max: 40 },
  { label: '40-50', min: 40, max: 50 },
  { label: '50+', min: 50, max: Infinity },
];
const sensBucketCounts = sensBuckets.map(b => ({
  ...b,
  count: allCm360Values.filter(v => v >= b.min && v < b.max).length,
  isPlayer: currentCm360 >= b.min && currentCm360 < b.max,
}));
const maxBucketCount = Math.max(...sensBucketCounts.map(b => b.count), 1);

// Similar sensitivity players for insights (reuse existing but need full list for display)
const similarSensInsight = otherPlayers
  .filter(pl => pl.data.published !== false)
  .map(pl => ({ player: pl, cm360: calculateCm360(pl.data) }))
  .filter(({ cm360 }) => cm360 > 0 && currentCm360 > 0 && Math.abs(cm360 - currentCm360) / currentCm360 <= 0.15)
  .sort((a, b) => Math.abs(a.cm360 - currentCm360) - Math.abs(b.cm360 - currentCm360))
  .slice(0, 5);

// Mouse popularity
const mouseCounts: Record<string, { count: number; name: string; players: typeof allPlayers }> = {};
for (const pl of publishedPlayers) {
  const m = pl.data.mouse;
  if (!m) continue;
  if (!mouseCounts[m]) {
    const mData = miceMap.get(m);
    mouseCounts[m] = { count: 0, name: mData?.name || m, players: [] };
  }
  mouseCounts[m].count++;
  mouseCounts[m].players.push(pl);
}
const mouseRanking = Object.entries(mouseCounts)
  .sort((a, b) => b[1].count - a[1].count);
const playerMouseEntry = p.mouse ? mouseCounts[p.mouse] : null;
const mouseRank = p.mouse ? mouseRanking.findIndex(([key]) => key === p.mouse) + 1 : 0;
const mouseUsersOther = playerMouseEntry
  ? playerMouseEntry.players.filter(pl => pl.id !== player.id).slice(0, 8)
  : [];

// FOV context
const allFovValues = publishedPlayers.map(pl => pl.data.fov).filter((v): v is number => v != null && v > 0);
function getFovCategory(fov: number): string {
  if (fov < 100) return 'Narrow';
  if (fov <= 110) return 'Average range';
  return 'Wide';
}
const fovPercentile = p.fov && allFovValues.length > 0
  ? Math.round(allFovValues.filter(v => v < p.fov!).length / allFovValues.length * 100)
  : null;

// Resolution context (from monitor data)
const allResolutions: Record<string, number> = {};
for (const pl of publishedPlayers) {
  const mon = pl.data.monitor ? monitorsMap.get(pl.data.monitor) : null;
  if (mon?.resolution) {
    allResolutions[mon.resolution] = (allResolutions[mon.resolution] || 0) + 1;
  }
}
const playerResolution = monitorData?.resolution || null;
const resolutionRank = playerResolution
  ? Object.entries(allResolutions).sort((a, b) => b[1] - a[1]).findIndex(([r]) => r === playerResolution) + 1
  : 0;

// Refresh rate context (from monitor data)
const allRefreshRates: Record<string, number> = {};
for (const pl of publishedPlayers) {
  const mon = pl.data.monitor ? monitorsMap.get(pl.data.monitor) : null;
  if (mon?.refreshRate) {
    allRefreshRates[mon.refreshRate] = (allRefreshRates[mon.refreshRate] || 0) + 1;
  }
}
const playerRefresh = monitorData?.refreshRate || null;
function getRefreshCategory(rr: string): string {
  const n = parseInt(rr);
  if (isNaN(n)) return '';
  if (n <= 144) return 'Standard';
  if (n <= 240) return 'High';
  return 'Elite';
}

// Setup insights visibility: show if player has at least sensitivity data
const hasInsights = hasSettings && currentCm360 > 0;

const schema = {
  "@context": "https://schema.org",
  "@type": "ProfilePage",
  "mainEntity": {
    "@type": "Person",
    "name": p.name,
    ...(p.country && { "nationality": p.country }),
    "url": `https://stripyq.github.io/quakesettings/players/${player.id}/`,
    ...(p.steamId && { "sameAs": [`https://steamcommunity.com/profiles/${p.steamId}`] })
  }
};
---

<BaseLayout title={p.name} description={`${p.name}'s Quake Live settings and hardware. DPI, sensitivity, crosshair, keybinds, mouse, keyboard, and monitor.`} schema={schema} ogImage="/images/og/player.jpg">
  <div class="player-page">
    <div class="player-header">
      <h1>{p.name}</h1>
      <div class="player-ratings-display">
        <div class="rating-item">
          <span class="rating-label">Duel:</span>
          <div class="rating-value-container">
            <span class="rating-value duel">{formatRating(p.duelRating, 'duel')}</span>
            {p.duelGames > 0 && <span class="game-count">{p.duelGames} {p.duelGames === 1 ? 'game' : 'games'}</span>}
          </div>
        </div>
        <div class="rating-item">
          <span class="rating-label">CTF:</span>
          <div class="rating-value-container">
            <span class="rating-value ctf">{formatRating(p.ctfRating, 'ctf')}</span>
            {p.ctfGames > 0 && <span class="game-count">{p.ctfGames} {p.ctfGames === 1 ? 'game' : 'games'}</span>}
          </div>
        </div>
        <div class="rating-item">
          <span class="rating-label">TDM:</span>
          <div class="rating-value-container">
            <span class="rating-value tdm">{formatRating(p.tdmRating, 'tdm')}</span>
            {p.tdmGames > 0 && <span class="game-count">{p.tdmGames} {p.tdmGames === 1 ? 'game' : 'games'}</span>}
          </div>
        </div>
        {p.qllrCtfRating && (
          <div class="rating-item">
            <span class="rating-label">CSQL:</span>
            <div class="rating-value-container">
              <a href={`https://qllr.xyz/player/${p.steamId}`} target="_blank" rel="noopener noreferrer" class="rating-value csql">{p.qllrCtfRating.toFixed(1)}</a>
            </div>
          </div>
        )}
      </div>
      <p class="ratings-disclaimer">Not real-time · Updated periodically</p>

      <div class="player-meta">
        {p.dataSource === 'player' && <span class="data-source source-player" title="Settings self-submitted by the player">Submitted</span>}
        {p.dataSource === 'verified' && <span class="data-source source-verified" title="Settings verified by the player">✓ Verified</span>}
        {(!p.dataSource || p.dataSource === 'collected') && <span class="data-source source-collected" title="Settings collected from public sources">Collected</span>}
      </div>

      <div class="player-actions">
        <a href={`${base}compare/?p1=${player.id}`} class="compare-btn">Compare with another player</a>
      </div>
    </div>

    <!-- Settings Cards -->
    <div class="settings-grid">
      <!-- Mouse Settings -->
      <section class="settings-section">
        <h2>Mouse Settings</h2>
        <table class="settings-table">
          <tbody>
            <tr><td>DPI</td><td>{p.dpi}</td></tr>
            <tr><td>In-game Sensitivity</td><td>{p.sensitivity}</td></tr>
            <tr><td>eDPI</td><td>{p.edpi}</td></tr>
            <tr><td>cm/360</td><td>{formatNum(currentCm360)}</td></tr>
            {p.grip && <tr><td>Grip Style</td><td>{p.grip}</td></tr>}
            <tr><td>Mouse Acceleration</td><td>{p.acceleration ? 'On' : 'Off'}</td></tr>
            {p.acceleration && p.accelValue != null && (
              <tr><td class="sub-setting">Raw Value</td><td>{p.accelValue}</td></tr>
            )}
            {p.acceleration && realAccel != null && (
              <tr><td class="sub-setting"><span class="real-accel-label">Real Accel <span class="tooltip" title="Real Accel normalizes acceleration across different DPI settings, allowing direct comparison between players. Assumes cl_mouseAccelStyle 0 (default).">?</span></span></td><td>{formatNum(realAccel)}</td></tr>
            )}
            {p.acceleration && p.accelValue != null && realAccel == null && !p.dpi && (
              <tr><td class="sub-setting">Real Accel</td><td class="text-muted">Needs DPI</td></tr>
            )}
            {p.acceleration && p.accelStyle != null && (
              <tr><td class="sub-setting">Style</td><td>{p.accelStyle}</td></tr>
            )}
            {p.acceleration && p.accelOffset != null && (
              <tr><td class="sub-setting">Offset</td><td>{p.accelOffset}</td></tr>
            )}
            <tr><td>Raw Input</td><td>{p.rawInput ? 'On' : 'Off'}</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Game Settings -->
      <section class="settings-section">
        <h2>Game Settings</h2>
        <table class="settings-table">
          <tbody>
            <tr><td>FOV</td><td>{p.fov}</td></tr>
            <tr><td>Crosshair</td><td>{p.crosshair}</td></tr>
            <tr><td>Crosshair Size</td><td>{p.crosshairSize || 'N/A'}</td></tr>
            <tr><td>Inverted Mouse</td><td>{p.invertedMouse ? 'Yes' : 'No'}</td></tr>
          </tbody>
        </table>
      </section>
    </div>

    <section class="hardware-full-section">
      <h2>Hardware</h2>
      <div class="hardware-items-grid">
        {mouseData && (
          <div class="hardware-item">
            <h3>Mouse</h3>
            <p class="hardware-name">{mouseData.name}</p>
            <table class="hardware-specs">
              <tr><td>Brand</td><td>{mouseData.brand}</td></tr>
              <tr><td>Weight</td><td>{mouseData.weight}</td></tr>
              <tr><td>Shape</td><td>{mouseData.shape}</td></tr>
              <tr><td>Sensor</td><td>{mouseData.sensor}</td></tr>
              <tr><td>Connection</td><td>{mouseData.connection}</td></tr>
            </table>
          </div>
        )}

        {mousepadData && (
          <div class="hardware-item">
            <h3>Mousepad</h3>
            <p class="hardware-name">{mpDisplayName}</p>
            <table class="hardware-specs">
              <tr><td>Surface</td><td>{mousepadData.surface}</td></tr>
              <tr><td>Speed</td><td>{mousepadData.speed || mousepadData.speedType || 'N/A'}</td></tr>
              {hasMousepadVariant ? (
                <>
                  {mpBaseDisplay && <tr><td>Base</td><td>{mpBaseDisplay}</td></tr>}
                  {p.mousepadSize && <tr><td>Size</td><td>{p.mousepadSize}</td></tr>}
                </>
              ) : (
                <tr><td>Dimensions</td><td>{mousepadData.dimensions || mousepadData.size || 'N/A'}</td></tr>
              )}
            </table>
          </div>
        )}

        {keyboardData && (
          <div class="hardware-item">
            <h3>Keyboard</h3>
            <p class="hardware-name">{keyboardData.name}</p>
            <table class="hardware-specs">
              <tr><td>Size</td><td>{keyboardData.size || keyboardData.format || 'N/A'}</td></tr>
              <tr><td>Switches</td><td>{keyboardData.switches}</td></tr>
              <tr><td>Connection</td><td>{keyboardData.connection}</td></tr>
            </table>
          </div>
        )}

        {monitorData && (
          <div class="hardware-item">
            <h3>Monitor</h3>
            <p class="hardware-name">{monitorData.name}</p>
            <table class="hardware-specs">
              <tr><td>Size</td><td>{monitorData.size}</td></tr>
              <tr><td>Refresh Rate</td><td>{monitorData.refreshRate}</td></tr>
              <tr><td>Panel</td><td>{monitorData.panelType || monitorData.panel || 'N/A'}</td></tr>
              <tr><td>Resolution</td><td>{monitorData.resolution}</td></tr>
            </table>
          </div>
        )}

        {headsetData && (
          <div class="hardware-item">
            <h3>Headset</h3>
            <p class="hardware-name">{headsetData.name}</p>
            <table class="hardware-specs">
              <tr><td>Type</td><td>{headsetData.type}</td></tr>
              <tr><td>Driver Size</td><td>{headsetData.driverSize || headsetData.driver || 'N/A'}</td></tr>
              <tr><td>Connection</td><td>{headsetData.connection}</td></tr>
            </table>
          </div>
        )}
      </div>
    </section>

    <!-- Setup Insights -->
    {hasInsights && (
      <section class="insights-section">
        <h2>Setup Insights</h2>

        <div class="insights-grid">
          {/* Sensitivity Context */}
          <div class="insight-card">
            <h3>Sensitivity Context</h3>
            <div class="insight-sens-value">
              <span class="insight-big-num">{formatNum(currentCm360)}</span>
              <span class="insight-unit">cm/360</span>
              <span class="insight-category">{getSensCategory(currentCm360)}</span>
            </div>
            {fasterThanPct !== null && (
              <p class="insight-percentile">Faster than <strong>{fasterThanPct}%</strong> of players</p>
            )}
            <div class="sens-distribution">
              {sensBucketCounts.map(b => (
                <div class="sens-bucket">
                  <div class="sens-bar-container">
                    <div
                      class={`sens-bar ${b.isPlayer ? 'sens-bar-active' : ''}`}
                      style={`height: ${Math.max((b.count / maxBucketCount) * 100, 4)}%`}
                    >
                      {b.count > 0 && <span class="sens-bar-count">{b.count}</span>}
                    </div>
                  </div>
                  <span class={`sens-bucket-label ${b.isPlayer ? 'sens-bucket-active' : ''}`}>{b.label}</span>
                </div>
              ))}
            </div>
            {similarSensInsight.length > 0 && (
              <div class="insight-similar">
                <span class="insight-similar-label">Similar sensitivity:</span>
                {similarSensInsight.map((s, i) => (
                  <Fragment>
                    {i > 0 && <span class="insight-sep">&middot;</span>}
                    <a href={`${base}players/${s.player.id}/`} class="insight-player-link">
                      {s.player.data.name} <span class="insight-player-stat">({formatNum(s.cm360)})</span>
                    </a>
                  </Fragment>
                ))}
              </div>
            )}
          </div>

          {/* Mouse Popularity */}
          {playerMouseEntry && mouseData && (
            <div class="insight-card">
              <h3>Mouse Popularity</h3>
              <p class="insight-mouse-name">{mouseData.name}</p>
              <p class="insight-mouse-count">
                Used by <strong>{playerMouseEntry.count}</strong> {playerMouseEntry.count === 1 ? 'player' : 'players'}
                {mouseRank > 0 && (
                  <span class="insight-mouse-rank">
                    &mdash; #{mouseRank} most popular
                  </span>
                )}
              </p>
              {mouseUsersOther.length > 0 && (
                <div class="insight-similar">
                  <span class="insight-similar-label">Also used by:</span>
                  {mouseUsersOther.map((pl, i) => (
                    <Fragment>
                      {i > 0 && <span class="insight-sep">&middot;</span>}
                      <a href={`${base}players/${pl.id}/`} class="insight-player-link">{pl.data.name}</a>
                    </Fragment>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Setup Profile */}
          <div class="insight-card insight-profile">
            <h3>Setup Profile</h3>
            <table class="insight-profile-table">
              <tr>
                <td>Sensitivity</td>
                <td class="insight-profile-val">{formatNum(currentCm360)} cm/360</td>
                <td class="insight-profile-ctx">{getSensCategory(currentCm360)}</td>
              </tr>
              {p.fov && (
                <tr>
                  <td>FOV</td>
                  <td class="insight-profile-val">{p.fov}</td>
                  <td class="insight-profile-ctx">{getFovCategory(p.fov)}{fovPercentile !== null && ` (top ${100 - fovPercentile}%)`}</td>
                </tr>
              )}
              {playerResolution && (
                <tr>
                  <td>Resolution</td>
                  <td class="insight-profile-val">{playerResolution}</td>
                  <td class="insight-profile-ctx">{resolutionRank === 1 ? 'Most common' : resolutionRank > 0 ? `#${resolutionRank} most common` : ''}</td>
                </tr>
              )}
              {playerRefresh && (
                <tr>
                  <td>Refresh Rate</td>
                  <td class="insight-profile-val">{playerRefresh}</td>
                  <td class="insight-profile-ctx">{getRefreshCategory(playerRefresh)}</td>
                </tr>
              )}
              {p.dpi && (
                <tr>
                  <td>DPI</td>
                  <td class="insight-profile-val">{p.dpi}</td>
                  <td class="insight-profile-ctx"></td>
                </tr>
              )}
            </table>
          </div>
        </div>
      </section>
    )}

    <!-- Key Bindings -->
    <section class="keybinds-section">
      <h2>Key Bindings</h2>
      <div class="keybinds-compact">
        <div class="keybind-row">
          <span class="keybind-label">Forward</span><kbd>{p.forward}</kbd>
        </div>
        <div class="keybind-row">
          <span class="keybind-label">Back</span><kbd>{p.back}</kbd>
        </div>
        <div class="keybind-row">
          <span class="keybind-label">Left</span><kbd>{p.left}</kbd>
        </div>
        <div class="keybind-row">
          <span class="keybind-label">Right</span><kbd>{p.right}</kbd>
        </div>
        <div class="keybind-row">
          <span class="keybind-label">Jump</span><kbd>{p.jump}</kbd>
        </div>
        <div class="keybind-row">
          <span class="keybind-label">Crouch</span><kbd>{p.crouch}</kbd>
        </div>
        <div class="keybind-row">
          <span class="keybind-label">Attack</span><kbd>{p.attack}</kbd>
        </div>
        <div class="keybind-row">
          <span class="keybind-label">Zoom</span><kbd>{p.zoom}</kbd>
        </div>
        {p.weaponNext && (
          <div class="keybind-row">
            <span class="keybind-label">Next Weapon</span><kbd>{p.weaponNext}</kbd>
          </div>
        )}
        {p.weaponPrev && (
          <div class="keybind-row">
            <span class="keybind-label">Prev Weapon</span><kbd>{p.weaponPrev}</kbd>
          </div>
        )}
      </div>
    </section>

    <!-- Similar Players -->
    {(similarSens.length > 0 || sameMouse.length > 0 || sameMonitor.length > 0 || sameKeyboard.length > 0 || sameMousepad.length > 0) && (
      <section class="similar-section">
        <h2>Similar Players</h2>
        <div class="similar-groups">
          {similarSens.length > 0 && (
            <div class="similar-group">
              <h3>Similar Sensitivity <span class="similar-info">(cm/360: {formatNum(currentCm360)})</span></h3>
              <div class="similar-players">
                {similarSens.map(({ player: pl, cm360 }) => (
                  <a
                    href={`${base}players/${pl.id}/`}
                    class={`similar-player ${pl.data.acceleration ? 'has-accel' : ''}`}
                    title={pl.data.acceleration ? 'This player uses mouse acceleration — base sensitivity shown' : undefined}
                  >
                    <span class="player-name">{pl.data.name}</span>
                    <span class="player-stat">{formatNum(cm360)} cm/360</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          {sameMouse.length > 0 && (
            <div class="similar-group">
              <h3>Same Mouse <span class="similar-info">({mouseData?.name})</span></h3>
              <div class="similar-players">
                {sameMouse.map(pl => (
                  <a href={`${base}players/${pl.id}/`} class="similar-player">
                    <span class="player-name">{pl.data.name}</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          {sameMousepad.length > 0 && (
            <div class="similar-group">
              <h3>Same Mousepad <span class="similar-info">({mousepadData?.name})</span></h3>
              <div class="similar-players">
                {sameMousepad.map(pl => (
                  <a href={`${base}players/${pl.id}/`} class="similar-player">
                    <span class="player-name">{pl.data.name}</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          {sameKeyboard.length > 0 && (
            <div class="similar-group">
              <h3>Same Keyboard <span class="similar-info">({keyboardData?.name})</span></h3>
              <div class="similar-players">
                {sameKeyboard.map(pl => (
                  <a href={`${base}players/${pl.id}/`} class="similar-player">
                    <span class="player-name">{pl.data.name}</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          {sameMonitor.length > 0 && (
            <div class="similar-group">
              <h3>Same Monitor <span class="similar-info">({monitorData?.name})</span></h3>
              <div class="similar-players">
                {sameMonitor.map(pl => (
                  <a href={`${base}players/${pl.id}/`} class="similar-player">
                    <span class="player-name">{pl.data.name}</span>
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      </section>
    )}

    <!-- HoQ Stats -->
    {hasHoqStats && (
      <section class="hoq-section">
        <div class="hoq-header">
          <h2>Playstyle</h2>
          {p.steamId && (
            <span class="hoq-attr">Stats via <a href={`http://88.214.20.58/player/${p.steamId}`} target="_blank" rel="noopener">HoQ</a></span>
          )}
        </div>
        <div class="hoq-grid">
          <div class="hoq-favorites">
            <table class="settings-table">
              {p.favorite_map && <tr><td>Favorite Map</td><td>{p.favorite_map}</td></tr>}
              {p.favorite_gametype && <tr><td>Favorite Gametype</td><td>{p.favorite_gametype}</td></tr>}
              {p.favorite_weapon && <tr><td>Favorite Weapon</td><td>{p.favorite_weapon}</td></tr>}
            </table>
          </div>
          {(p.accuracy_rl != null || p.accuracy_lg != null || p.accuracy_rg != null) && (
            <div class="hoq-accuracy">
              <h3>Weapon Accuracy</h3>
              <div class="acc-bars">
                {p.accuracy_rl != null && (
                  <div class="acc-row">
                    <span class="acc-icon" title="Rocket Launcher">&#128640;</span>
                    <span class="acc-label">RL</span>
                    <div class="acc-track">
                      <div class="acc-fill acc-fill-rl" style={`width: ${p.accuracy_rl}%`}></div>
                      <div class="acc-avg-marker" style={`left: ${avgAccuracy.rl}%`} title={`Player average: ${avgAccuracy.rl}%`}></div>
                    </div>
                    <span class="acc-value">{p.accuracy_rl}%</span>
                  </div>
                )}
                {p.accuracy_lg != null && (
                  <div class="acc-row">
                    <span class="acc-icon" title="Lightning Gun">&#9889;</span>
                    <span class="acc-label">LG</span>
                    <div class="acc-track">
                      <div class="acc-fill acc-fill-lg" style={`width: ${p.accuracy_lg}%`}></div>
                      <div class="acc-avg-marker" style={`left: ${avgAccuracy.lg}%`} title={`Player average: ${avgAccuracy.lg}%`}></div>
                    </div>
                    <span class="acc-value">{p.accuracy_lg}%</span>
                  </div>
                )}
                {p.accuracy_rg != null && (
                  <div class="acc-row">
                    <span class="acc-icon" title="Railgun">&#127919;</span>
                    <span class="acc-label">RG</span>
                    <div class="acc-track">
                      <div class="acc-fill acc-fill-rg" style={`width: ${p.accuracy_rg}%`}></div>
                      <div class="acc-avg-marker" style={`left: ${avgAccuracy.rg}%`} title={`Player average: ${avgAccuracy.rg}%`}></div>
                    </div>
                    <span class="acc-value">{p.accuracy_rg}%</span>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      </section>
    )}

    <!-- Season Stats (HoQ 2026 S1) - per mode -->
    {[
      { mode: 'CTF', display: ctfDisplay, arrays: ctfArrays, showFlags: true },
      { mode: 'TDM', display: tdmDisplay, arrays: tdmArrays, showFlags: false },
    ].map(({ mode, display, arrays, showFlags }) => display && (display.career || display.weapons?.length > 0) && (() => {
      const c = display.career;
      const w = display.weapons;
      const fd = display.flagData;
      const nd = display.nemesisData;
      const vd = display.victimData;
      const maps = display.mapStatsArray;
      const hasRiv = !!(nd || vd);
      const nName = getRegistryName(nd?.opponent_steam_id) || nd?.opponent_name;
      const vName = getRegistryName(vd?.opponent_steam_id) || vd?.opponent_name;
      const nSlug = getRivalrySlug(nd?.opponent_steam_id);
      const vSlug = getRivalrySlug(vd?.opponent_steam_id);
      return (
      <section class="season-section">
        <div class="season-header">
          <h2>{mode} Season Stats (2026 S1)</h2>
          <span class="season-attr">Data via <a href="http://92.112.126.106/#dashboard" target="_blank" rel="noopener">HoQ Season Tracker</a></span>
        </div>

        <div class="season-grid">
          {c && (
            <div class="season-career">
              <div class="stat-rows">
                {c.matches_played != null && (() => {
                  const pct = getPercentile(c.matches_played, arrays.games);
                  return (
                    <div class="stat-row">
                      <span class="stat-label">Games</span>
                      <span class="stat-value">{c.matches_played}</span>
                      <div class="stat-bar-wrap">
                        <div class="stat-bar-track">
                          <div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div>
                        </div>
                      </div>
                      <span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span>
                      <span class="stat-avg">avg: {formatAvg(average(arrays.games))}</span>
                    </div>
                  );
                })()}
                {c.win_rate != null && (() => {
                  const pct = getPercentile(c.win_rate, arrays.winRate);
                  return (
                    <div class="stat-row">
                      <span class="stat-label">Win Rate</span>
                      <span class="stat-value">{c.win_rate}%</span>
                      <div class="stat-bar-wrap">
                        <div class="stat-bar-track">
                          <div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div>
                        </div>
                      </div>
                      <span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span>
                      <span class="stat-avg">avg: {formatAvg(average(arrays.winRate))}%</span>
                    </div>
                  );
                })()}
                {c.kd_ratio != null && (() => {
                  const pct = getPercentile(c.kd_ratio, arrays.kd);
                  return (
                    <div class="stat-row">
                      <span class="stat-label">K/D</span>
                      <span class="stat-value">{c.kd_ratio.toFixed(2)}</span>
                      <div class="stat-bar-wrap">
                        <div class="stat-bar-track">
                          <div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div>
                        </div>
                      </div>
                      <span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span>
                      <span class="stat-avg">avg: {formatAvg(average(arrays.kd), 2)}</span>
                    </div>
                  );
                })()}
                {c.total_kills != null && (() => {
                  const pct = getPercentile(c.total_kills, arrays.kills);
                  return (
                    <div class="stat-row">
                      <span class="stat-label">Kills</span>
                      <span class="stat-value">{c.total_kills}</span>
                      <div class="stat-bar-wrap">
                        <div class="stat-bar-track">
                          <div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div>
                        </div>
                      </div>
                      <span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span>
                      <span class="stat-avg">avg: {formatAvg(average(arrays.kills))}</span>
                    </div>
                  );
                })()}
                {c.total_deaths != null && (() => {
                  const pct = getPercentile(c.total_deaths, arrays.deaths, false);
                  return (
                    <div class="stat-row">
                      <span class="stat-label">Deaths</span>
                      <span class="stat-value">{c.total_deaths}</span>
                      <div class="stat-bar-wrap">
                        <div class="stat-bar-track">
                          <div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div>
                        </div>
                      </div>
                      <span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span>
                      <span class="stat-avg">avg: {formatAvg(average(arrays.deaths))}</span>
                    </div>
                  );
                })()}
                {c.damage_per_minute != null && (c.damage_per_minute > 0 || average(arrays.dpm) > 0) && (() => {
                  const pct = getPercentile(c.damage_per_minute, arrays.dpm);
                  return (
                    <div class="stat-row">
                      <span class="stat-label">DPM</span>
                      <span class="stat-value">{Math.round(c.damage_per_minute)}</span>
                      <div class="stat-bar-wrap">
                        <div class="stat-bar-track">
                          <div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div>
                        </div>
                      </div>
                      <span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span>
                      <span class="stat-avg">avg: {formatAvg(average(arrays.dpm))}</span>
                    </div>
                  );
                })()}
                {c.max_streak != null && (c.max_streak > 0 || average(arrays.streak) > 0) && (() => {
                  const pct = getPercentile(c.max_streak, arrays.streak);
                  return (
                    <div class="stat-row">
                      <span class="stat-label">Best Streak</span>
                      <span class="stat-value">{c.max_streak}</span>
                      <div class="stat-bar-wrap">
                        <div class="stat-bar-track">
                          <div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div>
                        </div>
                      </div>
                      <span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span>
                      <span class="stat-avg">avg: {formatAvg(average(arrays.streak))}</span>
                    </div>
                  );
                })()}
              </div>
            </div>
          )}

          {w?.length > 0 && (() => {
            const rg = getWeapon(w, 'RAILGUN');
            const rl = getWeapon(w, 'ROCKET_LAUNCHER');
            const lg = getWeapon(w, 'LIGHTNING_GUN');
            const sg = getWeapon(w, 'SHOTGUN');
            const mg = getWeapon(w, 'MACHINEGUN');
            const pg = getWeapon(w, 'PLASMA_GUN');
            const gl = getWeapon(w, 'GRENADE_LAUNCHER');
            return (
            <div class="season-weapons">
              <h3>Weapon Accuracy</h3>
              <table class="settings-table">
                {rg && (<tr><td>&#127919; Railgun</td><td>{rg.accuracy}%</td><td class="text-muted">{rg.kills} kills</td></tr>)}
                {rl && (<tr><td>&#128640; Rocket</td><td>{rl.accuracy}%</td><td class="text-muted">{rl.kills} kills</td></tr>)}
                {lg && (<tr><td>&#9889; Lightning Gun</td><td>{lg.accuracy}%</td><td class="text-muted">{lg.kills} kills</td></tr>)}
                {sg && (<tr><td>&#128299; Shotgun</td><td>{sg.accuracy}%</td><td class="text-muted">{sg.kills} kills</td></tr>)}
                {mg && (<tr><td>&#9881; Machine Gun</td><td>{mg.accuracy}%</td><td class="text-muted">{mg.kills} kills</td></tr>)}
                {pg && (<tr><td>&#128154; Plasma</td><td>{pg.accuracy}%</td><td class="text-muted">{pg.kills} kills</td></tr>)}
                {gl && (<tr><td>&#128163; Grenade</td><td>{gl.accuracy}%</td><td class="text-muted">{gl.kills} kills</td></tr>)}
              </table>
            </div>
            );
          })()}

          {showFlags && fd && (
            <div class="season-flags">
              <h3>Flag Stats</h3>
              <div class="stat-rows">
                {fd.captures != null && (fd.captures > 0 || average(arrays.captures) > 0) && (() => {
                  const pct = getPercentile(fd.captures, arrays.captures);
                  return (<div class="stat-row"><span class="stat-label">Captures</span><span class="stat-value">{fd.captures}</span><div class="stat-bar-wrap"><div class="stat-bar-track"><div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div></div></div><span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span><span class="stat-avg">avg: {formatAvg(average(arrays.captures))}</span></div>);
                })()}
                {fd.returns != null && (fd.returns > 0 || average(arrays.returns) > 0) && (() => {
                  const pct = getPercentile(fd.returns, arrays.returns);
                  return (<div class="stat-row"><span class="stat-label">Returns</span><span class="stat-value">{fd.returns}</span><div class="stat-bar-wrap"><div class="stat-bar-track"><div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div></div></div><span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span><span class="stat-avg">avg: {formatAvg(average(arrays.returns))}</span></div>);
                })()}
                {fd.pickups != null && (fd.pickups > 0 || average(arrays.pickups) > 0) && (() => {
                  const pct = getPercentile(fd.pickups, arrays.pickups);
                  return (<div class="stat-row"><span class="stat-label">Pickups</span><span class="stat-value">{fd.pickups}</span><div class="stat-bar-wrap"><div class="stat-bar-track"><div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div></div></div><span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span><span class="stat-avg">avg: {formatAvg(average(arrays.pickups))}</span></div>);
                })()}
                {fd.defends != null && (fd.defends > 0 || average(arrays.defends) > 0) && (() => {
                  const pct = getPercentile(fd.defends, arrays.defends);
                  return (<div class="stat-row"><span class="stat-label">Defends</span><span class="stat-value">{fd.defends}</span><div class="stat-bar-wrap"><div class="stat-bar-track"><div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div></div></div><span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span><span class="stat-avg">avg: {formatAvg(average(arrays.defends))}</span></div>);
                })()}
                {fd.assists != null && (fd.assists > 0 || average(arrays.assists) > 0) && (() => {
                  const pct = getPercentile(fd.assists, arrays.assists);
                  return (<div class="stat-row"><span class="stat-label">Assists</span><span class="stat-value">{fd.assists}</span><div class="stat-bar-wrap"><div class="stat-bar-track"><div class={`stat-bar-fill ${pctClass(pct)}-bg`} style={`width: ${100 - pct}%`}></div></div></div><span class={`stat-pct ${pctClass(pct)}`}>Top {pct}%</span><span class="stat-avg">avg: {formatAvg(average(arrays.assists))}</span></div>);
                })()}
              </div>
            </div>
          )}

          {hasRiv && (
            <div class="season-rivalries">
              <h3>Rivalries</h3>
              <div class="rivalry-cards">
                {nd && (
                  <div class="rivalry-card rivalry-nemesis">
                    <span class="rivalry-icon">&#128520;</span>
                    <div class="rivalry-info">
                      <span class="rivalry-label">Nemesis</span>
                      {nSlug ? (
                        <a href={`${base}players/${nSlug}/`} class="rivalry-name">{nName}</a>
                      ) : (
                        <span class="rivalry-name">{nName}</span>
                      )}
                      <span class="rivalry-detail">
                        {nd.kills_against != null && nd.deaths_to != null
                          ? `${nd.kills_against}-${nd.deaths_to}`
                          : nd.deaths_to != null
                            ? `died ${nd.deaths_to} times`
                            : ''}
                        {nd.kd_ratio != null && ` (${nd.kd_ratio.toFixed(2)} K/D)`}
                        {nd.matches_together != null && ` · ${nd.matches_together} ${nd.matches_together === 1 ? 'game' : 'games'}`}
                      </span>
                    </div>
                  </div>
                )}
                {vd && (
                  <div class="rivalry-card rivalry-victim">
                    <span class="rivalry-icon">&#128526;</span>
                    <div class="rivalry-info">
                      <span class="rivalry-label">Favorite Victim</span>
                      {vSlug ? (
                        <a href={`${base}players/${vSlug}/`} class="rivalry-name">{vName}</a>
                      ) : (
                        <span class="rivalry-name">{vName}</span>
                      )}
                      <span class="rivalry-detail">
                        {vd.kills_against != null && vd.deaths_to != null
                          ? `${vd.kills_against}-${vd.deaths_to}`
                          : vd.kills_against != null
                            ? `killed ${vd.kills_against} times`
                            : ''}
                        {vd.kd_ratio != null && ` (${vd.kd_ratio.toFixed(2)} K/D)`}
                        {vd.matches_together != null && ` · ${vd.matches_together} ${vd.matches_together === 1 ? 'game' : 'games'}`}
                      </span>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {maps.length > 0 && (
            <div class="season-maps">
              <h3>Map Performance</h3>
              <table class="settings-table map-stats-table">
                <thead>
                  <tr>
                    <th>Map</th>
                    <th>Games</th>
                    <th>Win%</th>
                    <th>K/D</th>
                    <th>DPM</th>
                  </tr>
                </thead>
                <tbody>
                  {maps.map(m => (
                    <tr>
                      <td>{m.map}</td>
                      <td>{m.matches}</td>
                      <td class={m.win_rate >= 50 ? 'stat-good' : 'stat-bad'}>{m.win_rate}%</td>
                      <td class={m.kd_ratio >= 1 ? 'stat-good' : 'stat-bad'}>{m.kd_ratio.toFixed(2)}</td>
                      <td>{Math.round(m.dpm)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>
      );
    })())}

    <!-- Race Stats (qlrace.com) -->
    {p.qlrace && p.qlrace.records > 0 && (() => {
      const r = p.qlrace;
      const modeLabel = r.mode === 2 ? 'VQL Weapons' : 'VQL Strafe';
      const totalMedals = r.medals.gold + r.medals.silver + r.medals.bronze;
      function fmtRaceTime(ms: number) {
        const totalSec = ms / 1000;
        const min = Math.floor(totalSec / 60);
        const sec = totalSec % 60;
        return min + ':' + (sec < 10 ? '0' : '') + sec.toFixed(3);
      }
      return (
      <section class="season-section race-section">
        <div class="season-header">
          <h2>Race ({modeLabel})</h2>
          <span class="season-attr">Data via <a href={`https://qlrace.com/player/${p.steamId}`} target="_blank" rel="noopener">qlrace.com</a></span>
        </div>

        <div class="race-grid">
          <div class="race-stats">
            <div class="race-stat-row">
              <span class="race-label">Records</span>
              <span class="race-value">{r.records} records{r.wrs > 0 ? `, ${r.wrs} WR${r.wrs > 1 ? 's' : ''}` : ''}</span>
            </div>

            {totalMedals > 0 && (
              <div class="race-stat-row">
                <span class="race-label">Medals</span>
                <span class="race-value race-medals">
                  {r.medals.gold > 0 && <span class="race-medal race-gold">{r.medals.gold}</span>}
                  {r.medals.silver > 0 && <span class="race-medal race-silver">{r.medals.silver}</span>}
                  {r.medals.bronze > 0 && <span class="race-medal race-bronze">{r.medals.bronze}</span>}
                </span>
              </div>
            )}

            {r.best_record && (
              <div class="race-stat-row">
                <span class="race-label">Best Record</span>
                <span class="race-value">Rank {r.best_record.rank}/{r.best_record.total} on <span class="race-map">{r.best_record.map}</span> <span class="race-pct">(top {r.best_record.rank_pct}%)</span>{r.best_record.map === p.favorite_map && <span class="race-fav-match"> — also their favorite map!</span>}</span>
              </div>
            )}

            {r.best_record?.time && (
              <div class="race-stat-row">
                <span class="race-label">Best Time</span>
                <span class="race-value race-time">{fmtRaceTime(r.best_record.time)}</span>
              </div>
            )}

            {r.speed_top != null && (
              <div class="race-stat-row">
                <span class="race-label">Top Speed</span>
                <span class="race-value">{Math.round(r.speed_top)} ups</span>
              </div>
            )}

            {r.average_rank_pct != null && (
              <div class="race-stat-row">
                <span class="race-label">Avg Rank %</span>
                <span class="race-value">{r.average_rank_pct}% <span class="race-hint">(lower = better)</span></span>
              </div>
            )}
          </div>

          {r.top_maps && r.top_maps.length > 0 && (
            <div class="race-top-maps">
              <h3>Top Maps</h3>
              <table class="race-maps-table">
                <thead>
                  <tr>
                    <th>Map</th>
                    <th>Rank</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody>
                  {r.top_maps.map(m => (
                    <tr>
                      <td class="race-map">{m.map}</td>
                      <td>{m.rank}/{m.total}</td>
                      <td class="race-time">{fmtRaceTime(m.time)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>
      );
    })()}

    <!-- Config Download -->
    {p.configFile && (
      <section class="config-section">
        <h2>Config File</h2>
        <a href={`${base}${p.configFile.replace(/^\//, '')}`} download class="download-btn">
          Download {p.name}'s Config
        </a>
      </section>
    )}

    <!-- Data Source -->
    {(p.source || p.lastUpdated || ctfStats || tdmStats || p.qlrace) && (
      <section class="source-section">
        <h2>Data Source</h2>
        <div class="source-info">
          {p.source && <p><strong>Source:</strong> {p.sourceUrl ? <a href={p.sourceUrl} target="_blank" rel="noopener">{p.source}</a> : p.source}</p>}
          {p.lastUpdated && <p><strong>Settings:</strong> Last updated {p.lastUpdated}</p>}
          {(ctfStats || tdmStats) && <p><strong>Season Stats:</strong> Live from <a href="http://92.112.126.106/#dashboard" target="_blank" rel="noopener">HoQ Season Tracker</a></p>}
          {p.qlrace && <p><strong>Race Data:</strong> From <a href={`https://qlrace.com/player/${p.steamId}`} target="_blank" rel="noopener">qlrace.com</a>{p.qlrace.fetched_at ? ` (${p.qlrace.fetched_at})` : ''}</p>}
        </div>
      </section>
    )}

    <!-- Team History -->
    {(p.team2024 || p.team2026 || teammates.length > 0) && (
      <section class="team-section">
        <h2>Team History</h2>
        <div class="team-content">
          {(p.team2024 || p.team2026) && (
            <div class="team-history-rows">
              {p.team2024 && p.team2026 && p.team2024 === p.team2026 ? (
                <div class="team-row">
                  <span class="team-years">2024–2026</span>
                  <span class="team-name">{p.team2026}</span>
                </div>
              ) : (
                <>
                  {p.team2026 && (
                    <div class="team-row">
                      <span class="team-years">2026</span>
                      <span class="team-name">{p.team2026}</span>
                    </div>
                  )}
                  {p.team2024 && (
                    <div class="team-row">
                      <span class="team-years">2024</span>
                      <span class="team-name">{p.team2024}</span>
                    </div>
                  )}
                </>
              )}
            </div>
          )}
          {p.team2026 && teammates.length > 0 && (
            <div class="team-mates">
              <span class="team-mates-label">Teammates:</span>
              <span class="team-mates-list">
                {teammates.map((tm, i) => (
                  <>
                    {i > 0 && <span class="team-sep"> · </span>}
                    {tm.data.published !== false ? (
                      <a href={`${base}players/${tm.id}/`} class="teammate-inline">{tm.data.name}</a>
                    ) : (
                      <span class="teammate-inline no-profile">{tm.data.name}</span>
                    )}
                  </>
                ))}
              </span>
            </div>
          )}
        </div>
      </section>
    )}

    <a href={base} class="back-link">← Back to all players</a>
  </div>
</BaseLayout>

<style>
  .player-page {
    max-width: 1200px;
    margin: 0 auto;
  }

  .player-header {
    margin-bottom: 2rem;
  }

  .player-header h1 {
    margin-bottom: 0.25rem;
  }

  .ratings-disclaimer {
    font-size: 0.75em;
    color: #666;
    margin: 0.35rem 0 0;
  }

  .player-ratings-display {
    display: flex;
    gap: 2rem;
    margin: 1rem 0;
    padding: 0.75rem 1rem;
    background: var(--bg-card, #1a1a24);
    border-radius: 6px;
    border: 1px solid var(--border-color, #2a2a35);
  }

  .rating-item {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }

  .rating-value-container {
    display: flex;
    flex-direction: column;
  }

  .game-count {
    font-size: 0.75rem;
    color: #6b7280;
    line-height: 1.2;
  }

  .ratings-disclaimer {
    font-size: 0.7em;
    color: #666;
    margin: 0.25rem 0 0 0;
    text-align: right;
  }

  .rating-label {
    color: var(--text-secondary, #9090a0);
    font-size: 0.9rem;
  }

  .rating-value {
    font-size: 1.25rem;
    font-weight: 600;
    font-family: monospace;
  }

  .rating-value.duel {
    color: #3498db;
  }

  .rating-value.ctf {
    color: #e74c3c;
  }

  .rating-value.tdm {
    color: #2ecc71;
  }

  .rating-value.csql {
    color: #f39c12;
    text-decoration: none;
  }

  .rating-value.csql:hover {
    text-decoration: underline;
  }

  .player-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.9rem;
    color: var(--text-secondary, #9090a0);
    margin-bottom: 0.5rem;
  }

  .data-source {
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: help;
  }

  .source-player {
    background: rgba(78, 205, 196, 0.15);
    color: var(--accent-secondary, #4ecdc4);
    border: 1px solid var(--accent-secondary, #4ecdc4);
  }

  .source-verified {
    background: rgba(46, 204, 113, 0.15);
    color: #2ecc71;
    border: 1px solid #2ecc71;
  }

  .source-collected {
    background: rgba(136, 136, 136, 0.15);
    color: var(--text-secondary, #888);
    border: 1px solid var(--text-secondary, #888);
  }

  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .settings-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
  }

  .settings-section h2 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .settings-table {
    width: 100%;
  }

  .settings-table td {
    padding: 0.4rem 0;
    border: none;
  }

  .settings-table td:first-child {
    color: var(--text-secondary, #9090a0);
    width: 50%;
  }

  .sub-setting {
    padding-left: 1rem !important;
    font-size: 0.85em;
  }

  .text-muted {
    color: var(--text-secondary, #9090a0);
    font-style: italic;
  }

  .real-accel-label {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }

  .tooltip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--border-color, #2a2a35);
    color: var(--text-secondary, #9090a0);
    font-size: 0.65rem;
    cursor: help;
    font-weight: 600;
  }

  .player-actions {
    margin-top: 1rem;
  }

  .compare-btn {
    display: inline-block;
    background: var(--bg-card, #1a1a24);
    color: var(--accent-secondary, #4ecdc4);
    padding: 0.5rem 1rem;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9rem;
    border: 1px solid var(--border-color, #2a2a35);
    transition: all 0.2s;
  }

  .compare-btn:hover {
    background: var(--accent-secondary, #4ecdc4);
    color: var(--bg-primary, #0a0a0f);
  }

  .hardware-full-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .hardware-full-section h2 {
    font-size: 1.1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .hardware-items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
  }

  .hardware-item {
    background: var(--bg-secondary, #12121a);
    border-radius: 6px;
    padding: 1rem;
  }

  .hardware-item h3 {
    font-size: 0.75rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    margin-bottom: 0.25rem;
    letter-spacing: 0.05em;
  }

  .hardware-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent-secondary, #4ecdc4);
    margin-bottom: 0.75rem;
  }

  .hardware-name-link {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent-secondary, #4ecdc4);
    margin-bottom: 0.75rem;
    text-decoration: none;
    transition: color 0.2s;
  }

  .hardware-name-link:hover {
    color: var(--accent-primary, #ff6b35);
    text-decoration: underline;
  }

  .hardware-specs {
    width: 100%;
    font-size: 0.85rem;
  }

  .hardware-specs td {
    padding: 0.2rem 0;
  }

  .hardware-specs td:first-child {
    color: var(--text-secondary, #9090a0);
    width: 45%;
  }

  .buy-link {
    display: inline-block;
    margin-top: 0.75rem;
    padding: 0.4rem 0.75rem;
    background: var(--accent-primary, #ff6b35);
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .buy-link:hover {
    background: #ff8c5a;
    transform: translateY(-1px);
  }

  /* --- Setup Insights --- */
  .insights-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .insights-section h2 {
    font-size: 1.1rem;
    margin-bottom: 1.25rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.25rem;
    align-items: start;
  }

  .insight-card {
    background: var(--bg-secondary, #12121a);
    border-radius: 6px;
    padding: 1.25rem;
  }

  .insight-card h3 {
    font-size: 0.75rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .insight-sens-value {
    display: flex;
    align-items: baseline;
    gap: 0.4rem;
    margin-bottom: 0.5rem;
  }

  .insight-big-num {
    font-size: 1.5rem;
    font-weight: 700;
    font-family: monospace;
    color: var(--text-primary, #e8e8f0);
  }

  .insight-unit {
    font-size: 0.85rem;
    color: var(--text-secondary, #9090a0);
  }

  .insight-category {
    font-size: 0.75rem;
    color: var(--accent-secondary, #4ecdc4);
    background: rgba(78, 205, 196, 0.1);
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    margin-left: 0.25rem;
  }

  .insight-percentile {
    font-size: 0.85rem;
    color: var(--text-secondary, #9090a0);
    margin-bottom: 0.75rem;
  }

  .insight-percentile strong {
    color: var(--text-primary, #e8e8f0);
  }

  .sens-distribution {
    display: flex;
    gap: 3px;
    align-items: flex-end;
    height: 70px;
    margin-bottom: 0.75rem;
    padding-top: 0.25rem;
  }

  .sens-bucket {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
  }

  .sens-bar-container {
    flex: 1;
    width: 100%;
    display: flex;
    align-items: flex-end;
    justify-content: center;
  }

  .sens-bar {
    width: 100%;
    background: var(--border-color, #2a2a35);
    border-radius: 2px 2px 0 0;
    min-height: 3px;
    position: relative;
    transition: background 0.2s;
  }

  .sens-bar-active {
    background: var(--accent-secondary, #4ecdc4);
  }

  .sens-bar-count {
    position: absolute;
    top: -14px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.6rem;
    color: var(--text-secondary, #9090a0);
  }

  .sens-bucket-label {
    font-size: 0.6rem;
    color: var(--text-secondary, #6b7280);
    margin-top: 3px;
    white-space: nowrap;
  }

  .sens-bucket-active {
    color: var(--accent-secondary, #4ecdc4);
    font-weight: 600;
  }

  .insight-similar {
    font-size: 0.8rem;
    color: var(--text-secondary, #9090a0);
    line-height: 1.6;
  }

  .insight-similar-label {
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-bottom: 0.25rem;
    color: var(--text-secondary, #6b7280);
  }

  .insight-player-link {
    color: var(--accent-secondary, #4ecdc4);
    text-decoration: none;
  }

  .insight-player-link:hover {
    text-decoration: underline;
  }

  .insight-player-stat {
    color: var(--text-secondary, #6b7280);
    font-size: 0.75rem;
  }

  .insight-sep {
    margin: 0 0.35rem;
    color: var(--text-secondary, #6b7280);
  }

  .insight-mouse-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary, #e8e8f0);
    margin-bottom: 0.35rem;
  }

  .insight-mouse-count {
    font-size: 0.85rem;
    color: var(--text-secondary, #9090a0);
    margin-bottom: 0.75rem;
  }

  .insight-mouse-count strong {
    color: var(--text-primary, #e8e8f0);
  }

  .insight-mouse-rank {
    color: var(--text-secondary, #6b7280);
  }

  .insight-profile-table {
    width: 100%;
    font-size: 0.85rem;
  }

  .insight-profile-table td {
    padding: 0.3rem 0;
  }

  .insight-profile-table td:first-child {
    color: var(--text-secondary, #9090a0);
    width: 35%;
  }

  .insight-profile-val {
    font-weight: 600;
    font-family: monospace;
    color: var(--text-primary, #e8e8f0);
    width: 30%;
  }

  .insight-profile-ctx {
    font-size: 0.75rem;
    color: var(--text-secondary, #6b7280);
  }

  @media (max-width: 600px) {
    .insights-grid {
      grid-template-columns: 1fr;
    }
  }

  .config-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.25rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .config-section h2 {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .download-btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: var(--accent-secondary, #4ecdc4);
    color: var(--bg-primary, #0a0a0f);
    border-radius: 4px;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
  }

  .download-btn:hover {
    background: #6ee0d8;
  }

  .source-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.25rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .source-section h2 {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .source-info {
    font-size: 0.9rem;
    color: var(--text-primary, #e8e8f0);
  }

  .source-info p {
    margin-bottom: 0.25rem;
  }

  .source-info a {
    color: var(--accent-secondary, #4ecdc4);
    text-decoration: none;
  }

  .source-info a:hover {
    text-decoration: underline;
  }

  .back-link {
    display: inline-block;
    color: var(--text-secondary, #9090a0);
    font-size: 0.9rem;
    margin-top: 1rem;
  }

  .back-link:hover {
    color: var(--accent-primary, #ff6b35);
  }

  .team-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .team-section h2 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .team-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .team-history-rows {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .team-row {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
  }

  .team-years {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-secondary, #9090a0);
    font-family: monospace;
    min-width: 5rem;
  }

  .team-name {
    font-size: 0.95rem;
    color: var(--text-primary, #e8e8f0);
    font-weight: 500;
  }

  .team-mates {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0.35rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color, #2a2a35);
  }

  .team-mates-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--text-secondary, #9090a0);
  }

  .team-mates-list {
    font-size: 0.9rem;
    line-height: 1.6;
  }

  .team-sep {
    color: var(--text-secondary, #4a4a5a);
  }

  .teammate-inline {
    color: var(--accent-secondary, #4ecdc4);
    text-decoration: none;
  }

  .teammate-inline:hover {
    text-decoration: underline;
    color: var(--accent-primary, #ff6b35);
  }

  .teammate-inline.no-profile {
    color: var(--text-secondary, #6b7280);
    cursor: default;
  }

  .teammate-inline.no-profile:hover {
    text-decoration: none;
    color: var(--text-secondary, #6b7280);
  }

  .keybinds-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .keybinds-section h2 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .keybinds-compact {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 0.5rem;
  }

  .keybind-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .keybind-label {
    font-size: 0.8rem;
    color: var(--text-secondary, #9090a0);
    min-width: 5rem;
  }

  .keybinds-compact kbd {
    display: inline-block;
    background: var(--bg-secondary, #12121a);
    border: 1px solid var(--border-color, #3a3a45);
    border-bottom-width: 2px;
    border-radius: 4px;
    padding: 0.15rem 0.5rem;
    font-family: monospace;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-primary, #e8e8f0);
    text-transform: uppercase;
    line-height: 1.4;
    white-space: nowrap;
  }

  .similar-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .similar-section h2 {
    font-size: 1.1rem;
    margin-bottom: 1.25rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .similar-groups {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .similar-group h3 {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    color: var(--text-primary, #e8e8f0);
  }

  .similar-info {
    font-weight: normal;
    color: var(--text-secondary, #9090a0);
    font-size: 0.8rem;
  }

  .similar-players {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .similar-player {
    display: inline-flex;
    flex-direction: column;
    padding: 0.5rem 0.75rem;
    background: var(--bg-secondary, #12121a);
    border-radius: 6px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .similar-player:hover {
    background: var(--accent-primary, #ff6b35);
  }

  .similar-player .player-name {
    color: var(--accent-secondary, #4ecdc4);
    font-weight: 500;
    font-size: 0.9rem;
  }

  .similar-player:hover .player-name {
    color: white;
  }

  .similar-player .player-stat {
    color: var(--text-secondary, #9090a0);
    font-size: 0.75rem;
  }

  .similar-player:hover .player-stat {
    color: rgba(255, 255, 255, 0.8);
  }

  .similar-player.has-accel {
    border: 1px dashed rgba(232, 167, 53, 0.4);
  }

  /* --- HoQ Stats / Playstyle --- */
  .hoq-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .hoq-header {
    display: flex;
    align-items: baseline;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
  }

  .hoq-section h2 {
    font-size: 1.1rem;
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0;
  }

  .hoq-attr {
    margin-left: auto;
    font-size: 0.75rem;
    color: var(--text-secondary, #9090a0);
  }

  .hoq-attr a {
    color: var(--accent-secondary, #4ecdc4);
    text-decoration: none;
  }

  .hoq-attr a:hover {
    text-decoration: underline;
  }

  .hoq-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    align-items: start;
  }

  .hoq-favorites .settings-table {
    width: auto;
  }

  .hoq-favorites .settings-table td:first-child {
    width: auto;
    padding-right: 1.5rem;
  }

  .hoq-accuracy h3 {
    font-size: 0.8rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .acc-bars {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .acc-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .acc-icon {
    font-size: 0.9rem;
    width: 1.25rem;
    text-align: center;
    flex-shrink: 0;
  }

  .acc-label {
    width: 1.5rem;
    min-width: 1.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary, #9090a0);
  }

  .acc-track {
    flex: 1;
    height: 20px;
    background: var(--bg-secondary, #12121a);
    border-radius: 4px;
    position: relative;
  }

  .acc-fill {
    height: 100%;
    border-radius: 4px;
    min-width: 4px;
  }

  .acc-fill-rl {
    background: #e67e22;
  }

  .acc-fill-lg {
    background: #3498db;
  }

  .acc-fill-rg {
    background: #2ecc71;
  }

  .acc-avg-marker {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: rgba(255, 255, 255, 0.5);
    cursor: help;
  }

  .acc-value {
    min-width: 2.5rem;
    text-align: right;
    font-size: 0.9rem;
    font-weight: 600;
    font-family: monospace;
    color: var(--text-primary, #e8e8f0);
  }

  /* --- Season Stats (HoQ 2026 S1) --- */
  .season-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .season-header {
    display: flex;
    align-items: baseline;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
  }

  .season-section h2 {
    font-size: 1.1rem;
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0;
  }

  .season-attr {
    margin-left: auto;
    font-size: 0.75rem;
    color: var(--text-secondary, #9090a0);
  }

  .season-attr a {
    color: var(--accent-secondary, #4ecdc4);
    text-decoration: none;
  }

  .season-attr a:hover {
    text-decoration: underline;
  }

  .season-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    align-items: start;
  }

  .stat-rows {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .stat-row {
    display: grid;
    grid-template-columns: 5.5rem 4.5rem 1fr auto auto;
    align-items: center;
    gap: 0.6rem;
    padding: 0.45rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  }

  .stat-row:last-child {
    border-bottom: none;
  }

  .stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary, #9090a0);
    white-space: nowrap;
  }

  .stat-value {
    font-weight: 600;
    font-family: monospace;
    font-size: 0.9rem;
    color: var(--text-primary, #e8e8f0);
    text-align: right;
  }

  .stat-bar-wrap {
    min-width: 60px;
    max-width: 120px;
  }

  .stat-bar-track {
    height: 6px;
    background: rgba(255, 255, 255, 0.06);
    border-radius: 3px;
    overflow: hidden;
  }

  .stat-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s ease;
  }

  .pct-elite-bg { background: #2ecc71; }
  .pct-good-bg { background: #7ed957; }
  .pct-avg-bg { background: #f1c40f; }
  .pct-below-bg { background: rgba(144, 144, 160, 0.4); }

  .stat-pct {
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
    text-align: right;
    min-width: 4rem;
  }

  .pct-elite {
    color: #2ecc71;
  }

  .pct-good {
    color: #7ed957;
  }

  .pct-avg {
    color: #f1c40f;
  }

  .pct-below {
    color: var(--text-secondary, #9090a0);
  }

  .stat-avg {
    font-size: 0.7rem;
    color: var(--text-secondary, #6b7280);
    white-space: nowrap;
    min-width: 4.5rem;
    text-align: right;
  }

  .season-weapons h3 {
    font-size: 0.8rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .season-weapons .settings-table td:nth-child(2) {
    font-weight: 600;
    font-family: monospace;
    padding-right: 1rem;
  }

  .season-weapons .settings-table td:nth-child(3) {
    font-size: 0.8rem;
  }

  .season-flags h3,
  .season-rivalries h3 {
    font-size: 0.8rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .rivalry-cards {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .rivalry-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-color, #2a2a35);
  }

  .rivalry-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .rivalry-info {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  .rivalry-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary, #9090a0);
  }

  .rivalry-name {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-primary, #e8e8f0);
  }

  a.rivalry-name {
    color: var(--accent-secondary, #4ecdc4);
    text-decoration: none;
  }

  a.rivalry-name:hover {
    text-decoration: underline;
  }

  .rivalry-detail {
    font-size: 0.8rem;
    color: var(--text-secondary, #9090a0);
  }

  .season-maps {
    grid-column: 1 / -1;
  }

  .season-maps h3 {
    font-size: 0.8rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .map-stats-table {
    width: 100%;
  }

  .map-stats-table thead th {
    font-size: 0.75rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    padding: 0.4rem 0.5rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #2a2a35);
    font-weight: 600;
  }

  .map-stats-table tbody td {
    padding: 0.4rem 0.5rem;
    font-size: 0.9rem;
    font-family: monospace;
  }

  .map-stats-table tbody td:first-child {
    font-family: inherit;
    color: var(--text-primary, #e8e8f0);
    font-weight: 500;
  }

  .stat-good {
    color: #2ecc71;
  }

  .stat-bad {
    color: #e74c3c;
  }

  @media (max-width: 768px) {
    .player-ratings-display {
      flex-wrap: wrap;
      gap: 0.75rem 1.5rem;
    }

    .settings-grid {
      grid-template-columns: 1fr;
    }

    .hardware-items-grid {
      grid-template-columns: 1fr;
    }

    .hoq-grid {
      grid-template-columns: 1fr;
    }

    .season-grid {
      grid-template-columns: 1fr;
    }

    .keybinds-compact {
      grid-template-columns: 1fr 1fr;
    }

    .stat-row {
      grid-template-columns: 1fr auto auto;
      gap: 0.3rem 0.5rem;
    }

    .stat-label {
      font-size: 0.75rem;
    }

    .stat-value {
      font-size: 0.8rem;
      text-align: left;
    }

    .stat-bar-wrap {
      display: none;
    }

    .stat-pct {
      font-size: 0.7rem;
      min-width: unset;
    }

    .stat-avg {
      font-size: 0.65rem;
      min-width: unset;
    }

    .race-grid {
      grid-template-columns: 1fr;
    }
  }

  /* --- Race Stats (qlrace.com) --- */
  .race-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    align-items: start;
  }

  .race-stats {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .race-stat-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 0.4rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  }

  .race-stat-row:last-child {
    border-bottom: none;
  }

  .race-label {
    font-size: 0.8rem;
    color: var(--text-secondary, #9090a0);
    min-width: 5.5rem;
  }

  .race-value {
    font-size: 0.85rem;
    color: var(--text-primary, #e8e8f0);
    font-family: monospace;
  }

  .race-medals {
    display: flex;
    gap: 0.5rem;
    font-family: inherit;
  }

  .race-medal {
    font-weight: 700;
    font-size: 0.85rem;
  }

  .race-medal::before {
    margin-right: 0.15rem;
  }

  .race-gold { color: #ffd700; }
  .race-gold::before { content: '\1F947'; }
  .race-silver { color: #c0c0c0; }
  .race-silver::before { content: '\1F948'; }
  .race-bronze { color: #cd7f32; }
  .race-bronze::before { content: '\1F949'; }

  .race-map {
    color: var(--accent-secondary, #4ecdc4);
  }

  .race-pct {
    color: var(--text-secondary, #9090a0);
    font-size: 0.75rem;
  }

  .race-time {
    font-family: monospace;
    color: #f0f6fc;
  }

  .race-hint {
    font-size: 0.7rem;
    color: var(--text-secondary, #9090a0);
    font-family: inherit;
  }

  .race-fav-match {
    font-size: 0.75rem;
    color: #f1c40f;
    font-family: inherit;
    font-style: italic;
  }

  .race-top-maps h3 {
    font-size: 0.85rem;
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.5rem;
  }

  .race-maps-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
  }

  .race-maps-table th {
    text-align: left;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary, #9090a0);
    padding: 0.3rem 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
  }

  .race-maps-table td {
    padding: 0.35rem 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
  }
</style>
