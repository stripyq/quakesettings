---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const players = await getCollection('players');
  return players.map((player) => ({
    params: { id: player.id },
    props: { player },
  }));
}

const { player } = Astro.props;
const p = player.data;

// Get hardware collections
const mice = await getCollection('mice');
const mousepads = await getCollection('mousepads');
const keyboards = await getCollection('keyboards');
const monitors = await getCollection('monitors');
const headsets = await getCollection('headsets');

// Create lookup maps
const miceMap = new Map(mice.map(m => [m.id, m.data]));
const mousepadsMap = new Map(mousepads.map(m => [m.id, m.data]));
const keyboardsMap = new Map(keyboards.map(k => [k.id, k.data]));
const monitorsMap = new Map(monitors.map(m => [m.id, m.data]));
const headsetsMap = new Map(headsets.map(h => [h.id, h.data]));

// Get this player's hardware
const mouseData = miceMap.get(p.mouse);
const mousepadData = p.mousepad ? mousepadsMap.get(p.mousepad) : null;
const keyboardData = p.keyboard ? keyboardsMap.get(p.keyboard) : null;
const monitorData = p.monitor ? monitorsMap.get(p.monitor) : null;
const headsetData = p.headset ? headsetsMap.get(p.headset) : null;

// Get all players for Similar Players section
const allPlayers = await getCollection('players');
const otherPlayers = allPlayers.filter(pl => pl.id !== player.id);

// Calculate cm/360 for a player
function calculateCm360(playerData: any): number {
  if (playerData.cm360) return playerData.cm360;
  if (playerData.m_cpi) {
    // When m_cpi is set: cm360 = 360 × m_cpi / (sensitivity × DPI)
    // When m_cpi = DPI, this simplifies to 360 / sensitivity
    return Math.round((360 * playerData.m_cpi / (playerData.sensitivity * playerData.dpi)) * 100) / 100;
  }
  return Math.round((41563.6 / (playerData.dpi * playerData.sensitivity)) * 100) / 100;
}

const currentCm360 = calculateCm360(p);

// Find players with similar cm/360 (within 15% range)
const similarSens = otherPlayers
  .map(pl => ({
    player: pl,
    cm360: calculateCm360(pl.data),
  }))
  .filter(({ cm360 }) => {
    const diff = Math.abs(cm360 - currentCm360) / currentCm360;
    return diff <= 0.15;
  })
  .sort((a, b) => Math.abs(a.cm360 - currentCm360) - Math.abs(b.cm360 - currentCm360))
  .slice(0, 5);

// Find players with same mouse
const sameMouse = p.mouse
  ? otherPlayers.filter(pl => pl.data.mouse === p.mouse).slice(0, 5)
  : [];

// Find players with same monitor
const sameMonitor = p.monitor
  ? otherPlayers.filter(pl => pl.data.monitor === p.monitor).slice(0, 5)
  : [];

// Find players with same keyboard
const sameKeyboard = p.keyboard
  ? otherPlayers.filter(pl => pl.data.keyboard === p.keyboard).slice(0, 5)
  : [];

// Find players with same mousepad
const sameMousepad = p.mousepad
  ? otherPlayers.filter(pl => pl.data.mousepad === p.mousepad).slice(0, 5)
  : [];

// Format rating based on type
function formatRating(rating: number | undefined, type: 'duel' | 'ctf' | 'tdm'): string {
  if (!rating) return '—';
  if (type === 'duel') return Math.round(rating).toString(); // Glicko: integer
  return rating.toFixed(1); // TrueSkill: one decimal
}

// Get team rating (higher of CTF or TDM)
function getTeamRating(): { rating: number | null; type: 'ctf' | 'tdm' | null } {
  const ctf = p.ctfRating || 0;
  const tdm = p.tdmRating || 0;
  if (ctf === 0 && tdm === 0) return { rating: null, type: null };
  if (ctf >= tdm) return { rating: p.ctfRating!, type: 'ctf' };
  return { rating: p.tdmRating!, type: 'tdm' };
}

const teamInfo = getTeamRating();

// Check if player has duel rating history
const hasDuelHistory = p.duelRatingPeak || p.duelRatingLow;

// Check if player has team rating history
const hasTeamHistory = (teamInfo.type === 'ctf' && (p.ctfRatingPeak || p.ctfRatingLow)) ||
                       (teamInfo.type === 'tdm' && (p.tdmRatingPeak || p.tdmRatingLow));

// Ensure base URL has trailing slash for path concatenation
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;
---

<BaseLayout title={p.name}>
  <div class="player-page">
    <div class="player-header">
      <h1>{p.name}</h1>
      <div class="player-ratings-display">
        <div class="rating-item">
          <span class="rating-label">Duel:</span>
          <span class="rating-value duel">{formatRating(p.duelRating, 'duel')}</span>
        </div>
        <div class="rating-item">
          <span class="rating-label">CTF:</span>
          <span class="rating-value ctf">{formatRating(p.ctfRating, 'ctf')}</span>
        </div>
        <div class="rating-item">
          <span class="rating-label">TDM:</span>
          <span class="rating-value tdm">{formatRating(p.tdmRating, 'tdm')}</span>
        </div>
        {p.qllrCtfRating && (
          <div class="rating-item">
            <span class="rating-label">CSQL:</span>
            <a href={`https://qllr.xyz/player/${p.steamId}`} target="_blank" rel="noopener noreferrer" class="rating-value csql">{p.qllrCtfRating.toFixed(1)}</a>
          </div>
        )}
      </div>
      <p class="ratings-disclaimer">Not real-time · Updated periodically</p>

      <div class="player-meta">
        {p.dataSource === 'player' && <span class="data-source source-player" title="Settings self-submitted by the player">Submitted</span>}
        {p.dataSource === 'verified' && <span class="data-source source-verified" title="Settings verified by the player">✓ Verified</span>}
        {(!p.dataSource || p.dataSource === 'collected') && <span class="data-source source-collected" title="Settings collected from public sources">Collected</span>}
      </div>

      <div class="player-actions">
        <a href={`${base}compare/?p1=${player.id}`} class="compare-btn">Compare with another player</a>
      </div>
    </div>

    <!-- Settings Cards -->
    <div class="settings-grid">
      <!-- Mouse Settings -->
      <section class="settings-section">
        <h2>Mouse Settings</h2>
        <table class="settings-table">
          <tbody>
            <tr><td>DPI</td><td>{p.dpi}</td></tr>
            <tr><td>In-game Sensitivity</td><td>{p.sensitivity}</td></tr>
            <tr><td>eDPI</td><td>{p.edpi}</td></tr>
            <tr><td>cm/360</td><td>{currentCm360.toFixed(2)}</td></tr>
            {p.grip && <tr><td>Grip Style</td><td>{p.grip}</td></tr>}
            <tr><td>Mouse Acceleration</td><td>{p.acceleration ? 'On' : 'Off'}</td></tr>
            <tr><td>Raw Input</td><td>{p.rawInput ? 'On' : 'Off'}</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Game Settings -->
      <section class="settings-section">
        <h2>Game Settings</h2>
        <table class="settings-table">
          <tbody>
            <tr><td>FOV</td><td>{p.fov}</td></tr>
            <tr><td>Crosshair</td><td>{p.crosshair}</td></tr>
            <tr><td>Crosshair Size</td><td>{p.crosshairSize || 'N/A'}</td></tr>
            <tr><td>Inverted Mouse</td><td>{p.invertedMouse ? 'Yes' : 'No'}</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Key Bindings -->
      <section class="settings-section">
        <h2>Key Bindings</h2>
        <table class="settings-table">
          <tbody>
            <tr><td>Forward</td><td>{p.forward}</td></tr>
            <tr><td>Back</td><td>{p.back}</td></tr>
            <tr><td>Left</td><td>{p.left}</td></tr>
            <tr><td>Right</td><td>{p.right}</td></tr>
            <tr><td>Jump</td><td>{p.jump}</td></tr>
            <tr><td>Crouch</td><td>{p.crouch}</td></tr>
            <tr><td>Attack</td><td>{p.attack}</td></tr>
            <tr><td>Zoom</td><td>{p.zoom}</td></tr>
            {p.weaponNext && <tr><td>Next Weapon</td><td>{p.weaponNext}</td></tr>}
            {p.weaponPrev && <tr><td>Prev Weapon</td><td>{p.weaponPrev}</td></tr>}
          </tbody>
        </table>
      </section>
    </div>

    <section class="hardware-full-section">
      <h2>Hardware</h2>
      <div class="hardware-items-grid">
        {mouseData && (
          <div class="hardware-item">
            <h3>Mouse</h3>
            <p class="hardware-name">{mouseData.name}</p>
            <table class="hardware-specs">
              <tr><td>Brand</td><td>{mouseData.brand}</td></tr>
              <tr><td>Weight</td><td>{mouseData.weight}</td></tr>
              <tr><td>Shape</td><td>{mouseData.shape}</td></tr>
              <tr><td>Sensor</td><td>{mouseData.sensor}</td></tr>
              <tr><td>Connection</td><td>{mouseData.connection}</td></tr>
            </table>
          </div>
        )}

        {mousepadData && (
          <div class="hardware-item">
            <h3>Mousepad</h3>
            <p class="hardware-name">{mousepadData.name}</p>
            <table class="hardware-specs">
              <tr><td>Surface</td><td>{mousepadData.surface}</td></tr>
              <tr><td>Speed</td><td>{mousepadData.speed || mousepadData.speedType || 'N/A'}</td></tr>
              <tr><td>Dimensions</td><td>{mousepadData.dimensions || mousepadData.size || 'N/A'}</td></tr>
            </table>
          </div>
        )}

        {keyboardData && (
          <div class="hardware-item">
            <h3>Keyboard</h3>
            <p class="hardware-name">{keyboardData.name}</p>
            <table class="hardware-specs">
              <tr><td>Size</td><td>{keyboardData.size || keyboardData.format || 'N/A'}</td></tr>
              <tr><td>Switches</td><td>{keyboardData.switches}</td></tr>
              <tr><td>Connection</td><td>{keyboardData.connection}</td></tr>
            </table>
          </div>
        )}

        {monitorData && (
          <div class="hardware-item">
            <h3>Monitor</h3>
            <p class="hardware-name">{monitorData.name}</p>
            <table class="hardware-specs">
              <tr><td>Size</td><td>{monitorData.size}</td></tr>
              <tr><td>Refresh Rate</td><td>{monitorData.refreshRate}</td></tr>
              <tr><td>Panel</td><td>{monitorData.panelType || monitorData.panel || 'N/A'}</td></tr>
              <tr><td>Resolution</td><td>{monitorData.resolution}</td></tr>
            </table>
          </div>
        )}

        {headsetData && (
          <div class="hardware-item">
            <h3>Headset</h3>
            <p class="hardware-name">{headsetData.name}</p>
            <table class="hardware-specs">
              <tr><td>Type</td><td>{headsetData.type}</td></tr>
              <tr><td>Driver Size</td><td>{headsetData.driverSize || headsetData.driver || 'N/A'}</td></tr>
              <tr><td>Connection</td><td>{headsetData.connection}</td></tr>
            </table>
          </div>
        )}
      </div>
    </section>

    <!-- Config Download -->
    {p.configFile && (
      <section class="config-section">
        <h2>Config File</h2>
        <a href={`${base}${p.configFile.replace(/^\//, '')}`} download class="download-btn">
          Download {p.name}'s Config
        </a>
      </section>
    )}

    <!-- Data Source -->
    {(p.source || p.lastUpdated) && (
      <section class="source-section">
        <h2>Data Source</h2>
        <div class="source-info">
          {p.source && <p><strong>Source:</strong> {p.sourceUrl ? <a href={p.sourceUrl} target="_blank" rel="noopener">{p.source}</a> : p.source}</p>}
          {p.lastUpdated && <p><strong>Last Updated:</strong> {p.lastUpdated}</p>}
        </div>
      </section>
    )}

    <!-- Similar Players -->
    {(similarSens.length > 0 || sameMouse.length > 0 || sameMonitor.length > 0 || sameKeyboard.length > 0 || sameMousepad.length > 0) && (
      <section class="similar-section">
        <h2>Similar Players</h2>
        <div class="similar-groups">
          {similarSens.length > 0 && (
            <div class="similar-group">
              <h3>Similar Sensitivity <span class="similar-info">(cm/360: {currentCm360.toFixed(2)})</span></h3>
              <div class="similar-players">
                {similarSens.map(({ player: pl, cm360 }) => (
                  <a
                    href={`${base}players/${pl.id}/`}
                    class={`similar-player ${pl.data.acceleration ? 'has-accel' : ''}`}
                    title={pl.data.acceleration ? 'This player uses mouse acceleration — base sensitivity shown' : undefined}
                  >
                    <span class="player-name">{pl.data.name}</span>
                    <span class="player-stat">{cm360.toFixed(2)} cm/360</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          {sameMouse.length > 0 && (
            <div class="similar-group">
              <h3>Same Mouse <span class="similar-info">({mouseData?.name})</span></h3>
              <div class="similar-players">
                {sameMouse.map(pl => (
                  <a href={`${base}players/${pl.id}/`} class="similar-player">
                    <span class="player-name">{pl.data.name}</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          {sameMousepad.length > 0 && (
            <div class="similar-group">
              <h3>Same Mousepad <span class="similar-info">({mousepadData?.name})</span></h3>
              <div class="similar-players">
                {sameMousepad.map(pl => (
                  <a href={`${base}players/${pl.id}/`} class="similar-player">
                    <span class="player-name">{pl.data.name}</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          {sameKeyboard.length > 0 && (
            <div class="similar-group">
              <h3>Same Keyboard <span class="similar-info">({keyboardData?.name})</span></h3>
              <div class="similar-players">
                {sameKeyboard.map(pl => (
                  <a href={`${base}players/${pl.id}/`} class="similar-player">
                    <span class="player-name">{pl.data.name}</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          {sameMonitor.length > 0 && (
            <div class="similar-group">
              <h3>Same Monitor <span class="similar-info">({monitorData?.name})</span></h3>
              <div class="similar-players">
                {sameMonitor.map(pl => (
                  <a href={`${base}players/${pl.id}/`} class="similar-player">
                    <span class="player-name">{pl.data.name}</span>
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      </section>
    )}

    <a href={base} class="back-link">← Back to all players</a>
  </div>
</BaseLayout>

<style>
  .player-page {
    max-width: 1200px;
    margin: 0 auto;
  }

  .player-header {
    margin-bottom: 2rem;
  }

  .player-header h1 {
    margin-bottom: 0.25rem;
  }

  .ratings-disclaimer {
    font-size: 0.75em;
    color: #666;
    margin: 0.35rem 0 0;
  }

  .player-ratings-display {
    display: flex;
    gap: 2rem;
    margin: 1rem 0;
    padding: 0.75rem 1rem;
    background: var(--bg-card, #1a1a24);
    border-radius: 6px;
    border: 1px solid var(--border-color, #2a2a35);
  }

  .rating-item {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }

  .ratings-disclaimer {
    font-size: 0.7em;
    color: #666;
    margin: 0.25rem 0 0 0;
    text-align: right;
  }

  .rating-label {
    color: var(--text-secondary, #9090a0);
    font-size: 0.9rem;
  }

  .rating-value {
    font-size: 1.25rem;
    font-weight: 600;
    font-family: monospace;
  }

  .rating-value.duel {
    color: #3498db;
  }

  .rating-value.ctf {
    color: #e74c3c;
  }

  .rating-value.tdm {
    color: #2ecc71;
  }

  .rating-value.csql {
    color: #f39c12;
    text-decoration: none;
  }

  .rating-value.csql:hover {
    text-decoration: underline;
  }

  .player-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.9rem;
    color: var(--text-secondary, #9090a0);
    margin-bottom: 0.5rem;
  }

  .data-source {
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: help;
  }

  .source-player {
    background: rgba(78, 205, 196, 0.15);
    color: var(--accent-secondary, #4ecdc4);
    border: 1px solid var(--accent-secondary, #4ecdc4);
  }

  .source-verified {
    background: rgba(46, 204, 113, 0.15);
    color: #2ecc71;
    border: 1px solid #2ecc71;
  }

  .source-collected {
    background: rgba(136, 136, 136, 0.15);
    color: var(--text-secondary, #888);
    border: 1px solid var(--text-secondary, #888);
  }

  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .settings-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
  }

  .settings-section h2 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .settings-table {
    width: 100%;
  }

  .settings-table td {
    padding: 0.4rem 0;
    border: none;
  }

  .settings-table td:first-child {
    color: var(--text-secondary, #9090a0);
    width: 50%;
  }

  .player-actions {
    margin-top: 1rem;
  }

  .compare-btn {
    display: inline-block;
    background: var(--bg-card, #1a1a24);
    color: var(--accent-secondary, #4ecdc4);
    padding: 0.5rem 1rem;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9rem;
    border: 1px solid var(--border-color, #2a2a35);
    transition: all 0.2s;
  }

  .compare-btn:hover {
    background: var(--accent-secondary, #4ecdc4);
    color: var(--bg-primary, #0a0a0f);
  }

  .hardware-full-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .hardware-full-section h2 {
    font-size: 1.1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .hardware-items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
  }

  .hardware-item {
    background: var(--bg-secondary, #12121a);
    border-radius: 6px;
    padding: 1rem;
  }

  .hardware-item h3 {
    font-size: 0.75rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    margin-bottom: 0.25rem;
    letter-spacing: 0.05em;
  }

  .hardware-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent-secondary, #4ecdc4);
    margin-bottom: 0.75rem;
  }

  .hardware-name-link {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent-secondary, #4ecdc4);
    margin-bottom: 0.75rem;
    text-decoration: none;
    transition: color 0.2s;
  }

  .hardware-name-link:hover {
    color: var(--accent-primary, #ff6b35);
    text-decoration: underline;
  }

  .hardware-specs {
    width: 100%;
    font-size: 0.85rem;
  }

  .hardware-specs td {
    padding: 0.2rem 0;
  }

  .hardware-specs td:first-child {
    color: var(--text-secondary, #9090a0);
    width: 45%;
  }

  .buy-link {
    display: inline-block;
    margin-top: 0.75rem;
    padding: 0.4rem 0.75rem;
    background: var(--accent-primary, #ff6b35);
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .buy-link:hover {
    background: #ff8c5a;
    transform: translateY(-1px);
  }

  .config-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.25rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .config-section h2 {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .download-btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: var(--accent-secondary, #4ecdc4);
    color: var(--bg-primary, #0a0a0f);
    border-radius: 4px;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
  }

  .download-btn:hover {
    background: #6ee0d8;
  }

  .source-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.25rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .source-section h2 {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary, #9090a0);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .source-info {
    font-size: 0.9rem;
    color: var(--text-primary, #e8e8f0);
  }

  .source-info p {
    margin-bottom: 0.25rem;
  }

  .source-info a {
    color: var(--accent-secondary, #4ecdc4);
    text-decoration: none;
  }

  .source-info a:hover {
    text-decoration: underline;
  }

  .back-link {
    display: inline-block;
    color: var(--text-secondary, #9090a0);
    font-size: 0.9rem;
    margin-top: 1rem;
  }

  .back-link:hover {
    color: var(--accent-primary, #ff6b35);
  }

  .similar-section {
    background: var(--bg-card, #1a1a24);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border-color, #2a2a35);
    margin-bottom: 2rem;
  }

  .similar-section h2 {
    font-size: 1.1rem;
    margin-bottom: 1.25rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a35);
    color: var(--accent-primary, #ff6b35);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .similar-groups {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .similar-group h3 {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    color: var(--text-primary, #e8e8f0);
  }

  .similar-info {
    font-weight: normal;
    color: var(--text-secondary, #9090a0);
    font-size: 0.8rem;
  }

  .similar-players {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .similar-player {
    display: inline-flex;
    flex-direction: column;
    padding: 0.5rem 0.75rem;
    background: var(--bg-secondary, #12121a);
    border-radius: 6px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .similar-player:hover {
    background: var(--accent-primary, #ff6b35);
  }

  .similar-player .player-name {
    color: var(--accent-secondary, #4ecdc4);
    font-weight: 500;
    font-size: 0.9rem;
  }

  .similar-player:hover .player-name {
    color: white;
  }

  .similar-player .player-stat {
    color: var(--text-secondary, #9090a0);
    font-size: 0.75rem;
  }

  .similar-player:hover .player-stat {
    color: rgba(255, 255, 255, 0.8);
  }

  .similar-player.has-accel {
    border: 1px dashed #e8a735;
  }

  @media (max-width: 768px) {
    .settings-grid {
      grid-template-columns: 1fr;
    }

    .hardware-items-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
