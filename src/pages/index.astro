---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all players and hardware
const players = await getCollection('players');
const mice = await getCollection('mice');
const keyboards = await getCollection('keyboards');
const headsets = await getCollection('headsets');
const monitors = await getCollection('monitors');

// Create lookup maps for hardware
const miceMap = new Map(mice.map(m => [m.id, m.data]));
const keyboardsMap = new Map(keyboards.map(k => [k.id, k.data]));
const headsetsMap = new Map(headsets.map(h => [h.id, h.data]));
const monitorsMap = new Map(monitors.map(m => [m.id, m.data]));

// Calculate cm/360 based on m_cpi setting
function calculateCm360(player: any): number {
  if (player.cm360) return player.cm360;
  if (player.m_cpi) {
    // If m_cpi is set: cm360 = 360 / sensitivity
    return Math.round((360 / player.sensitivity) * 100) / 100;
  }
  // Standard calculation: cm360 = 41563.6 / (DPI √ó sensitivity)
  return Math.round((41563.6 / (player.dpi * player.sensitivity)) * 100) / 100;
}

// Sort players by name
const sortedPlayers = players.sort((a, b) => a.data.name.localeCompare(b.data.name));

// Ensure base URL has trailing slash for path concatenation
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;
---

<BaseLayout title="Player Database">
  <div class="page-header">
    <h1>Quake Live Pro Settings</h1>
    <p>Mouse settings, hardware, and configs from {players.length} players</p>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label for="category-filter">Category:</label>
      <select id="category-filter">
        <option value="all">All Players</option>
        <option value="duel">Duel</option>
        <option value="ctf">CTF</option>
        <option value="tdm">TDM</option>
      </select>
    </div>

    <div class="filter-group">
      <input type="text" id="player-search" placeholder="Search players or hardware..." class="search-input">
    </div>
  </div>

  <div class="table-container">
    <table class="player-table" id="player-table">
      <thead>
        <tr>
          <th class="sortable" data-sort="name">Player</th>
          <th class="sortable" data-sort="mouse">Mouse</th>
          <th class="sortable" data-sort="dpi">DPI</th>
          <th class="sortable" data-sort="sens">Sens</th>
          <th class="sortable" data-sort="cm360" title="cm/360¬∞ - distance to complete one full turn">
            cm/360
            <span class="header-info" title="Standard: 41563.6 / (DPI √ó sens)&#10;m_cpi users: 360 / sens">‚ìò</span>
          </th>
          <th class="sortable" data-sort="fov">FOV</th>
          <th title="‚ö° = Mouse Acceleration enabled&#10;üìê = m_cpi setting used">Flags</th>
          <th>Monitor</th>
          <th>Keyboard</th>
          <th>Headset</th>
          <th class="sortable" data-sort="updated">Updated</th>
        </tr>
      </thead>
      <tbody id="player-tbody">
        {sortedPlayers.map((player, index) => {
          const mouseData = miceMap.get(player.data.mouse);
          const keyboardData = keyboardsMap.get(player.data.keyboard);
          const headsetData = headsetsMap.get(player.data.headset);
          const monitorData = monitorsMap.get(player.data.monitor);
          const cm360 = calculateCm360(player.data);
          const hasAccel = player.data.acceleration;
          const hasMcpi = player.data.m_cpi;
          return (
            <tr
              class:list={["player-row", { "has-accel": hasAccel, "has-mcpi": hasMcpi }]}
              data-name={player.data.name.toLowerCase()}
              data-category={player.data.category}
              data-dpi={player.data.dpi}
              data-sens={player.data.sensitivity}
              data-cm360={cm360}
              data-fov={player.data.fov}
              data-accel={hasAccel ? "1" : "0"}
              data-mcpi={hasMcpi ? "1" : "0"}
              data-mouse={mouseData?.name?.toLowerCase() || player.data.mouse?.toLowerCase() || ''}
              data-monitor={monitorData?.name?.toLowerCase() || player.data.monitor?.toLowerCase() || ''}
              data-keyboard={keyboardData?.name?.toLowerCase() || player.data.keyboard?.toLowerCase() || ''}
              data-headset={headsetData?.name?.toLowerCase() || player.data.headset?.toLowerCase() || ''}
              data-updated={player.data.lastUpdated || ''}
            >
              <td>
                <a href={`${base}players/${player.id}/`} class="player-link">
                  {player.data.name}
                </a>
              </td>
              <td class="hw-cell">{mouseData?.name || player.data.mouse || '‚Äî'}</td>
              <td class="num">{player.data.dpi}</td>
              <td class="num">{player.data.sensitivity}</td>
              <td class="num cm360-cell">
                {cm360}
                {hasMcpi && <span class="mcpi-marker" title="Uses m_cpi setting">*</span>}
              </td>
              <td class="num">{player.data.fov}</td>
              <td class="flags-cell">
                {hasAccel && <span class="flag accel-flag" title={`Acceleration: ${player.data.accelValue || 'On'}`}>‚ö°</span>}
                {hasMcpi && <span class="flag mcpi-flag" title={`m_cpi: ${player.data.m_cpi}`}>üìê</span>}
                {!hasAccel && !hasMcpi && <span class="no-flags">‚Äî</span>}
              </td>
              <td class="hw-cell">{monitorData?.name || player.data.monitor || '‚Äî'}</td>
              <td class="hw-cell">{keyboardData?.name || player.data.keyboard || '‚Äî'}</td>
              <td class="hw-cell">{headsetData?.name || player.data.headset || '‚Äî'}</td>
              <td class="date-cell">{player.data.lastUpdated || '‚Äî'}</td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <div class="legend">
    <span class="legend-item"><span class="flag accel-flag">‚ö°</span> Mouse Acceleration</span>
    <span class="legend-item"><span class="flag mcpi-flag">üìê</span> m_cpi Setting</span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('player-search') as HTMLInputElement;
      const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
      const tbody = document.getElementById('player-tbody');
      const headers = document.querySelectorAll('th.sortable');

      let sortCol = 'name';
      let sortAsc = true;

      function filterAndSort() {
        const search = searchInput?.value.toLowerCase() || '';
        const category = categoryFilter?.value || 'all';

        const rows = Array.from(tbody?.querySelectorAll('tr') || []) as HTMLTableRowElement[];

        rows.forEach(row => {
          const name = row.dataset.name || '';
          const mouse = row.dataset.mouse || '';
          const monitor = row.dataset.monitor || '';
          const keyboard = row.dataset.keyboard || '';
          const headset = row.dataset.headset || '';
          const cat = row.dataset.category || '';

          let show = true;

          // Search filter (searches player name and hardware)
          if (search && !name.includes(search) && !mouse.includes(search) && !monitor.includes(search) && !keyboard.includes(search) && !headset.includes(search)) {
            show = false;
          }

          // Category filter
          if (category !== 'all' && cat !== category) {
            show = false;
          }

          row.style.display = show ? '' : 'none';
        });

        // Sort visible rows
        const visibleRows = rows.filter(r => r.style.display !== 'none');
        visibleRows.sort((a, b) => {
          let aVal: string | number, bVal: string | number;
          switch(sortCol) {
            case 'name':
              aVal = a.dataset.name || '';
              bVal = b.dataset.name || '';
              break;
            case 'mouse':
              aVal = a.dataset.mouse || '';
              bVal = b.dataset.mouse || '';
              break;
            case 'dpi':
              aVal = parseInt(a.dataset.dpi || '0') || 0;
              bVal = parseInt(b.dataset.dpi || '0') || 0;
              break;
            case 'sens':
              aVal = parseFloat(a.dataset.sens || '0') || 0;
              bVal = parseFloat(b.dataset.sens || '0') || 0;
              break;
            case 'cm360':
              aVal = parseFloat(a.dataset.cm360 || '0') || 0;
              bVal = parseFloat(b.dataset.cm360 || '0') || 0;
              break;
            case 'fov':
              aVal = parseInt(a.dataset.fov || '0') || 0;
              bVal = parseInt(b.dataset.fov || '0') || 0;
              break;
            case 'updated':
              aVal = a.dataset.updated || '';
              bVal = b.dataset.updated || '';
              break;
            default:
              aVal = a.dataset.name || '';
              bVal = b.dataset.name || '';
          }

          if (typeof aVal === 'string') {
            return sortAsc ? aVal.localeCompare(bVal as string) : (bVal as string).localeCompare(aVal);
          }
          return sortAsc ? (aVal as number) - (bVal as number) : (bVal as number) - (aVal as number);
        });

        visibleRows.forEach(row => tbody?.appendChild(row));
      }

      // Event listeners
      searchInput?.addEventListener('input', filterAndSort);
      categoryFilter?.addEventListener('change', filterAndSort);

      headers.forEach(header => {
        header.addEventListener('click', () => {
          const col = (header as HTMLElement).dataset.sort || 'name';
          if (sortCol === col) {
            sortAsc = !sortAsc;
          } else {
            sortCol = col;
            sortAsc = true;
          }

          // Update header styles
          headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
          header.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');

          filterAndSort();
        });
      });
    });
  </script>
</BaseLayout>

<style>
  .table-container {
    overflow-x: auto;
    margin-top: 1.5rem;
    -webkit-overflow-scrolling: touch;
  }

  .player-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .player-table th,
  .player-table td {
    padding: 0.6rem 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #2a2a3a);
  }

  .player-table th {
    background: var(--bg-secondary, #12121a);
    font-weight: 600;
    color: var(--text-secondary, #888);
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.05em;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .player-table th.sortable {
    cursor: pointer;
    user-select: none;
  }

  .player-table th.sortable:hover {
    color: var(--accent-primary, #ff6b35);
  }

  .player-table th.sortable::after {
    content: ' ‚Üï';
    opacity: 0.3;
  }

  .player-table th.sort-asc::after {
    content: ' ‚Üë';
    opacity: 1;
  }

  .player-table th.sort-desc::after {
    content: ' ‚Üì';
    opacity: 1;
  }

  .header-info {
    font-size: 0.65rem;
    opacity: 0.6;
    cursor: help;
    margin-left: 0.25rem;
  }

  /* Zebra striping */
  .player-table tbody tr:nth-child(odd) {
    background: rgba(255, 255, 255, 0.02);
  }

  .player-table tbody tr:nth-child(even) {
    background: transparent;
  }

  .player-table tbody tr:hover {
    background: var(--bg-secondary, #12121a);
  }

  /* Highlight rows with special settings */
  .player-table tbody tr.has-accel {
    border-left: 3px solid #ffd700;
  }

  .player-table tbody tr.has-mcpi {
    border-left: 3px solid #9b59b6;
  }

  .player-table tbody tr.has-accel.has-mcpi {
    border-left: 3px solid;
    border-image: linear-gradient(180deg, #ffd700 50%, #9b59b6 50%) 1;
  }

  .player-link {
    color: var(--accent-primary, #ff6b35);
    text-decoration: none;
    font-weight: 500;
  }

  .player-link:hover {
    text-decoration: underline;
  }

  .num {
    font-family: monospace;
    text-align: right;
  }

  .center {
    text-align: center;
  }

  .flags-cell {
    text-align: center;
    white-space: nowrap;
  }

  .flag {
    display: inline-block;
    margin: 0 0.1rem;
    font-size: 0.9rem;
  }

  .accel-flag {
    color: #ffd700;
  }

  .mcpi-flag {
    color: #9b59b6;
  }

  .no-flags {
    color: var(--text-secondary, #666);
  }

  .cm360-cell {
    position: relative;
  }

  .mcpi-marker {
    color: #9b59b6;
    font-size: 0.7rem;
    vertical-align: super;
  }

  .hw-cell {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.8rem;
  }

  .date-cell {
    font-size: 0.75rem;
    color: var(--text-secondary, #888);
    white-space: nowrap;
  }

  .filters {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 1rem;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-group label {
    color: var(--text-secondary, #888);
    font-size: 0.875rem;
  }

  .filter-group select,
  .search-input {
    background: var(--bg-secondary, #12121a);
    border: 1px solid var(--border-color, #2a2a3a);
    color: var(--text-primary, #fff);
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
  }

  .search-input {
    min-width: 250px;
  }

  .legend {
    display: flex;
    gap: 1.5rem;
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    background: var(--bg-secondary, #12121a);
    border-radius: 6px;
    font-size: 0.8rem;
    color: var(--text-secondary, #888);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  @media (max-width: 1024px) {
    .player-table {
      font-size: 0.75rem;
    }

    .player-table th,
    .player-table td {
      padding: 0.4rem 0.5rem;
    }

    .hw-cell {
      max-width: 100px;
    }

    .search-input {
      min-width: 180px;
    }
  }

  @media (max-width: 640px) {
    .filters {
      flex-direction: column;
      align-items: stretch;
    }

    .search-input {
      min-width: 100%;
    }

    .legend {
      flex-direction: column;
      gap: 0.5rem;
    }
  }
</style>
