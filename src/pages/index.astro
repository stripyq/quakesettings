---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all players and hardware
const players = await getCollection('players');
const mice = await getCollection('mice');

// Create lookup maps for hardware
const miceMap = new Map(mice.map(m => [m.id, m.data]));

// Sort players by name
const sortedPlayers = players.sort((a, b) => a.data.name.localeCompare(b.data.name));

// Ensure base URL has trailing slash for path concatenation
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;
---

<BaseLayout title="Player Database">
  <div class="page-header">
    <h1>Quake Live Pro Settings</h1>
    <p>Mouse settings, hardware, and configs from {players.length} players</p>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label for="category-filter">Category:</label>
      <select id="category-filter">
        <option value="all">All Players</option>
        <option value="duel">Duel</option>
        <option value="ctf">CTF</option>
        <option value="tdm">TDM</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="sens-filter">Sensitivity Range:</label>
      <select id="sens-filter">
        <option value="all">All</option>
        <option value="low">Low (&lt; 800 eDPI)</option>
        <option value="medium">Medium (800-1500 eDPI)</option>
        <option value="high">High (&gt; 1500 eDPI)</option>
      </select>
    </div>

    <div class="filter-group">
      <input type="text" id="player-search" placeholder="Search players..." class="search-input">
    </div>
  </div>

  <div class="table-container">
    <table class="player-table" id="player-table">
      <thead>
        <tr>
          <th class="sortable" data-sort="name">Player</th>
          <th class="sortable" data-sort="mouse">Mouse</th>
          <th class="sortable" data-sort="dpi">DPI</th>
          <th class="sortable" data-sort="sens">Sens</th>
          <th class="sortable" data-sort="edpi">eDPI</th>
          <th class="sortable" data-sort="cm360">cm/360</th>
          <th class="sortable" data-sort="fov">FOV</th>
          <th>Accel</th>
          <th>Monitor</th>
        </tr>
      </thead>
      <tbody id="player-tbody">
        {sortedPlayers.map((player) => {
          const mouseData = miceMap.get(player.data.mouse);
          return (
            <tr
              class="player-row"
              data-name={player.data.name.toLowerCase()}
              data-category={player.data.category}
              data-edpi={player.data.edpi}
              data-dpi={player.data.dpi}
              data-sens={player.data.sensitivity}
              data-cm360={player.data.cm360 || 0}
              data-fov={player.data.fov}
              data-mouse={mouseData?.name?.toLowerCase() || ''}
            >
              <td>
                <a href={`${base}players/${player.id}/`} class="player-link">
                  {player.data.name}
                </a>
              </td>
              <td class="mouse-cell">{mouseData?.name || player.data.mouse || '—'}</td>
              <td class="num">{player.data.dpi}</td>
              <td class="num">{player.data.sensitivity}</td>
              <td class="num highlight">{player.data.edpi}</td>
              <td class="num">{player.data.cm360?.toFixed(1) || '—'}</td>
              <td class="num">{player.data.fov}</td>
              <td class="center">{player.data.acceleration ? '✓' : '—'}</td>
              <td class="monitor-cell">{player.data.monitor || '—'}</td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('player-search');
      const categoryFilter = document.getElementById('category-filter');
      const sensFilter = document.getElementById('sens-filter');
      const tbody = document.getElementById('player-tbody');
      const headers = document.querySelectorAll('th.sortable');

      let sortCol = 'name';
      let sortAsc = true;

      function filterAndSort() {
        const search = searchInput?.value.toLowerCase() || '';
        const category = categoryFilter?.value || 'all';
        const sens = sensFilter?.value || 'all';

        const rows = Array.from(tbody?.querySelectorAll('tr') || []);

        rows.forEach(row => {
          const name = row.dataset.name || '';
          const mouse = row.dataset.mouse || '';
          const cat = row.dataset.category || '';
          const edpi = parseInt(row.dataset.edpi) || 0;

          let show = true;

          // Search filter
          if (search && !name.includes(search) && !mouse.includes(search)) {
            show = false;
          }

          // Category filter
          if (category !== 'all' && cat !== category) {
            show = false;
          }

          // Sensitivity filter
          if (sens === 'low' && edpi >= 800) show = false;
          if (sens === 'medium' && (edpi < 800 || edpi > 1500)) show = false;
          if (sens === 'high' && edpi <= 1500) show = false;

          row.style.display = show ? '' : 'none';
        });

        // Sort visible rows
        const visibleRows = rows.filter(r => r.style.display !== 'none');
        visibleRows.sort((a, b) => {
          let aVal, bVal;
          switch(sortCol) {
            case 'name':
              aVal = a.dataset.name || '';
              bVal = b.dataset.name || '';
              break;
            case 'mouse':
              aVal = a.dataset.mouse || '';
              bVal = b.dataset.mouse || '';
              break;
            case 'dpi':
              aVal = parseInt(a.dataset.dpi) || 0;
              bVal = parseInt(b.dataset.dpi) || 0;
              break;
            case 'sens':
              aVal = parseFloat(a.dataset.sens) || 0;
              bVal = parseFloat(b.dataset.sens) || 0;
              break;
            case 'edpi':
              aVal = parseInt(a.dataset.edpi) || 0;
              bVal = parseInt(b.dataset.edpi) || 0;
              break;
            case 'cm360':
              aVal = parseFloat(a.dataset.cm360) || 0;
              bVal = parseFloat(b.dataset.cm360) || 0;
              break;
            case 'fov':
              aVal = parseInt(a.dataset.fov) || 0;
              bVal = parseInt(b.dataset.fov) || 0;
              break;
            default:
              aVal = a.dataset.name || '';
              bVal = b.dataset.name || '';
          }

          if (typeof aVal === 'string') {
            return sortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
          return sortAsc ? aVal - bVal : bVal - aVal;
        });

        visibleRows.forEach(row => tbody?.appendChild(row));
      }

      // Event listeners
      searchInput?.addEventListener('input', filterAndSort);
      categoryFilter?.addEventListener('change', filterAndSort);
      sensFilter?.addEventListener('change', filterAndSort);

      headers.forEach(header => {
        header.addEventListener('click', () => {
          const col = header.dataset.sort;
          if (sortCol === col) {
            sortAsc = !sortAsc;
          } else {
            sortCol = col;
            sortAsc = true;
          }

          // Update header styles
          headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
          header.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');

          filterAndSort();
        });
      });
    });
  </script>
</BaseLayout>

<style>
  .table-container {
    overflow-x: auto;
    margin-top: 1.5rem;
  }

  .player-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .player-table th,
  .player-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #2a2a3a);
  }

  .player-table th {
    background: var(--bg-secondary, #12121a);
    font-weight: 600;
    color: var(--text-secondary, #888);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
  }

  .player-table th.sortable {
    cursor: pointer;
    user-select: none;
  }

  .player-table th.sortable:hover {
    color: var(--accent-primary, #ff6b35);
  }

  .player-table th.sortable::after {
    content: ' ↕';
    opacity: 0.3;
  }

  .player-table th.sort-asc::after {
    content: ' ↑';
    opacity: 1;
  }

  .player-table th.sort-desc::after {
    content: ' ↓';
    opacity: 1;
  }

  .player-table tbody tr:hover {
    background: var(--bg-secondary, #12121a);
  }

  .player-link {
    color: var(--accent-primary, #ff6b35);
    text-decoration: none;
    font-weight: 500;
  }

  .player-link:hover {
    text-decoration: underline;
  }

  .num {
    font-family: monospace;
    text-align: right;
  }

  .highlight {
    color: var(--accent-primary, #ff6b35);
    font-weight: 600;
  }

  .center {
    text-align: center;
  }

  .mouse-cell,
  .monitor-cell {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .filters {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 1rem;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-group label {
    color: var(--text-secondary, #888);
    font-size: 0.875rem;
  }

  .filter-group select,
  .search-input {
    background: var(--bg-secondary, #12121a);
    border: 1px solid var(--border-color, #2a2a3a);
    color: var(--text-primary, #fff);
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
  }

  .search-input {
    min-width: 200px;
  }

  @media (max-width: 768px) {
    .player-table {
      font-size: 0.8rem;
    }

    .player-table th,
    .player-table td {
      padding: 0.5rem;
    }

    .mouse-cell,
    .monitor-cell {
      max-width: 120px;
    }
  }
</style>
