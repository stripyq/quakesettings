---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { groupMousepadsByModel, getSizeBadges, hasMultipleSizes } from '../../utils/mousepadGrouping';

// Get all hardware
const mice = await getCollection('mice');
const monitors = await getCollection('monitors');
const keyboards = await getCollection('keyboards');
const mousepads = await getCollection('mousepads');
const headsets = await getCollection('headsets');

// Get all players to count hardware usage (filter out unpublished)
const allPlayers = await getCollection('players');
const players = allPlayers.filter(p => p.data.published !== false);

// Get players who use each hardware
function getPlayersUsing(hardwareId: string, field: string) {
  return players.filter(p => p.data[field] === hardwareId);
}

// Create usage maps with player data
function createUsageMap(field: string) {
  const map = new Map<string, typeof players>();
  players.forEach(p => {
    const hwId = p.data[field];
    if (hwId) {
      if (!map.has(hwId)) {
        map.set(hwId, []);
      }
      map.get(hwId)!.push(p);
    }
  });
  return map;
}

const mouseUsageMap = createUsageMap('mouse');
const monitorUsageMap = createUsageMap('monitor');
const keyboardUsageMap = createUsageMap('keyboard');
const mousepadUsageMap = createUsageMap('mousepad');
const headsetUsageMap = createUsageMap('headset');

// Sort all hardware by popularity (usage count)
const miceWithUsage = mice.map(m => {
  const usedBy = mouseUsageMap.get(m.id) || [];
  return { ...m, usage: usedBy.length, players: usedBy };
}).sort((a, b) => b.usage - a.usage);

const monitorsWithUsage = monitors.map(m => {
  const usedBy = monitorUsageMap.get(m.id) || [];
  return { ...m, usage: usedBy.length, players: usedBy };
}).sort((a, b) => b.usage - a.usage);

const keyboardsWithUsage = keyboards.map(k => {
  const usedBy = keyboardUsageMap.get(k.id) || [];
  return { ...k, usage: usedBy.length, players: usedBy };
}).sort((a, b) => b.usage - a.usage);

const mousepadsWithUsage = mousepads.map(p => {
  const usedBy = mousepadUsageMap.get(p.id) || [];
  return { ...p, usage: usedBy.length, players: usedBy };
}).sort((a, b) => b.usage - a.usage);

// Group mousepads by model (for display)
const groupedMousepads = groupMousepadsByModel(mousepadsWithUsage);
const groupedMousepadsArray = [...groupedMousepads.values()].sort((a, b) => b.totalUsage - a.totalUsage);

const headsetsWithUsage = headsets.map(h => {
  const usedBy = headsetUsageMap.get(h.id) || [];
  return { ...h, usage: usedBy.length, players: usedBy };
}).sort((a, b) => b.usage - a.usage);

// Count items with players
const miceWithPlayers = miceWithUsage.filter(m => m.usage > 0).length;
const monitorsWithPlayers = monitorsWithUsage.filter(m => m.usage > 0).length;
const keyboardsWithPlayers = keyboardsWithUsage.filter(k => k.usage > 0).length;
const mousepadsWithPlayers = groupedMousepadsArray.filter(p => p.totalUsage > 0).length;
const headsetsWithPlayers = headsetsWithUsage.filter(h => h.usage > 0).length;

// Ensure base URL has trailing slash for path concatenation
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;
---

<BaseLayout title="Hardware Database">
  <div class="page-header">
    <h1>Hardware Database</h1>
    <p>A collection of gaming peripherals and gear used by Quake Live players</p>
  </div>

  <div class="hardware-tabs" role="tablist">
    <button class="tab-btn active" data-tab="mice" role="tab" aria-selected="true">
      Mice <span class="tab-count">({mice.length})</span>
    </button>
    <button class="tab-btn" data-tab="monitors" role="tab" aria-selected="false">
      Monitors <span class="tab-count">({monitors.length})</span>
    </button>
    <button class="tab-btn" data-tab="keyboards" role="tab" aria-selected="false">
      Keyboards <span class="tab-count">({keyboards.length})</span>
    </button>
    <button class="tab-btn" data-tab="mousepads" role="tab" aria-selected="false">
      Mousepads <span class="tab-count">({groupedMousepadsArray.length})</span>
    </button>
    <button class="tab-btn" data-tab="headsets" role="tab" aria-selected="false">
      Headsets <span class="tab-count">({headsets.length})</span>
    </button>
  </div>

  <div class="filters">
    <div class="filter-group">
      <input type="text" id="hardware-search" placeholder="Search by name, brand, or specs..." class="search-input">
    </div>
    <div class="filter-group">
      <label class="toggle-label">
        <input type="checkbox" id="player-used-toggle" checked>
        <span>Show only player-used gear</span>
      </label>
    </div>
  </div>

  <!-- MICE TABLE -->
  <section class="hardware-category active" id="mice" role="tabpanel">
    <div class="table-container">
      <table class="hardware-table" data-type="mice" data-player-count={miceWithPlayers}>
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Name</th>
            <th class="sortable" data-sort="brand">Brand</th>
            <th class="sortable" data-sort="weight">Weight</th>
            <th class="sortable" data-sort="shape">Shape</th>
            <th class="sortable" data-sort="sensor">Sensor</th>
            <th class="sortable" data-sort="connection">Connection</th>
            <th class="sortable num sort-desc" data-sort="usage">Players</th>
          </tr>
        </thead>
        <tbody>
          {miceWithUsage.map((mouse) => (
            <tr
              data-name={mouse.data.name.toLowerCase()}
              data-brand={mouse.data.brand.toLowerCase()}
              data-weight={mouse.data.weight}
              data-shape={mouse.data.shape?.toLowerCase() || ''}
              data-sensor={mouse.data.sensor?.toLowerCase() || ''}
              data-connection={mouse.data.connection?.toLowerCase() || ''}
              data-usage={mouse.usage}
            >
              <td class="name-cell">
                {mouse.data.name}
              </td>
              <td>{mouse.data.brand}</td>
              <td class="spec-cell">{mouse.data.weight}</td>
              <td class="spec-cell">{mouse.data.shape}</td>
              <td class="spec-cell">{mouse.data.sensor}</td>
              <td class="spec-cell">{mouse.data.connection}</td>
              <td class="num usage-cell">
                {mouse.usage > 0 ? (
                  <div class="usage-wrapper">
                    <span class="usage-count">{mouse.usage}</span>
                    <div class="player-dropdown">
                      {mouse.players.map(p => (
                        <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                      ))}
                    </div>
                  </div>
                ) : '—'}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <!-- MONITORS TABLE -->
  <section class="hardware-category" id="monitors" role="tabpanel">
    <div class="table-container">
      <table class="hardware-table" data-type="monitors" data-player-count={monitorsWithPlayers}>
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Name</th>
            <th class="sortable" data-sort="brand">Brand</th>
            <th class="sortable" data-sort="size">Size</th>
            <th class="sortable" data-sort="refresh">Refresh Rate</th>
            <th class="sortable" data-sort="panel">Panel</th>
            <th class="sortable" data-sort="resolution">Resolution</th>
            <th class="sortable num sort-desc" data-sort="usage">Players</th>
          </tr>
        </thead>
        <tbody>
          {monitorsWithUsage.map((monitor) => (
            <tr
              data-name={monitor.data.name.toLowerCase()}
              data-brand={monitor.data.brand.toLowerCase()}
              data-size={monitor.data.size}
              data-refresh={monitor.data.refreshRate}
              data-panel={(monitor.data.panelType || monitor.data.panel || '').toLowerCase()}
              data-resolution={monitor.data.resolution}
              data-usage={monitor.usage}
            >
              <td class="name-cell">
                {monitor.data.name}
              </td>
              <td>{monitor.data.brand}</td>
              <td class="spec-cell">{monitor.data.size}</td>
              <td class="spec-cell">{monitor.data.refreshRate}</td>
              <td class="spec-cell">{monitor.data.panelType || monitor.data.panel}</td>
              <td class="spec-cell">{monitor.data.resolution}</td>
              <td class="num usage-cell">
                {monitor.usage > 0 ? (
                  <div class="usage-wrapper">
                    <span class="usage-count">{monitor.usage}</span>
                    <div class="player-dropdown">
                      {monitor.players.map(p => (
                        <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                      ))}
                    </div>
                  </div>
                ) : '—'}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <!-- KEYBOARDS TABLE -->
  <section class="hardware-category" id="keyboards" role="tabpanel">
    <div class="table-container">
      <table class="hardware-table" data-type="keyboards" data-player-count={keyboardsWithPlayers}>
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Name</th>
            <th class="sortable" data-sort="brand">Brand</th>
            <th class="sortable" data-sort="size">Size</th>
            <th class="sortable" data-sort="switches">Switches</th>
            <th class="sortable" data-sort="connection">Connection</th>
            <th class="sortable num sort-desc" data-sort="usage">Players</th>
          </tr>
        </thead>
        <tbody>
          {keyboardsWithUsage.map((kb) => (
            <tr
              data-name={kb.data.name.toLowerCase()}
              data-brand={kb.data.brand.toLowerCase()}
              data-size={(kb.data.size || kb.data.format || '').toLowerCase()}
              data-switches={(kb.data.switches || '').toLowerCase()}
              data-connection={(kb.data.connection || '').toLowerCase()}
              data-usage={kb.usage}
            >
              <td class="name-cell">
                {kb.data.name}
              </td>
              <td>{kb.data.brand}</td>
              <td class="spec-cell">{kb.data.size || kb.data.format}</td>
              <td class="spec-cell">{kb.data.switches}</td>
              <td class="spec-cell">{kb.data.connection}</td>
              <td class="num usage-cell">
                {kb.usage > 0 ? (
                  <div class="usage-wrapper">
                    <span class="usage-count">{kb.usage}</span>
                    <div class="player-dropdown">
                      {kb.players.map(p => (
                        <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                      ))}
                    </div>
                  </div>
                ) : '—'}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <!-- MOUSEPADS TABLE (Grouped by Model) -->
  <section class="hardware-category" id="mousepads" role="tabpanel">
    <div class="table-container">
      <table class="hardware-table mousepad-table" data-type="mousepads" data-player-count={mousepadsWithPlayers}>
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Model</th>
            <th class="sortable" data-sort="brand">Brand</th>
            <th class="sortable" data-sort="surface">Surface</th>
            <th class="sortable" data-sort="speed">Speed</th>
            <th>Sizes</th>
            <th class="sortable num sort-desc" data-sort="usage">Players</th>
          </tr>
        </thead>
        <tbody>
          {groupedMousepadsArray.map((group) => (
            <>
              <tr
                class={`mousepad-row ${hasMultipleSizes(group) ? 'expandable' : ''}`}
                data-name={group.baseModel.toLowerCase()}
                data-brand={group.brand.toLowerCase()}
                data-surface={group.surface.toLowerCase()}
                data-speed={group.speed.toLowerCase()}
                data-usage={group.totalUsage}
              >
                <td class="name-cell">
                  {hasMultipleSizes(group) && <span class="expand-icon">▶</span>}
                  {group.baseModel}
                </td>
                <td>{group.brand}</td>
                <td class="spec-cell">{group.surface}</td>
                <td class="spec-cell">{group.speed}</td>
                <td class="spec-cell sizes-cell">
                  {getSizeBadges(group) ? (
                    <span class="size-badges">{getSizeBadges(group)}</span>
                  ) : (
                    <span class="size-single">{group.variants[0]?.dimensions || '—'}</span>
                  )}
                </td>
                <td class="num usage-cell">
                  {group.totalUsage > 0 ? (
                    <div class="usage-wrapper">
                      <span class="usage-count">{group.totalUsage}</span>
                      <div class="player-dropdown">
                        {group.allPlayers.map(p => (
                          <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                        ))}
                      </div>
                    </div>
                  ) : '—'}
                </td>
              </tr>
              {/* Base variant rows for Artisan-style pads */}
              {hasMultipleSizes(group) && group.hasBaseVariants && group.baseVariants?.map((bv) => (
                <tr class="variant-row" data-parent={group.baseModel.toLowerCase()} style="display: none;">
                  <td class="name-cell variant-name">
                    <span class="variant-indent"></span>
                    {bv.base} <span class="variant-thickness">({bv.thickness})</span>
                  </td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td class="spec-cell sizes-cell">
                    <span class="size-badges">{bv.sizes.join(' / ')}</span>
                  </td>
                  <td class="num usage-cell">
                    {bv.players.length > 0 ? (
                      <div class="usage-wrapper">
                        <span class="usage-count">{bv.players.length}</span>
                        <div class="player-dropdown">
                          {bv.players.map(p => (
                            <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                          ))}
                        </div>
                      </div>
                    ) : '—'}
                  </td>
                </tr>
              ))}
              {/* Size variant rows for size-grouped pads */}
              {hasMultipleSizes(group) && !group.hasBaseVariants && group.variants.map((variant) => (
                <tr class="variant-row" data-parent={group.baseModel.toLowerCase()} style="display: none;">
                  <td class="name-cell variant-name">
                    <span class="variant-indent"></span>
                    {variant.normalizedSize || variant.size}
                  </td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td class="spec-cell">{variant.dimensions}</td>
                  <td class="num usage-cell">
                    {variant.players.length > 0 ? (
                      <div class="usage-wrapper">
                        <span class="usage-count">{variant.players.length}</span>
                        <div class="player-dropdown">
                          {variant.players.map(p => (
                            <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                          ))}
                        </div>
                      </div>
                    ) : '—'}
                  </td>
                </tr>
              ))}
            </>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <!-- HEADSETS TABLE -->
  <section class="hardware-category" id="headsets" role="tabpanel">
    <div class="table-container">
      <table class="hardware-table" data-type="headsets" data-player-count={headsetsWithPlayers}>
        <thead>
          <tr>
            <th class="sortable" data-sort="name">Name</th>
            <th class="sortable" data-sort="brand">Brand</th>
            <th class="sortable" data-sort="type">Type</th>
            <th class="sortable" data-sort="driver">Driver</th>
            <th class="sortable" data-sort="connection">Connection</th>
            <th class="sortable" data-sort="microphone">Mic</th>
            <th class="sortable num sort-desc" data-sort="usage">Players</th>
          </tr>
        </thead>
        <tbody>
          {headsetsWithUsage.map((hs) => (
            <tr
              data-name={hs.data.name.toLowerCase()}
              data-brand={hs.data.brand.toLowerCase()}
              data-type={(hs.data.type || '').toLowerCase()}
              data-driver={(hs.data.driverSize || hs.data.driver || '')}
              data-connection={(hs.data.connection || '').toLowerCase()}
              data-microphone={hs.data.microphone ? 'yes' : 'no'}
              data-usage={hs.usage}
            >
              <td class="name-cell">
                {hs.data.name}
              </td>
              <td>{hs.data.brand}</td>
              <td class="spec-cell">{hs.data.type}</td>
              <td class="spec-cell">{hs.data.driverSize || hs.data.driver}</td>
              <td class="spec-cell">{hs.data.connection}</td>
              <td class="center">{hs.data.microphone ? '✓' : '—'}</td>
              <td class="num usage-cell">
                {hs.usage > 0 ? (
                  <div class="usage-wrapper">
                    <span class="usage-count">{hs.usage}</span>
                    <div class="player-dropdown">
                      {hs.players.map(p => (
                        <a href={`${base}players/${p.id}/`}>{p.data.name}</a>
                      ))}
                    </div>
                  </div>
                ) : '—'}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('hardware-search') as HTMLInputElement;
    const playerUsedToggle = document.getElementById('player-used-toggle') as HTMLInputElement;
    const tabButtons = document.querySelectorAll('.tab-btn');
    const categories = document.querySelectorAll('.hardware-category');
    const tables = document.querySelectorAll('.hardware-table');

    // Track sort state per table
    const sortState: Record<string, { col: string; asc: boolean }> = {};

    // Initialize sort state - default to usage descending
    tables.forEach(table => {
      const tableType = table.getAttribute('data-type') || '';
      sortState[tableType] = { col: 'usage', asc: false };
    });

    function switchTab(tabId: string, updateHash: boolean = true) {
      // Update tab buttons
      tabButtons.forEach(btn => {
        const isActive = btn.getAttribute('data-tab') === tabId;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive.toString());
      });

      // Update category visibility
      categories.forEach(cat => {
        cat.classList.toggle('active', cat.id === tabId);
      });

      // Update URL hash only if requested (not on initial load without hash)
      if (updateHash) {
        history.replaceState(null, '', `#${tabId}`);
      }

      // Re-apply filters
      filterCurrentTable();
    }

    function filterCurrentTable() {
      const activeCategory = document.querySelector('.hardware-category.active');
      if (!activeCategory) return;

      const table = activeCategory.querySelector('.hardware-table');
      if (!table) return;

      const search = searchInput?.value.toLowerCase() || '';
      const playerUsedOnly = playerUsedToggle?.checked ?? true;
      const isMousepadTable = table.classList.contains('mousepad-table');

      const tbody = table.querySelector('tbody');
      const rows = tbody?.querySelectorAll('tr') || [];
      let visibleCount = 0;
      let totalMainRows = 0;

      rows.forEach(row => {
        // Skip variant rows - they follow their parent
        if (row.classList.contains('variant-row')) {
          const parentName = row.getAttribute('data-parent');
          const parentRow = tbody?.querySelector(`.mousepad-row[data-name="${parentName}"]`) as HTMLElement;
          if (parentRow && parentRow.style.display === 'none') {
            (row as HTMLElement).style.display = 'none';
          }
          // Variant rows are not counted, and their visibility is managed by parent expand state
          return;
        }

        const name = row.getAttribute('data-name') || '';
        const brand = row.getAttribute('data-brand') || '';
        const sensor = row.getAttribute('data-sensor') || '';
        const shape = row.getAttribute('data-shape') || '';
        const connection = row.getAttribute('data-connection') || '';
        const surface = row.getAttribute('data-surface') || '';
        const speed = row.getAttribute('data-speed') || '';
        const usage = parseInt(row.getAttribute('data-usage') || '0');

        // Search filter - check all data attributes
        const matchesSearch = !search ||
          name.includes(search) ||
          brand.includes(search) ||
          sensor.includes(search) ||
          shape.includes(search) ||
          connection.includes(search) ||
          surface.includes(search) ||
          speed.includes(search);

        // Player-used filter
        const matchesPlayerFilter = !playerUsedOnly || usage > 0;

        const show = matchesSearch && matchesPlayerFilter;
        (row as HTMLElement).style.display = show ? '' : 'none';

        // Count only main rows
        totalMainRows++;
        if (show) visibleCount++;

        // If this is a mousepad row and it's hidden, also hide its variants
        if (isMousepadTable && !show) {
          const variantRows = tbody?.querySelectorAll(`.variant-row[data-parent="${name}"]`);
          variantRows?.forEach(vr => {
            (vr as HTMLElement).style.display = 'none';
          });
          // Also collapse it
          row.classList.remove('expanded');
          const icon = row.querySelector('.expand-icon');
          if (icon) icon.textContent = '▶';
        }
      });

      // Update visible count in tab
      const tableType = table.getAttribute('data-type');
      const tabBtn = document.querySelector(`.tab-btn[data-tab="${tableType}"]`);
      const countSpan = tabBtn?.querySelector('.tab-count');
      if (countSpan) {
        if (playerUsedOnly || search) {
          countSpan.textContent = `(${visibleCount}/${totalMainRows})`;
        } else {
          countSpan.textContent = `(${totalMainRows})`;
        }
      }
    }

    function sortTable(table: Element, col: string, asc: boolean) {
      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      const isMousepadTable = table.classList.contains('mousepad-table');

      // For mousepad table, only sort main rows and keep variants with their parents
      let rows: Element[];
      if (isMousepadTable) {
        rows = Array.from(tbody.querySelectorAll('tr.mousepad-row'));
      } else {
        rows = Array.from(tbody.querySelectorAll('tr'));
      }

      rows.sort((a, b) => {
        let aVal: string | number = a.getAttribute(`data-${col}`) || '';
        let bVal: string | number = b.getAttribute(`data-${col}`) || '';

        // Handle numeric columns
        if (col === 'usage') {
          aVal = parseInt(aVal as string) || 0;
          bVal = parseInt(bVal as string) || 0;
          return asc ? (aVal as number) - (bVal as number) : (bVal as number) - (aVal as number);
        }

        // Handle weight (extract numeric value)
        if (col === 'weight') {
          const aNum = parseFloat((aVal as string).replace(/[^\d.]/g, '')) || 0;
          const bNum = parseFloat((bVal as string).replace(/[^\d.]/g, '')) || 0;
          return asc ? aNum - bNum : bNum - aNum;
        }

        // String comparison
        return asc
          ? (aVal as string).localeCompare(bVal as string)
          : (bVal as string).localeCompare(aVal as string);
      });

      // Re-append rows in sorted order
      if (isMousepadTable) {
        // For mousepad table, append each main row followed by its variants
        rows.forEach(row => {
          tbody.appendChild(row);
          const parentName = row.getAttribute('data-name');
          const variantRows = tbody.querySelectorAll(`.variant-row[data-parent="${parentName}"]`);
          variantRows.forEach(vr => tbody.appendChild(vr));
        });
      } else {
        rows.forEach(row => tbody.appendChild(row));
      }
    }

    // Tab click handlers
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.getAttribute('data-tab');
        if (tabId) switchTab(tabId);
      });
    });

    // Search input handler
    searchInput?.addEventListener('input', filterCurrentTable);

    // Player-used toggle handler
    playerUsedToggle?.addEventListener('change', filterCurrentTable);

    // Sort handlers for each table
    tables.forEach(table => {
      const tableType = table.getAttribute('data-type') || '';

      const headers = table.querySelectorAll('th.sortable');
      headers.forEach(header => {
        header.addEventListener('click', () => {
          const col = header.getAttribute('data-sort') || '';
          const state = sortState[tableType];

          if (state.col === col) {
            state.asc = !state.asc;
          } else {
            state.col = col;
            state.asc = true;
          }

          // Update header styles
          headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
          header.classList.add(state.asc ? 'sort-asc' : 'sort-desc');

          sortTable(table, col, state.asc);
        });
      });
    });

    // Mousepad expand/collapse handlers
    const mousepadTable = document.querySelector('.mousepad-table');
    if (mousepadTable) {
      const expandableRows = mousepadTable.querySelectorAll('.mousepad-row.expandable');
      expandableRows.forEach(row => {
        row.addEventListener('click', (e) => {
          // Don't toggle if clicking on player dropdown
          if ((e.target as HTMLElement).closest('.usage-wrapper')) return;

          const isExpanded = row.classList.contains('expanded');
          const parentName = row.getAttribute('data-name');

          // Toggle expand state
          row.classList.toggle('expanded');

          // Toggle variant rows
          const variantRows = mousepadTable.querySelectorAll(`.variant-row[data-parent="${parentName}"]`);
          variantRows.forEach(vr => {
            (vr as HTMLElement).style.display = isExpanded ? 'none' : 'table-row';
          });

          // Update expand icon
          const icon = row.querySelector('.expand-icon');
          if (icon) {
            icon.textContent = isExpanded ? '▶' : '▼';
          }
        });
      });
    }

    // Handle initial hash or default to mice
    function handleHash(isInitialLoad: boolean = false) {
      const rawHash = window.location.hash.replace('#', '');
      const validTabs = ['mice', 'monitors', 'keyboards', 'mousepads', 'headsets'];
      const tabId = validTabs.includes(rawHash) ? rawHash : 'mice';

      // Only update hash if there was an existing hash, or if not initial load
      const shouldUpdateHash = !isInitialLoad || rawHash !== '';
      switchTab(tabId, shouldUpdateHash);
    }

    // Listen for hash changes
    window.addEventListener('hashchange', () => handleHash(false));

    // Initial load - don't add hash if none exists
    handleHash(true);
  });
</script>

<style>
  .hardware-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a3a);
    padding-bottom: 0;
  }

  .tab-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.75rem 1.25rem;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-secondary, #888);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: -1px;
  }

  .tab-btn:hover {
    color: var(--text-primary, #fff);
    background: rgba(255, 255, 255, 0.05);
  }

  .tab-btn.active {
    color: var(--accent-primary, #ff6b35);
    border-bottom-color: var(--accent-primary, #ff6b35);
  }

  .tab-count {
    font-size: 0.8em;
    opacity: 0.7;
  }

  .filters {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .search-input {
    background: var(--bg-secondary, #12121a);
    border: 1px solid var(--border-color, #2a2a3a);
    color: var(--text-primary, #fff);
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    min-width: 280px;
  }

  .toggle-label {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--text-secondary, #888);
    user-select: none;
  }

  .toggle-label:hover {
    color: var(--text-primary, #fff);
  }

  .toggle-label input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
    accent-color: var(--accent-primary, #ff6b35);
    cursor: pointer;
  }

  .hardware-category {
    display: none;
  }

  .hardware-category.active {
    display: block;
  }

  .table-container {
    overflow-x: auto;
  }

  .hardware-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .hardware-table th,
  .hardware-table td {
    padding: 0.6rem 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #2a2a3a);
  }

  .hardware-table th {
    background: var(--bg-secondary, #12121a);
    font-weight: 600;
    color: var(--text-secondary, #888);
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.05em;
    white-space: nowrap;
    position: sticky;
    top: 0;
  }

  .hardware-table th.sortable {
    cursor: pointer;
    user-select: none;
  }

  .hardware-table th.sortable:hover {
    color: var(--accent-primary, #ff6b35);
  }

  .hardware-table th.sortable::after {
    content: ' ↕';
    opacity: 0.3;
  }

  .hardware-table th.sort-asc::after {
    content: ' ↑';
    opacity: 1;
  }

  .hardware-table th.sort-desc::after {
    content: ' ↓';
    opacity: 1;
  }

  /* Zebra striping */
  .hardware-table tbody tr:nth-child(odd) {
    background: rgba(255, 255, 255, 0.02);
  }

  .hardware-table tbody tr:nth-child(even) {
    background: transparent;
  }

  .hardware-table tbody tr:hover {
    background: var(--bg-secondary, #12121a);
  }

  .name-cell {
    font-weight: 500;
    white-space: nowrap;
  }

  .spec-cell {
    color: var(--text-secondary, #ccc);
    font-size: 0.8rem;
  }

  .num {
    text-align: right;
    font-family: monospace;
  }

  .center {
    text-align: center;
  }

  .usage-cell {
    color: var(--accent-primary, #ff6b35);
    font-weight: 500;
    position: relative;
  }

  .usage-wrapper {
    position: relative;
    display: inline-block;
    cursor: pointer;
  }

  .usage-count {
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 2px;
  }

  .usage-wrapper:hover .usage-count {
    color: var(--accent-secondary, #4ecdc4);
  }

  .player-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    z-index: 100;
    background: var(--bg-card, #1a1a24);
    border: 1px solid var(--border-color, #2a2a3a);
    border-radius: 6px;
    padding: 0.5rem 0;
    min-width: 150px;
    max-width: 200px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .usage-wrapper:hover .player-dropdown {
    display: block;
  }

  .player-dropdown a {
    display: block;
    padding: 0.4rem 0.75rem;
    color: var(--text-primary, #fff);
    text-decoration: none;
    font-size: 0.8rem;
    font-family: inherit;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .player-dropdown a:hover {
    background: var(--bg-secondary, #12121a);
    color: var(--accent-primary, #ff6b35);
  }

  /* Mousepad grouping styles */
  .mousepad-row.expandable {
    cursor: pointer;
  }

  .mousepad-row.expandable:hover {
    background: rgba(255, 255, 255, 0.04);
  }

  .expand-icon {
    display: inline-block;
    width: 1em;
    margin-right: 0.25rem;
    font-size: 0.65em;
    color: var(--text-secondary, #888);
    transition: transform 0.15s;
  }

  .mousepad-row.expanded .expand-icon {
    color: var(--accent-primary, #ff6b35);
  }

  .variant-row {
    background: rgba(255, 255, 255, 0.02);
  }

  .variant-row td {
    padding-top: 0.35rem;
    padding-bottom: 0.35rem;
    font-size: 0.8rem;
  }

  .variant-name {
    color: var(--text-secondary, #aaa);
  }

  .variant-indent {
    display: inline-block;
    width: 1.5rem;
    margin-left: 0.5rem;
    border-left: 1px solid var(--border-color, #2a2a3a);
    height: 1em;
    vertical-align: middle;
    margin-right: 0.25rem;
  }

  .variant-thickness {
    color: var(--text-muted, #666);
    font-size: 0.85em;
  }

  .sizes-cell {
    white-space: nowrap;
  }

  .size-badges {
    display: inline-block;
    font-size: 0.75rem;
    color: var(--accent-secondary, #4ecdc4);
    background: rgba(78, 205, 196, 0.1);
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
  }

  .size-single {
    color: var(--text-secondary, #888);
  }

  @media (max-width: 1024px) {
    .hardware-table {
      font-size: 0.75rem;
    }

    .hardware-table th,
    .hardware-table td {
      padding: 0.4rem 0.5rem;
    }

    .search-input {
      min-width: 200px;
    }

    .filters {
      gap: 1rem;
    }
  }

  @media (max-width: 640px) {
    .tab-btn {
      font-size: 0.8rem;
      padding: 0.5rem 0.75rem;
    }

    .filters {
      flex-direction: column;
      align-items: stretch;
    }

    .search-input {
      min-width: 100%;
    }
  }
</style>
